<!DOCTYPE html>
<html lang="en">
<head>
<title>Shadow DOM</title>
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/base.css" type="text/css">
<link rel="stylesheet" href="../../assets/styles/spec.css" type="text/css">
</head>

<body class="draft">

<header>

<h1>Shadow DOM</h1>
<p>Draft Version</p>

</header>

<h2>Status</h2>

<p class="warning">This is a work in progress!</p>

<p>TODO: status summary</p>

<h2>Abstract</h2>

<p>This specification describes a method of establishing and maintaining boundaries between DOM subtrees and how these subtrees interact with each other within a document tree, thus enabling better encapsulation within DOM.</p>


<h2>Terminology</h2>

<dl>
    <dt>DOM</dt>
    <dt>DOM tree</dt>
    <dt>document</dt>
    <dt>element</dt>
</dl>

<h2>Dependencies</h2>

<ul>
    <li>DOM Core specification
    <li>HTML specification
</ul>

<h2>Introduction</h2>

<p>Web application developers often encounter the need to provide <dfn id="dfn-encapsulation">encapsulation</dfn> of a DOM structure. Despite being part of one document tree, there are typically many functional fragments of DOM (or <dfn id="dfn-dom-subtree">DOM subtrees</dfn>), as well as assumptions about these fragments operating independently.</p>

<p>For example, a Web application user interface is commonly composed with several user interface elements (or <dfn id="dfn-widget">widgets</dfn>), each being a DOM subtree. In cases where a widget is tasked with hosting other widgets, the need arises for the widget to understand where its DOM subtree ends and another widget's DOM subtree begins.</p>

<p><a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15065" class=fixme>Add illustration</a></p>

<p>This need for observing the functional <dfn id="dfn-boundary">boundaries</dfn> in a document tree is even larger when a widget is <dfn id="dfn-dom-operation">operated</dfn> on&mdash;added, moved, or removed in the document tree&mdash;by an outside actor, such as the Web application that consumes these widgets. Unless the widget consumer knows exactly how widget's DOM structure is designed, it is impossible for the consumer to reasonably operate on the widget. A typical workaround has been providing alternative means of operation by the widget developer, which, in striving for API consistency quickly extrapolates into a complete set of widget-specific, DOM-like APIs.</p>

<h2>Shadow DOM Subtrees</h2>

<p>This solve this problem at its core, a new abstraction is introduced. The <dfn id="dfn-shadow-dom">shadow DOM</dfn> allows multiple DOM subtrees (in addition to the document tree) to be composed into one larger tree when rendered. The existence of multiple DOM subtrees is enabled by letting any element in the document tree to host one or more additional DOM subtrees. These <dfn id="dfn-shadow-dom-subtree">shadow DOM subtrees</dfn> are governed by a set of rules that establish encapsulation boundaries while retaining the standard DOM composability semantics.</p>

<p>The encapsulation boundaries between shadow DOM subtrees are called <dfn id="dfn-shadow-boundary">shadow boundaries</dfn>.</p>

<p><a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15066" class=fixme>Add illustration</a></p>

<p>The elements that host shadow DOM subtrees are called <dfn id="dfn-shadow-host">shadow hosts</dfn>, and the root nodes of the shadow DOM subtrees are called <dfn id="api-shadow-root">shadow roots</dfn>.

<p>When rendered, the shadow DOM subtree is shown in place of the host element.</p>

<p><a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15067" class=fixme>Add illustration</a></p>

<p>To facilitate composition of host element's children and the shadow DOM subtree, a notion of insertion points is added to the abstraction. An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location in the shadow DOM subtree, to which the host element's children are transposed when rendering.</p>

<p><a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15068" class=fixme>Add illustration</a></p>

<p>Thus, the encapsulation of a shadow DOM subtree can be viewed as two-fold problem:
<ol>
    <li>the <dfn id="dfn-upper-boundary-encapsulation">upper-boundary encapsulation</dfn>, or governing the boundary between the shadow root and the shadow host; and
    <li>the <dfn id="dfn-lower-boundary-encapsulation">lower-boundary encapsulation</dfn>, or governing the boundary between the insertion points and the shadow host's children.
</ol>

<h3>Upper-boundary Encapsulation</h3>

<p id="dom-scoping">To maintain the upper-boundary encapsulation, the nodes in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> must be share the following characteristics:</p>
<ul>
    <li>The <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/dom-core.html#dom-node-ownerdocument"><code>ownerDocument</code></a> property refers to the document of the <a href="#dfn-shadow-host">shadow host</a>;</li>
    <li>The nodes <strong>are not</strong> accessible using <a href="#dfn-shadow-host">shadow host</a>'s document <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessors</a>;</li>
    <li>The nodes <strong>are</strong> accessible using <a href="#dfn-shadow-root">shadow root</a>'s DOM tree accessor methods.
</ul>
<p>For convenience, the <a href="dfn-shadow-root">shadow root</a> provides its own set of DOM tree accessor methods. No nodes other than <a href="dfn-shadow-root">shadow root</a> descendants are accessible with these methods.</p>

<p>The <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/dom-core.html#dom-node-parentnode"><code>parentNode</code></a> and <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/dom-core.html#dom-node-parentelement"><code>parentElement</code></a> attributes of the <a href="dfn-shadow-root">shadow root</a> object must always return <code>null</code>.</p>

<h3>Lower-boundary Encapsulation</h3>

<p>To maintain the lower-boundary encapsulation, the distribution of child nodes of the <a href="#dfn-shadow-host">shadow host</a> among the <a href="#dfn-insertion-point">insertion points</a> in the associated <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> must have the following traits:</p>
<ul>
    <li>The distribution only affects the rendering. The state of the document DOM tree or shadow DOM subtrees is not affected.</li>
    <li>Each insertion point participates in distribution by providing a matching criteria for the child nodes. The <dfn id="dfn-matching-criteria">matching criteria</dfn> determines whether a given node could be distributed to a given insertion point.</li>
    <li>The distribution is a result of executing a stable algorithm.</li>
</ul>

The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> must produce an outcome that is <strong>exactly equal</strong> to the outcome of processing these steps:</p>

<ol>
    <li>For each child node of the shadow host:
    <ol>
        <li>For each <a href="#dfn-insertion-point">insertion point</a> in shadow host's <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a>:
            <ol>
                <li>If the child node:
                    the child is distributed to the <a href="#dfn-insertion-point">insertion point</a>, represented by the <code>content</code> element.</li>
                <li>Otherwise, the child remains available for distribution.</li>
            </ol></li>
    </ol></li>
</ol>

<p>When the <a href="dfn-insertion-point">insertion point</a> has no content that is inserted in its place, the fallback content must be used instead. The <dfn id="dfn-fallback-content">fallback content</dfn> is all descendants of the DOM element that represents the insertion point.</p>

<h2>Events</h2>

In <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>, the <a href="http://www.w3.org/TR/domcore/#events">DOM Events</a> are allowed to cross the <a href="#dfn-shadow-boundary">shadow boundaries</a> under some conditions.</p>

<p>When an event is fired in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, it either <em>escapes</em> out of the shadow tree during the capture, target, bubble, or default phases or it <em>is stopped</em> at the <a href="shadow-boundary">shadow boundary</a>.</p>

<p>In the cases where event escapes the shadow tree, the event's information about the target of the event is adjust in order to maintain <a href="#dfn-upper-boundary-encapsulation">upper-boundary-encapsulation</a>.

<h3>Event Retargeting</h3>

<p>Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing a <em>relative target</em> for each ancestor of the node at which the event is dispatched.</p>

<p>To help with algorithm description, let's define the direction walking the ancestors of a node as <dfn id="dfn-travsere-up">up</dfn> when traversing from child to parent, and <dfn id="dfn-travsere-down">down</dfn> when traversing from parent to child. In the context of events-related algorithms, all ancestor traversal crosses <a href="#dfn-shadow-boundary">shadow boundaries</a>.</p>

<p>The following <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> must be used to determine relative targets:</p>

<ol>
    <li>Set the relative target of the node at which event is fired to the node itself.</li>
    <li>For each ancestor walking <a href="#dfn-travsere-up">up</a> starting with the node's parent, compute its <dfn id="dfn-relative-target">relative target</dfn>:</li>
        <ol>
            <li>If the node is a <a href="#dfn-shadow-boundary">shadow boundary</a>, Skip it.</li>
            <li>If the previous node was a <a href="#dfn-shadow-boundary">shadow boundary</a>, make the node its own <a href="#dfn-relative-target">relative target</a>.</li>
            <li>Otherwise: use the previous node's <a href="#dfn-relative-target">relative target</a>.</li>
        </ol>
    </li>
</ol>

<p>The retargeting process must occur prior to dispatch of an event.</p>

<p>At the time of event dispatch, for <a href="http://www.w3.org/TR/domcore/#dom-event-capturing_phase">CAPTURING_PHASE</a>, <a href="http://www.w3.org/TR/domcore/#dom-event-at_target">AT_TARGET</a>, and <a href="http://www.w3.org/TR/domcore/#dom-event-bubbling_phase">BUBBLING_PHASE</a>, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> must attributes be set to the <a href="#dfn-relative-target">relative target</a> that was computed for the node along the capturing and bubbling flow.</p>

<p>The event must not be retargeted during the default phase of event dispatch.</p>

<p>Upon completion of the event dispatch, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> are set to the highest ancestor's <a href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the nodes in <a href="#dfn-shadow-dom-subtree">shadow DOM subtrees</a>.</p>

<h3>Retargeting <code>relatedTarget</code></h3>

<p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property, which holds a node that's not the event's target, but is related to the event.</p>

<p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the node from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs must not leak its actual value outside of this subtree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the conforming UAs must <em>stop</em> events at the <a href="#dfn-shadow-boundary">shadow boundary</a> to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

<p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch must to be adjusted. In general:</p>
<ol>
    <li>If <code>relatedTarget</code> and <code>target</code> are enclosed by a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>, the event dispatch must be stopped at the <a href="#dfn-shadow-boundary">shadow boundary</a> of this subtree.</li>
    <li>If <code>relatedTarget</code> is separated from <code>target</code> by one or more <a href="#dfn-shadow-boundary">shadow boundaries</a>, it must be retargeted to the boundary that's closest to <code>target</code>.</li>
</ol>

<object data="../../assets/images/related-target-and-shadow-dom.svg" width=400 height=400></object>

<p id="related-target-algorithm">The following algorithm must be used:</p>
<ol>
    <li>Find the <dfn>lowest common ancestor</dfn> of <code>target</code> and <code>relatedTarget</code>.</li>
    <li>If there is none, skip to step 7 in the algorithm.</li>
    <li>If the <a href="#dfn-lowest-common-ancestor">lowest common ancestor</a> is <code>relatedTarget</code>, and it's a <a href="#dfn-shadow-host">shadow  host</a>, make this tree's boundary the <dfn>lowest common boundary</dfn>, and go to step 6 in the algorithm.</li>
    <li>Looking at the ancestors of the <a href="#dfn-lowest-common-ancestor">lowest common ancestor</a>, starting at its parent and walking <a href="#dfn-traversal-up">up</a>, find a <a href="#dfn-shadow-boundary">shadow boundary</a>. This is the <dfn id="dfn-lowest-common-boundary">lowest common boundary</dfn>, the boundary of a <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a> that encloses both <code>target</code> and <code>relatedTarget</code>.
    <li>If the <a href="#dfn-lowest-common-boundary">lowest common boundary</a> is not found, skip to step 7 in the algorithm.</li>
    <li>Limit event dispatch to the descendants of the <a href="#dfn-lowest-common-boundary">lowest common boundary</a>.</li>
    <li>If the <a href="#dfn-lowest-common-boundary">lowest common boundary</a> is still undetermined at this point, set it to be the farthest ancestor of the <code>relatedTarget</code>.</li>
    <li>Starting from <a href="#dfn-lowest-common-boundary">lowest common boundary</a> and walking <a href="#dfn-traversal-down">down</a> ancestors of the <code>relatedTarget</code>, find a <a href="#dfn-shadow-boundary">shadow boundary</a>. This is the <dfn id="dfn-first-divergent-boundary">first divergent boundary</dfn>.</li>
    <li>If <a href="#dfn-first-divergent-boundary">first divergent boundary</a> is not found, stop.</li>
    <li>Set <code>relatedTarget</code> to the parent of the <a href="#dfn-first-divergent-boundary">first divergent boundary</a>.
</ol>

<h3>Retargeting Focus Events</h3>

<p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events must be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding node that is losing focus as a result of <code>target</code> gaining focus or the node that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>

<h3>Events That Are Always Stopped</h3>

<p>Mutation events and <code>selectstart</code> event are always stopped at the nearest <a href="#dfn-shadow-boundary">shadow boundary</a>.</p>

<h3>Event Retargeting Example</h3>

<p>Suppose we have a user interface for a media controller, represented by this DOM tree, composed of both document and the <a href="#dfn-shaow-dom-subtree">shadow DOM subtrees</a>:</p>
<pre class="example html"><code>
&lt;div id=&quot;player&quot;&gt;
    <span class=shadow-boundary>&lt;shadow-boundary&gt;</span>
        &lt;div pseudo=&quot;controls&quot;&gt;
            &lt;button pseudo=&quot;play-button&quot;&gt;
            &lt;input type=&quot;range&quot; pseudo=&quot;timeline&quot;&gt;
                <span class=shadow-boundary>&lt;shadow-boundary&gt;</span>
                    &lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt;
                <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            &lt;div pseudo=&quot;volume-slider-container&quot;&gt;
                &lt;input type=&quot;range&quot; pseudo=&quot;volume-slider&quot;&gt;
                    <span class=shadow-boundary>&lt;shadow-boundary&gt;</span>
                        &lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt;
                    <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<p>Let's have a user position their pointing device over the volume slider's thumb (<code>#player::volume-slider::slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

<p>Just before the event is dispatched, we perform <a href="#dfn-retargeting">retargeting</a>:</p>
<ol>
    <li>We set the <a href="#dfn-relative-target">relative target</a> of the thumb node to itself.</li>
    <li>Walking <a href="#dfn-travseral-up">up</a>, we find a <a href="#dfn-shadow-boundary">shadow boundary</a> and skip it.</li>
    <li>Next up is an input (<code>#player::volume-slider</code>), and we set its relative target to itself, since the previous ancestor was a shadow boundary.</li>
    <li>We then walk up to the containing div (<code>#player::volume-slider-container</code>), and use previous ancestor's target -- the input element.</li>
    <li>Walking up one more, we reach the controls panel (<code>#player::controls</code>), and again use input element as relative target per <a href="#dfn-retargeting-algorithm">retargeting algorithm</a>.</li>
    <li>Next, we reach another <a href="#dfn-shadow-boundary">shadow boundary</a> and skip it.</li>
    <li>Finally we walk up to the player element (<code>#player</code>) and set its relative target to itself.</li>
</ol>

<pre class="example html"><code>
<span class=event-ancestor>&lt;div id=&quot;player&quot;&gt; <em>7</em></span>
    <span class="shadow-boundary event-ancestor">&lt;shadow-boundary&gt; <em>6</em></span>
        <span class=event-ancestor>&lt;div pseudo=&quot;controls&quot;&gt; <em>5</em></span>
            &lt;button pseudo=&quot;play-button&quot;&gt;
            &lt;input type=&quot;range&quot; pseudo=&quot;timeline&quot;&gt;
                <span class=shadow-boundary>&lt;shadow-boundary&gt;</span>
                    &lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt;
                <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            <span class=event-ancestor>&lt;div pseudo=&quot;volume-slider-container&quot;&gt; <em>4</em></span>
                <span class=event-ancestor>&lt;input type=&quot;range&quot; pseudo=&quot;volume-slider&quot;&gt; <em>3</em></span>
                    <span class="shadow-boundary event-ancestor">&lt;shadow-boundary&gt; <em>2</em></span>
                        <span class=event-ancestor>&lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt; <em>1</em></span>
                    <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<p>
At the end of this process, we should have the following set of ancestors and relative targets:
</p>
<table>
<thead>
<tr>
    <th>Ancestor</th>
    <th>Relative Target</th>
</tr>
</thead>
<tbody>
<tr>
    <td><code>...</code></td>
    <td><code>div#player</code></td>
</tr>
<tr>
    <td><code>div#player</code></td>
    <td><code><strong>div#player</strong></code></td>
</tr>
<tr>
    <td><code>div#player::controls</code></td>
    <td><code>div#player::controls::volume-slider</code></td>
</tr>
<tr>
    <td><code>div#player::volume-slider-container</code></td>
    <td><code>div#player::controls::volume-slider</code></td>
</tr>
<tr>
    <td><code>div#player::controls::volume-slider</code></td>
    <td><code><strong>div#player::controls::volume-slider</strong></code></td>
</tr>
<tr>
    <td><code>div#player::controls::volume-slider::slider-thumb</code></td>
    <td><code><strong>div#player::controls::volume-slider::slider-thumb</strong></code></td>
</tr>
</tbody>
</table>

<p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
(<code>#player::timeline::slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

<p>Let's study how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected and whether event escapes out of the player. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#player::timeline::slider-thumb</code>).</p>

<ol>
    <li>We find lowest common ancestor of timeline thumb and volume slider thumb: the controls panel (<code>#player::controls</code>).</li>
    <li>Walking <a href="#dfn-traversal-up">up</a>, we look for a <a href="#dfn-shadow-boundary">shadow boundary</a>, and find one just above. This is the lowest common boundary.</li>
    <li>Given that the lowest common boundary exists, we limit event dispatch to the descendants of this boundary.</li>
    <li>Starting from the lowest common boundary, we walk <a href="#dfn-traversal-down">down</a> the ancestors of the timeline thumb, looking for a <a href="shadow-boundary">shadow boundary</a>. We find it just below the timeline (<code>#player::timeline</code>). This is the <a href="#dfn-first-divergent-boundary">first divergent boundary</a>.</li>
    <li>We adjust <code>relatedTarget</code> to be the parent of the first divergent boundary, the timeline (<code>#player::timeline</code>). We are now ready to dispatch this event.</li>
</ol>

<pre class="example html"><code>
&lt;div id=&quot;player&quot;&gt;
    <span class="shadow-boundary lowest-common-boundary">&lt;shadow-boundary&gt;<em> &mdash; lowest common boundary</em></span>
        &lt;div pseudo=&quot;controls&quot;&gt;
            &lt;button pseudo=&quot;play-button&quot;&gt;
            &lt;input type=&quot;range&quot; pseudo=&quot;timeline&quot;&gt;
                <span class="shadow-boundary first-divergent-boundary">&lt;shadow-boundary&gt;<em>  &mdash; first divergent boundary</em></span>
                    &lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt;
                <span class="shadow-boundary first-divergent-boundary">&lt;/shadow-boundary&gt;</span>
            &lt;/input&gt;
            &lt;div pseudo=&quot;volume-slider-container&quot;&gt;
                &lt;input type=&quot;range&quot; pseudo=&quot;volume-slider&quot;&gt;
                    <span class=shadow-boundary>&lt;shadow-boundary&gt;</span>
                        &lt;div pseudo=&quot;slider-thumb&quot;&gt;&lt;/div&gt;
                    <span class=shadow-boundary>&lt;/shadow-boundary&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class="shadow-boundary lowest-common-boundary">&lt;/shadow-boundary&gt;</span>
&lt;/div&gt;
</code></pre>

<h2>Elements and DOM Objects</h2>

<h3><code>ShadowRoot</code> Object</h3>

<p>The <dfn id="api-shadow-root-object"><code>ShadowRoot</code></dfn> object represents the <a href="#api-shadow-root">shadow root</a>.</p>

<object data="../../assets/images/shadowdom.svg" width=500 height=200></object>

<p>To maintain <a href="#dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, all descendants of the <code>ShadowRoot</code> are <a href="#dom-scoping">scoped</a> within it.</p>
    
<pre><code>[Constructor(in HTMLElement element) raises (DOMException)]
interface <dfn id="api-shadow-root">ShadowRoot</a> : <a href="http://www.w3.org/TR/domcore/#node">Node</a> {
    <a href="http://www.w3.org/TR/domcore/#element">Element</a> <a href="#api-shadow-root-get-element-by-id">getElementById</a>(in DOMString elementId);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-class-name">getElementsByClassName</a>(in DOMString tagName);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name">getElementsByTagName</a>(in DOMString className);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name-ns">getElementsByTagNameNS</a>(DOMString namespace, DOMString localName);
    attribute bool <a href="#api-shadow-root-apply-author-sheets">applyAuthorSheets</a>;
    readonly attribute Element <a href="#api-shadow-root-host">host</a>;
}
ShadowRoot implements <a href="http://dev.w3.org/2006/webapi/selectors-api/#nodeselector">NodeSelector</a>;
</code></pre>

<h4><code>ShadowRoot</code> Attributes</h4>

<dl>
<dt id="api-shadow-root-apply-author-sheets"><code>applyAuthorSheets</code> of type <code>bool</code></dt>
<dd>indicates whether or not the rules in <a href="http://www.w3.org/TR/CSS2/cascade.html">author style sheets</a> associated with the element's document apply to the shadow DOM subtree. If <code>false</code> (default value), the author style sheets are applied to the shadow DOM subtree. If <code>true</code>, they do not.</dd>
<dt id="api-shadow-root-host"><code>host</code> of type <code>Element</code>, readonly</dt>
<dd>refers back to the shadow host. This value is never <code>null</code>.</dd>
</dl>

<h4><code>ShadowRoot</code> Methods</h4>

<dl>
<dt><code>constructor</code></dt>
<dd>
    Creates new shadow root and associates it with the shadow host.
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Type</th>
                <th>Nullable</th>
                <th>Optional</th>
                <th>Description</th>
            </tr>
        </thead>
            <tr>
                <td><dfn id="api-shadow-root-constructor-element"><code>element</code></dfn></td>
                <td><a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a></td>
                <td>No</td>
                <td>No</td>
                <td>Element that will be hosting this instance of the shadow DOM subtree.</td>
            </tr>
        <tbody>
        </tbody>
    </table>
    <div>
        <em>Exceptions:</em>
        <dl>
            <dt><a href="http://www.w3.org/TR/domcore/#dom-domexception-hierarchy_request_err"><code>HIERARCHY_REQUEST_ERR</code></a></dt>
            <dd>Thrown when the <code>element</code> parameter is not a valid <a href="http://www.w3.org/TR/domcore/#element"><code>Element</code></a>.
        </dl>
    </div>
    <div>
        <em>Returns: a new <code>ShadowRoot</code> instance.</em>
    </div>
</dd>
<dt id="api-shadow-root-get-element-by-id"><code>getElementById</code></dt>
<dd>Behaves exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementbyid">document.getElementById</a>, except <a href="#dom-scoping">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-class-name"><code>getElementsByClassName</code></dt>
<dd>Behaves exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbyclassname">document.getElementsByClassName</a>, except <a href="#dom-scoping">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name"><code>getElementsByTagName</code></dt>
<dd>Behaves exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagname">document.getElementsByTagName</a>, except <a href="#dom-scoping">scoped</a> to the shadow DOM subtree.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name-ns"><code>getElementsByTagNameNS</code></dt>
<dd>Behaves exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagnamens">document.getElementsByTagNameNS</a>, except <a href="#dom-scoping">scoped</a> to the shadow DOM subtree.</dd>
</dl>


<h3>The <code>content</code> element</h3>

<p>The <dfn id="dfn-content-element"><code>content</code></dfn> element represents an <a href="#dfn-insertion-point">insertion point</a> in the <a href="#dfn-shadow-dom-subtree">shadow DOM subtree</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#metadata-content">Metadata content</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
    <dl>
    <dt id="markup-content-apply-shadow-styles"><code>apply-shadow-styles</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean attribute</a></dt>
    <dd>indicates whether or not the rules in the scoped styles, defined in shadow DOM subtree are applied to the host element's children that are inserted in place of this <code>content</code> element. If present, the styles are applied.</dd>
    <dt id="markup-content-select"><code>select</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#set-of-space-separated-tokens">set of space-separated tokens</a></dt>
    <dd>
        defines the <a href="#dfn-matching-criteria">matching criteria</a> for distributing child nodes of the <a href="#dfn-host-element">host element</a>. Each token must be a valid <a href="#dfn-selector-fragment">selector fragment</a>. If any token is invalid, the entire value of the <code>select</code> attribute is considered invalid.
    </dd>
    </dl>
</dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>interface <dfn id="api-html-content-element">HTMLContentElement</a> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
    attribute bool <a href="#api-html-content-element-apply-shadow-styles">applyShadowStyles</a>;
    attribute <a href="http://dvcs.w3.org/hg/domcore/raw-file/2d8624c7ec02/dom-core.html#interface-domtokenlist">DOMTokenList</a> <a href="#api-html-content-element-select">select</a>;
}
    </code></pre>
    <dl>
    <dt>Attributes</dt>
    <dl>
        <dt id="api-html-content-element-apply-shadow-styles"><code>applyShadowStyles</code> of type <code>bool</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-apply-shadow-styles">apply-shadow-styles</a> attribute.</dd>
        <dt id="api-html-content-element-select"><code>select</code> of type <code>DOMTokenList</code></dt>
        <dd>
            <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-select">select</a> attribute.</dd>
        </dd>
    </dd>
    </dl>
    </dl>
</dl>


<h3>The <code>shadow</code> element</h3>

<p>The <dfn id="dfn-shadow-element"><code>shadow</code></dfn> element represents an <a href="#dfn-insertion-point">insertion point</a> for an <a href="dfn-older-tree">older tree</a> of the <a href="#dfn-shadow-host">shadow host</a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#metadata-content">Metadata content</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>interface <dfn id="api-html-shadow-element">HTMLShadowElement</a> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
}
    </code></pre>
    </dl>
</dl>


<h2>Multiple Shadow DOM Subtrees</h2>

<p><a class="fixme" href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15105">Define <dfn id="dfn-older-tree">older tree</dfn> and younger tree</a></p>

<h3 id="selector-fragment">Selector Fragment</h3>

<p>A <dfn id="dfn-selector-fragment">selector fragment</dfn> is indeed a fragment in the <a href="http://www.w3.org/TR/css3-selectors">selector</a> <code>(shadow-host)>(fragment)</code>, where <code>(shadow-host)</code> is a selector that uniquely identifies the <a href="#dfn-shadow-host">shadow host</a>, and <code>(fragment)</code> is the <a href="#dfn-selector-fragment">selector fragment</a>.</p>

<p>A valid selector fragment fragment may contain:</p>

<ul>
    <li>A <a href="http://www.w3.org/TR/css3-selectors/#type-selectors">type selector</a> or a <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#class-html">class selector(s)</a></li>
    <li>An <a href="http://www.w3.org/TR/css3-selectors/#id-selectors">ID selector</a></li>
    <li><a href="http://www.w3.org/TR/css3-selectors/#attribute-selectors">attribute selector(s)</a></li>
    <li>the following <a href="http://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class selector(s)</a>:
        <ul>
            <li><code>:link</code></li>
            <li><code>:visited</code></li>
            <li><code>:target</code></li>
            <li><code>:enabled</code></li>
            <li><code>:disabled</code></li>
            <li><code>:checked</code></li>
            <li><code>:indeterminate</code></li>
            <li><code>:nth-child()</code></li>
            <li><code>:nth-last-child()</code></li>
            <li><code>:nth-of-type()</code></li>
            <li><code>:nth-of-last-type()</code></li>
            <li><code>:first-child</code></li>
            <li><code>:last-child</code></li>
            <li><code>:first-of-type</code></li>
            <li><code>:last-of-type</code></li>
            <li><code>:only-of-type</code></li>
        </ul>
    </li>
</ul>

<p>If any other types of selectors are present the <a href="dfn-selector-fragment">selector fragment</a>, the fragment must be considered invalid.</p>

<p>A conforming UAs must consider a node as <dfn id="dfn-content-matching">matching</dfn> a selector fragment in the context of a given <a href="#dfn-shadow-host">shadow host</a>, if it both:
<ol>
    <li>is a child node of the shadow host; and</li>
    <li>matches the specified selector fragment.</li>
</ol>

<ul>
    <li><a href="#dfn-content-matching">matches</a> any of the <a href="#dfn-selector-fragment">selector fragments</a> specified by the <a href="#markup-content-select"><code>select</code></a> attribute of the <code>content</code> element and the <code>select</code> attribute value is valid; or</li>
    <li>the select attribute element is empty or not present,</li>
</ul>


<p>THE END</p>
<h1>Stuff that hasn't been integrated yet</h1>


<p>
A <code>content</code> element without a <code><a href="#content.select">select</a></code> attribute selects all children
that are not selected by any other <code><a href="#content">content</a></code> element.
A given shadow tree MUST contain only at most a single <code><a href="#content">content</a></code> element without a <code>select</code> attribute.
In case there are more than one such <code><a href="#content">content</a></code> elements, only the first such content element selects any children.
</p>

<p>
A <code><a href="#content">content</a></code> element may have content of its own,
which is rendered in the case the <code><a href="#content">content</a></code> element doesn't select any children of the host element.
</p>


<!--
<p>
The shadow DOM extends the <a href="http://www.w3.org/TR/domcore/#element" title="DOM Core Element object">Element</a> as follows:
</p>

<pre><code>
[Supplemental]
interface Element {
    attribute String <a href="#pseudo-attribute">pseudo</a>;
}
</code></pre>

<p>
The <dfn id="pseudo-attribute" title="pseudo-attribute">pseudo</dfn> attribute allows setting a <a href="http://www.w3.org/TR/CSS2/selector.html#pseudo-element-selectors">CSS pseudo-element value</a> on an element and roughly corresponds to functionality of the <a href="http://dev.w3.org/2006/xbl2/#the-pseudo-attribute">XBL2 pseudo attribute</a>.

-->
<!-- TODO(dominicc): should reproduce the IDENT grammar here; the list
     of identifiers are from the CSS3 draft but the links are to CSS2,
     that has to be rationalized. -- >
<!--
The value must either be <code>null</code> or a string that matches the <code>IDENT</code> production of the <a href="http://www.w3.org/TR/CSS2/grammar.html">CSS grammar</a>,
with the exception that the names defined by CSS for <a href="http://www.w3.org/TR/CSS2/selector.html#pseudo-class-selectors">pseudo class selectors</a> and
<a href="http://www.w3.org/TR/CSS2/selector.html#pseudo-element-selectors">pseudo element selectors</a> are not valid.
For example: <code>active</code>, <code>after</code>, <code>before</code>, <code>checked</code>, <code>disabled</code>, <code>empty</code>, <code>enabled</code>, <code>first-child</code>, <code>first-letter</code>,
<code>first-line</code>, <code>first-of-type</code>, <code>focus</code>, <code>hover</code>, <code>indeterminate</code>, <code>lang</code>, <code>last-child</code>, <code>last-of-type</code>, <code>link</code>,
<code>not</code>, <code>nth-child</code>, <code>nth-last-child</code>, <code>nth-last-of-type</code>, <code>nth-of-type</code>, <code>only-child</code>, <code>only-of-type</code>, <code>root</code>, <code>target</code>, <code>visited</code>.
</p>
-->

<h2>Events</h2>

<p class="issue">boundless ancestor</span> -- need better term.</li>


<h2>CSS</h2>

<h3>Inheritance Across Boundaries</h3>

<h4>Host-to-Shadow</h4>

<p>Nodes in the shadow tree inherit styles from the host element as if they were direct children.

<h4>Shadow-to-Host-Children</h4>

<p>
Children of the host element that are rendered through a <code>content</code> element
inherit their style as if they were direct children of the <code>content</code> element.
</p>

<h3>Selectors</h3>

<p>CSS Selectors <strong>never</strong> cross the boundary from host to the shadow tree, nor from <code>content</code> elements back to the host or its children.

<p>CSS Rules declared outside the shadow tree do <strong>not</strong> apply to nodes inside it. Conversely, style rules declared inside the shadow tree also do <strong>not</strong> apply to nodes outside.

<p>All of the above also applies to selectors used in certain JavaScript APIs,
such as the <code><a href="http://dev.w3.org/2006/webapi/selectors-api/#nodeselector">querySelector()</a></code> and <code><a href="http://dev.w3.org/2006/webapi/selectors-api/#nodeselector">querySelectorAll()</a></code> functions.

<h2>Rendering</h2>

<h3>Host element</h3>
<p>The <span>host element</span> is rendered as normal, including all applicable styles for the element.</p>

<h3>Children of the host element</h3>
<p>Any content of the <span>host element</span> MUST NOT be rendered directly. Instead, such content will be rendered as determined by <code>content</code> elements inside the shadow tree associated with the <span>host element</span>.

<p>In place of rendering the content of the <span>host element</span>, the shadow tree rooted in the <code>ShadowRoot</code> node associated with the <span>host element</span> is rendered.

<h3>The ShadowRoot node</h3>
<p>The <code>ShadowRoot</code> node itself MUST NOT be rendered.

<h3>Descendants of the ShadowRoot node</h3>
<p>Descendants of the <code>ShadowRoot</code> node are rendered as normal, with the exception of <code>content</code> elements.
<p>Also, styles and style rules declared for the DOM tree the <span>host element</span> resides in are by default <strong>not</strong> applicable to nodes in the shadow tree.

<h3>content elements</h3>
<p><code>content</code> elements are <strong>not</strong> rendered. In their place, the child nodes of the <span>host element</span> selected by the <code>content</code> element are rendered. In case no child node of the <span>host element</span> is selected by the <code>content</code> element, the fallback content of the <code>content</code> element (if any) is rendered instead.

<h3>Example</h3>

<p>
For example, to replicate the <code><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element">details</a></code> element, the following shadow tree might be used:
</p>

<pre class="html"><code>
#ShadowRoot
    &lt;div style="display: inline-block;"&gt;
        &lt;div id="summary-line"&gt;
            &lt;span id="expansion-triangle"&gt;▶&lt;/span&gt;&amp;nbsp;&lt;content select="summary:first-of-type"/&gt;
        &lt;/div&gt;
        &lt;div id="explanation" style="display: none;"&gt;
            &lt;content/&gt;
        &lt;/div&gt;
    &lt;/div&gt;
</code></pre>

The following HTML:

<pre class="html"><code>
&lt;details&gt;
    Initial text
    &lt;summary&gt;Frobnoz&lt;/summary&gt;
    &lt;div style="background-color: mauve"&gt;
        Foo!
    &lt;/div&gt;
    &lt;summary&gt;Mxyzptlk&lt;/summary&gt;
    Exitus
&lt;/details&gt;
</code></pre>

would result in the following equivalent tree for rendering:

<pre class="html"><code>
&lt;details&gt;
    <span style="color: #604">&lt;div style="display: inline-block;"&gt;</span>
        <span style="color: #604">&lt;div id="summary-line"&gt;</span>
            <span style="color: #604">&lt;span id="expansion-triangle"&gt;▶&lt;/span&gt;&amp;nbsp;&lt;summary&gt;Frobnoz&lt;/summary&gt;</span>
        <span style="color: #604">&lt;/div&gt;</span>
        <span style="color: #604">&lt;div id="explanation" style="display: none;"&gt;</span>
            Initial text
            &lt;div style="background-color: mauve"&gt;
                Foo!
            &lt;/div&gt;
            &lt;summary&gt;Mxyzptlk&lt;/summary&gt;
            Exitus
        <span style="color: #604">&lt;/div&gt;</span>
    <span style="color: #604">&lt;/div&gt;</span>
&lt;/details&gt;
</code></pre>

<h2>Related specs</h2>

<p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML5</a></p>

<h2 id="typographic-conventions">Typographic conventions</h2>

<p>(This section, as well as styling and conventions were adopted from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">WHATWG HTML5</a> spec and the <a href="http://www.w3.org/">W3C</a> sites.)

<p>This is a definition, requirement, or explanation.</p>

<p class="note">This is a note.</p>

<p class="warning">This is a warning.</p>

<div class="example">This is an example.</div>

<pre class="example"><code>This is a code example.</code></pre>

<p class="question">This is an unanswered open question.</p>

<p class="issue">This is an issue or problem.</p>

<pre class="idl">
// this is an IDL definition
interface <dfn title="">Example</dfn> {
    ...
};
</pre>

<pre class="html">
&lt;!-- this is a HTML fragment --&gt;
&lt;template tag="x-supercalifragilisticexpialidocious"&gt;
    ...
&lt;/template&gt;
</pre>

<pre class="css">
/* this is a CSS fragment */
.example { ... }
</pre>

<div class="algorithm"><dfn id="catbath" title="Bathing a Cat">Algorithm for Bathing a Cat</dfn>
<ol>
    <li>Don medieval armor. Plate armor is best.
    <li>Grab the kitty. Depending on its reaction:
        <dl>
            <dt>Does it have a particularly grumpy day?
            <dd>Consider calling the ambulance in advance.

            <dt>Otherwise:
            <dd>The risk is manageable.
        </dl>
    <li>Enter the bathroom...
</ol>
</div>

<p>
The defining instance of a term is marked up like <dfn id="x-this" title="x-this">this</dfn>. Uses of that term are marked up like <a href="#x-this">this</a>.
</p>

<p>
The defining instance of an element, attribute, or API is marked up like <dfn id="x-that" title="x-that"><code>this</code></dfn>.
References to that element, attribute, or API are marked up like <code><a href="#x-that">this</a></code>.
</p>

<p>
Other code fragments are marked up <code>like this</code>.
</p>

<p>
Variables are marked up like <var>this</var>.
</p>

</body>
</html>
