<!DOCTYPE html>
<html lang="en">
<head>
<title>Shadow DOM</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="../../assets/styles/spec.css" type="text/css">
<link rel="stylesheet" href="../../assets/styles/prettify.css" type="text/css">
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/W3C-ED" type="text/css" >
<script src="../../assets/scripts/bug-assist.js"></script>
<script src="../../assets/scripts/spec-assist.js"></script>
<script src="../../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="14978">
<meta name="bug.short_desc" content="[Shadow]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="//www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>Shadow DOM</h1>
<h2 id="editors-draft">W3C Editor's Draft</h2>
<dl>
<dt>This version</dt>
    <dd><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html</a></dd>
<dt>Latest working draft</dt>
    <dd><a href="http://www.w3.org/TR/shadow-dom/">http://www.w3.org/TR/shadow-dom/</a></dd>
<dt>Revision history</dt>
    <dd><a id="log" href="https://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html">https://dvcs.w3.org/hg/webcomponents/log/tip/spec/shadow/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=14978&amp;short_desc=%5BShadow%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
    <dd class="vcard"><span class="fn">Hayato Ito</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:hayato@google.com">hayato@google.com</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy; 2012 <a href="http://www.w3.org/"><acronym title="World Wide Web Consortium">W3C</acronym></a><sup>&copy;</sup> (<a href="http://www.csail.mit.edu/"><acronym title="Massachusetts Institute of Technology">MIT</acronym></a>, <a href="http://www.ercim.eu/"><acronym title="European Research Consortium for Informatics and Mathematics">ERCIM</acronym></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. <acronym title="World Wide Web Consortium">W3C</acronym> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method of establishing and maintaining functional boundaries between DOM trees and how these trees interact with each other within a document, thus enabling better functional encapsulation within the DOM.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as a First Public Working Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as a Working Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/42538/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<div class="warning">This specification is under heavy refactoring. Use the latest <a href="http://www.w3.org/TR/shadow-dom/">Working Draft</a> as a normative reference.</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about">About this Document</a></li>
    <li><a href="#dependencies">Dependencies</a></li>
    <li><a href="#terminology">Terminology</a></li>
    <li><a href="#encapsulation">Encapsulation</a></li>
    <li><a href="#distributions">Distributions</a></li>
    <li><a href="#composition">Composition</a></li>
    <li><a href="#events">Events</a>
    <ol>
        <li><a href="#events-that-are-always-stopped">Events that are Always Stopped</a></li>
        <li><a href="#event-retargeting">Event Retargeting</a></li>
        <li><a href="#retargeting-related-target">Retargeting <code>relatedTarget</code></a></li>
        <li><a href="#retargeting-touch-events">Retargeting Touch Events</a></li>
        <li><a href="#retargeting-focus-events">Retargeting Focus Events</a></li>
        <li><a href="#event-dispatch">Event Dispatch</a></li>
        <li><a href="#event-retargeting-example">Event Retargeting Example</a></li>
    </ol></li>
    <li><a href="#styles">Styles</a>
    <ol>
        <li><a href="#css-variables">CSS Variables</a></li>
        <li><a href="#text-decoration-property"><code>text-decoration</code> Property</a></li>
        <li><a href="#host-at-rule"><code>@host</code> @-rule</a></li>
        <li><a href="#custom-pseudo-elements">Custom Pseudo-Elements</a></li>
    </ol></li>
    <li><a href="#user-interaction">User Interaction</a>
    <ol>
        <li><a href="#ranges-and-selection">Ranges and Selections</a></li>
        <li><a href="#focus-navigation">Focus Navigation</a></li>
        <li><a href="#active-element">Active Element</a></li>
        <li><a href="#editing">Editing</a></li>
        <li><a href="#assistive-technology">Assistive Technology</a></li>
    </ol>
    </li>
    <li><a href="#html-elements">HTML Elements in Shadow Trees</a>
    <ol>
        <li><a href="#inert-html-elements">Inert HTML Elements</a></li>
        <li><a href="#html-forms">HTML Forms</a></li>
    </ol></li>
    <li><a href="#html-elements-and-their-shadow-trees">HTML Elements and Their Shadow Trees</a>
    <li><a href="#elements-and-dom-objects">Elements and DOM Objects</a>
    <ol>
        <li><a href="#shadow-root-object"><code>ShadowRoot</code> Object</a>
        <ol>
            <li><a href="#shadow-root-attributes"><code>ShadowRoot</code> Attributes</a></li>
            <li><a href="#shadow-root-methods"><code>ShadowRoot</code> Methods</a></li>
        </ol></li>
        <li><a href="#extensions-to-element">Extensions to <code>Element</code> Interface</a>
        <ol>
            <li><a href="#partial-element-attributes">Attributes</a></li>
            <li><a href="#partial-element-methods">Methods</a></li>
        </ol></li>
        <li><a href="#css-host-rule-interface"><code>CSSHostRule</code> Interface</a>
        <ol>
            <li><a href="#css-host-rule-attributes"><code>CSSHostRule</code> Attributes</a></li>
            <li><a href="#css-host-rule-methods"><code>CSSHostRule</code> Methods</a></li>
        </ol></li>
        <li><a href="#content-element">The <code>content</code> HTML element</a></li>
        <li><a href="#shadow-element">The <code>shadow</code> HTML element</a></li>
        <li><a href="#extensions-to-event">Extensions to <code>Event</code> Interface</a>
        <ol>
            <li><a href="#partial-event-attributes">Attributes</a></li>
        </ol></li>
    </ol></li>
    <li><a href="#shadow-dom-example">Shadow DOM Example</a></li>
    <li><a href="#acknowledgements" class="no-number">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about">About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
<ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://www.w3.org/TR/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li>
    <li><a href="http://www.w3.org/TR/touch-events/">Touch Events version 1</a></li>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://www.w3.org/TR/selectors4/">Selectors Level 4</a></li>
    <li><a href="http://www.w3.org/TR/selectors-api2/">Selectors API Level 2</a></li>
</ul>

<p class="fixme">In order to solve the problem of mysterious definitions, we may have to make a concise, complete introduction here. It should explain what shadowing means, how it relates rendering, and what problem shadow DOM solves.</p>

<h2 id="terminology">Terminology</h2>

<h3>Shadow trees</h3>

<p>A <dfn id="dfn-document-tree">document tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> whose <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is a <a href="http://dom.spec.whatwg.org/#concept-document">document</a>.</p>

<p>Each element has an associated ordered list of zero or more <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a>.</p>

<p>An element <dfn id="dfn-verb-host">hosts</dfn> a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> if the <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> is a member of the ordered list which the element has.</p>

<p>A <dfn id="dfn-shadow-host">shadow host</dfn> is an element which <a href="#dfn-verb-host">hosts</a> one or more node <a href="http://dom.spec.whatwg.org/#trees">trees</a>.</p>

<p>A <dfn id="dfn-shadow-tree">shadow tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <a href="#dfn-verb-host">hosted</a> by a <a href="#dfn-shadow-host">shadow host</a>.</p>

<p>A <dfn id="dfn-shadow-root">shadow root</dfn> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of a shadow tree.</p>

<p>If more than one <a href="#dfn-shadow-root">shadow root</a> is <a href="#dfn-verb-host">hosted</a> by the same <a href="#dfn-shadow-host">shadow host</a>, the more recently added <a href="#dfn-shadow-root">shadow root</a> is called the <dfn id="dfn-younger-shadow-root">younger shadow root</dfn>, and the less recently added <a href="#dfn-shadow-root">shadow root</a> is called the <dfn id="dfn-older-shadow-root">older shadow root</dfn>.</p>

<p>If there is no <a href="#dfn-older-shadow-root">older shadow root</a> than a given <a href="#dfn-shadow-root">shadow root</a>,
the <a href="#dfn-shadow-root">shadow root</a> is called the <dfn id="dfn-oldest-shadow-root">oldest shadow root</dfn>.</p>

<p>If there is no <a href="#dfn-yonger-shadow-root">younger shadow root</a> than a given <a href="#dfn-shadow-root">shadow root</a>,
the <a href="#dfn-shadow-root">shadow root</a> is called the <dfn id="dfn-youngest-shadow-root">youngest shadow root</dfn>.</p>

<h3>Trees of trees</h3>

<p>A <dfn id="dnf-tree-of-trees">tree of trees</dfn> is a <a href="http://dom.spec.whatwg.org/#trees">tree</a> which is used to define a relationship between <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a>.</p>

<figure>
  <object data="../../assets/images/tree-of-trees.svg" width="650" height="823"></object>
  <figcaption>Fig. A tree of trees</figcaption>
</figure>

<p>As a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> is defined as a <a href="http://dom.spec.whatwg.org/#trees">relationship</a> between <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a>,
a <a href="#dfn-tree-of-trees">tree of trees</a> is defined as a relationship between <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a> in the similar way as follows:
  <ul>
    <li>A <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>A</var> is called a <dfn id="dfn-parent-tree-root">parent tree</dfn> of a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> <var>B</var> if the <a href="#dfn-shadow-host">shadow host</a> of <var>B</var> <a href="http://dom.spec.whatwg.org/#concept-tree-participate">participates</a> in <var>A</var>.</li>
    <li>If there are more than one <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a> that share the same <a href="#dfn-parent-tree">parent tree</a>, the <a href="http://dom.spec.whatwg.org/#concept-tree-order">tree order</a> between them in the <a href="#dfn-tree-of-trees">tree of trees</a> is defined as follows:
      <ol>
        <li>Let <var>A</var> and <var>B</var> be <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a> that share the same <a href="#dfn-parent-tree">parent tree</a>.</li>
        <li><var>A</var> comes before <var>B</var> if either of the following conditions is satisfied:
          <ul>
            <li>Both <var>A</var> and <var>B</var> are <a href="#dfn-verb-host">hosted</a> by the same <a href="#dfn-shadow-host">shadow host</a> and <var>A</var> is <a href="#dfn-older-shadow-root">older</a> than <var>B</var>.</li>
            <li>The <a href="#dfn-shadow-host">shadow host</a> which <a href="#dfn-verb-host">hosts</a> <var>A</var> is <a href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> the <a href="#dfn-shadow-host">shadow host</a> which <a href="#dfn-verb-host">hosts</a> <var>B</var>.</li>
          </ul>
        </li>
      </ol>
    </li>
    <li>Other relationships and terminologies, such as <dfn id="dfn-root-tree">root tree</dfn>, <dfn id="dfn-child-tree">child tree</dfn>,
      <dfn id="dfn-descendant-tree">descendant tree</dfn>, <dfn id="dfn-inclusive-descendant-tree">inclusive descendant tree</dfn>,
      <dfn id="dfn-ancestor-tree">ancestor tree</dfn>, <dfn id="dfn-inclusive-ancestor-tree">inclusive ancestor tree</dfn>,
      <dfn id="dfn-preceding-tree">preceding tree</dfn>
      are defined in the similar way as defined in <a href="http://dom.spec.whatwg.org/#trees">trees</a>.</li>
  </ul>
</p>

<div class="informative">A <a href="#dfn-document-tree">document tree</a> is always the <a href="#dfn-root-tree">root tree</a> of a <a href="#dfn-tree-of-trees">tree of trees</a>.</div>

<h3>Composed trees</h3>

<p>A <dfn id="dfn-composed-tree">composed tree</dfn> is a <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which is constructed out of <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> from multiple <a href="http://dom.spec.whatwg.org/#concept-node-tree">node trees</a> in a <a href="#dfn-tree-of-trees">tree of trees</a>.
The exact algorithm of constructing a composed tree is specified later.</p>

<figure>
  <object data="../../assets/images/composed-tree.svg" width="654" height="606"></object>
  <figcaption>Fig. A composed tree</figcaption>
</figure>

<p>In <dfn id="dfn-rendering">rendering</dfn> a <a href="#dfn-document-tree">document tree</a>, or presenting it visually, the <a href="#dfn-composed-tree">composed tree</a> <strong>must</strong> be used in <a href="#dfn-rendering">rendering</a> instead of the <a href="#dfn-document-tree">document tree</a>.</p>

<p>If any condition which affects a <a href="#dfn-distribution-map">composed tree</a> has changed, the <a href="#dfn-distribution-map">composed tree</a> <strong>must</strong> be updated before the <a href="#dfn-rendering">rendering</a> occurs.</p>

<p class="fixme">We should probably enumerate these conditions, here or later.</p>

<h3>Distributions</h3>

<p>An <dfn id="dfn-insertion-point">insertion point</dfn> is a defined location where <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in a different <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> appear instead of the nodes's original position when constructing a <a href="#dfn-composed-tree">composed tree</a>.</p>

<figure>
  <object data="../../assets/images/distributions.svg" width="663" height="598"></object>
  <figcaption>Fig. A distribution</figcaption>
</figure>

<p>A <dfn id="dfn-distribution">distribution</dfn> is the mechanism that determines which <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> appear at each <a href="#dfn-insertion-point">insertion point</a>. The exact algorithm of a <a href="#dfn-distribution">distribution</a> is specified later.</p>

<h2 id="encapsulation">Encapsulation</h2>

<p>The ownerDocument property of a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> in a shadow tree <strong>must</strong> refers to the <a href="http://dom.spec.whatwg.org/#concept-document">document</a> of the <a href="#dfn-shadow-host">shadow host</a> which <a href="#dfn-verb-host">hosts</a> the shadow tree.</p>

<p><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#window"><code>Window</code></a> object <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#named-access-on-the-window-object">named properties</a> <strong>must</strong> access the <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in the <a href="#dfn-root-tree">root tree</a>.</p>

<div class="informative">For convenience, the <a href="#dfn-shadow-root">shadow root</a> provides its own set of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">DOM tree accessor</a> methods. No <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> other than the <a href="#dfn-shadow-root">shadow root</a> descendants are accessible with these methods.</div>

<p class="fixme">This secion is tiny. Maybe we could merge it into some other place? Encapsulation is effectively a natural property of having multiple trees.</p>

<h2 id="distributions">Distributions</h2>

<p>A <dfn id="dfn-content-insertion-point">content insertion point</dfn> is an insertion point to where the shadow host's children are distributed.
The <a href="#dfn-content-element">content HTML element</a> that satisfies all of the following conditions represents a <a href="#dfn-content-insertion-point">content insertion point</a>.
  <ul>
    <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the content HTML element is a shadow root</li>
    <li>There is at most one <a href="#dfn-shadow-element">shadow HTML element</a> in the ancestors of the content HTML element</li>
    <li>There is no <a href="#dfn-content-element">content HTML element</a> in the ancestors of the content HTML element</li>
  </ul>
</p>

<p class="fixme">Bring in HTML element and interface definitions here</p>

<p>A <dfn id="dfn-shadow-insertion-point">shadow insertion point</dfn> is an insertion point to where the older shadow root's children are distributed.
The <a href="#dfn-shadow-element">shadow HTML element</a> that satisfies of the following conditions represents a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>.
  <ul>
    <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the shadow HTML element is a shadow root</li>
    <li>There is no <a href="http://dom.spec.whatwg.org/#concept-tree-preceding">preceding</a> <a href="#dfn-shadow-element">shadow HTML element</a></li>
    <li>There is no <a href="#dfn-content-element">content HTML element</a> in the ancestors of the shadow HTML element</li>
  </ul>
</p>

<p class="fixme">Bring in HTML element and interface definitions here</p>

<p>Each <a href="#dfn-tree-of-trees">tree of trees</a> has the <dfn id="dfn-distribution-result">distribution result</dfn> which describes the result of distributions.
The <a href="dfn-distribution-result">distribution result</a> <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> of the followings:
  <ol>
    <li>Each <a href="#dfn-insertion-point">insertion point</a> has an ordered list, called <dfn id="dfn-distributed-nodes">distributed nodes</dfn>, which consists of <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> which are distributed into the <a href="#dfn-insertion-point">insertion point</a>.</li>
    <li>Each <a href="http://www.3.org/TR/domcore/#concept-node">node</a> that is not an <a href="#dfn-insertion-point">insertion point</a> has an ordered list, called <dfn id="dfn-destination-insertion-point">destination insertion points</dfn>, which consists of <a href="#dfn-insertion-point">insertion points</a> to where the <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is distributed</li>
  </ol>
</p>

<div class="informative"><p>One case that deserves special consideration is the situation when an <a href="#dfn-insertion-point">insertion point</a> is a child <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> of another <a href="#dfn-shadow-host">shadow host</a>. In such situations, the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <a href="#dfn-distribution">distributed</a> into that <a href="#dfn-insertion-point">insertion point</a> appear as if they were child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a> in the context of <a href="#dfn-distribution">distribution</a>. Thus, the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> <a href="#dfn-distribution">distributed</a> to a <a href="#dfn-shadow-tree">shadow tree</a> could have already been <a href="#dfn-distribution">distributed</a> from its parent tree.</p>

<p>Despite being distributed to more than one insertion point, a node still only appears once in the composed tree at the final destination.</p>
</div>

<figure>
  <object data="../../assets/images/re-distributions.svg" width="693" height="822"></object>
  <figcaption>Fig. A re-distribution</figcaption>
  <p>In the figure, a node <em>child 1</em> is distributed into <em>insertion point 1</em>. Then <em>child1</em> is re-distributed into <em>insertion point 3</em>.
  The destination insertion points of <em>child 1</em> is [<em>insertion point 1</em>, <em>insertion point 3</em>] and <em>insertion point 3</em> is the final destination of <em>child 1</em>.</p>
</figure>

<p>When a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> <var>A</var> is <dfn id="dfn-distribute">distributed</dfn> into an <a href="#dfn-insertion-point">insertion point</a> <var>B</var>, the following steps <strong>must</strong> happen:
  <ul>
    <li>Add <var>A</var> to the <a href="dfn-distributed-nodes">distributed nodes</a> of <var>B</var></li>
    <li>Add <var>B</var> to the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>A</var></li>
  </ul>
</p>

<p>An <a href="#dfn-insertion-point">insertion point</a> <var>A</var> is the <dfn id="dfn-final-destination">final destination</dfn> of a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> <var>B</var> if <var>A</var> is the last item of the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>B</var>.</p>


<p>The <dfn id="dfn-distribution-algorithm">distribution algorithm</dfn> <strong>must</strong> be used to determine the <a href="dfn-distribution-result">distribution result</a> for a <a href="#dfn-tree-of-trees">tree of trees</a> and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
  <dd><var>TREE-OF-TREES</var>, a tree of trees</dd>
<dt>Output</dt>
  <dd>The <a href="dfn-distribution-result">distribution result</a> is updated for TREE-OF-TREES</dd>
</dl>
<ol>
  <li>Let all distributed nodes and destination insertion points owned by nodes in TREE-OF-TREES be empty</li>
  <li>Let ROOT be the <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the <a href="#dfn-root-tree">root tree</a> of TREE-OF-TREES</li>
  <li>Run the <a href="#dfn-distribution-resolution-algorithm">distribution resolutino algorithm</a> with ROOT as input</li>
</ol>
</div>

<p>The <dfn id="dfn-distribution-resolution-algorithm">distribution resolution algorithm</dfn> <strong>must</strong> be used to determine which <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> are distributed into which <a href="#dfn-insertion-point">insertion points</a> and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
  <dd><var>ROOT</var>, the root node of a node tree</dd>
<dt>Output</dt>
  <dd>The <a href="dfn-distribution-result">distribution result</a> is updated for <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in the <a href="#dfn-iclusive-descendant-tree">inclusive descendant trees</a>.</dd>
</dl>

<ol>
  <li>For each <a href="#dfn-shadow-host">shadow host</a>, <var>SHADOW-HOST</var>, which is descendant of <var>ROOT</var>, in the <a href="http://dom.spec.whatwg.org/#concept-tree-order">tree order</a>:
  <ol>
    <li>Let <var>POOL</var> be the result of the <a href="dfn-pool-population-algorithm">pool population algorithm</a> with <var>SHADOW-HOST</var> as input</li>
    <li>Let <var>LAST-VISITED-SHADOW-ROOT</var> be the <a href="#dfn-youngest-shadow-root">youngest shadow root</a> which <var>SHADOW-HOST</var> <a href="#dfn-verb-host">hosts</a>.</li>
    <li>For each <a href="#dfn-shadow-root">shadow root</a>, <var>SHADOW-ROOT</var>, which <var>HOST</var> <a href="#dfn-verb-host">hosts</a>, in order from the <a href="#dfn-youngest-shadow-root">youngest shadow root</a> to the <a href="#dfn-oldest-shadow-root">oldest shadow root</a>:
    <ol>
      <li>Let <var>LAST-VISITED-SHADOW-ROOT</var> be <var>SHADOW-ROOT</var>.</li>
      <li>Run the <a href="dfn-pool-distribution-algorithm">pool distribution algorithm</a> with <var>SHADOW-ROOT</var> and <var>POOL</var> as input</li>
      <li>Let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in the <a href="#dfn-shadow-tree">shadow tree</a> whose <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is <var>SHADOW-ROOT</var>.</li>
      <li>If such a <var>SHADOW</var> does not exit:
      <ol>
        <li>Break this loop</li>
      </ol></li>
      <li>Let <var>POOL</var> be the result of the <a href="dfn-pool-population-algorithm">pool population algorithm</a> with <var>SHADOW</var> as input.</li>
    </ol></li>
    <li>For each <a href="#dfn-shadow-root">shadow root</a>, <var>SHADOW-ROOT</var>, which <var>SHADOW-HOST</var> <a href="#dfn-verb-host">hosts</a>, in order from <a href="#dfn-oldest-shadow-root">oldest shadow root</a> to the <a href="#dfn-youngest-shadow-root">youngest shadow root</a>, starting from <var>LAST-VISITED-SHADOW-ROOT</var>:
    <ol>
      <li>If <var>SHADOW-ROOT</var> is not <var>LAST-VISITED-SHADOW-ROOT</var>.
      <ol>
        <li>let <var>SHADOW</var> be the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in the <a href="#dfn-shadow-tree">shadow tree</a> whose <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is <var>SHADOW-ROOT</var>.</li>
        <li>Let <var>OLDER-SHADOW-ROOT-CHILDREN</var> be the result of the <a href="dfn-pool-population-algorithm">pool population algorithm</a> with the <a href="#dfn-older-shadow-root">older</a> <a href="#dfn-shadow-root">shadow root</a> relative to <var>SHADOW-ROOT</var> as input.</li>
        <li>For each <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>CHILD</var>, in <var>OLDER-SHADOW-ROOT-CHILDREN</var>
        <ol>
          <li><a href="#dfn-distribute">Distribute</a> <var>CHILD</var> into <var>SHADOW</var>.</li>
        </ol></li>
      </ol></li>
      <li>Run the <a href="dfn-distribution-resolution-algorithm">distribution resolution algorithm</a>, recursively, with <var>SHADOW-ROOT</var> as input</li>
    </ol></li>
  </ol></li>
</ol>
</div>

<p>The <dfn id="dfn-pool-polulation-algorithm">pool population algorithm</dfn> <strong>must</strong> be used to populate <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> from the child <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> of a given <a href="http://www.3.org/TR/domcore/#concept-node">node</a> and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
  <dd><var>NODE</var>, a node</dd>
<dt>Output</dt>
  <dd><var>POOL</var>, an ordered list of nodes</dd>
</dl>

<ol>
  <li>Let <var>POOL</var> be an empty ordered list.</li>
  <li>For each child <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>CHILD</var>, of <var>NODE</var>:
  <ol>
    <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point">insertion point</a>:
    <ol>
      <li>Add all <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in the <a href="dfn-distributed-nodes">distributed nodes</a> of <var>CHILD</var> to <var>POOL</var></li>
    </ol></li>
    <li>Otherwise:
    <ol>
      <li>Add <var>CHILD</var> to <var>POOL</var></li>
    </ol></li>
  </ol></li>
</ol>
</div>

<p>The <dfn id="dfn-pool-distribution-algorithm">pool distribution algorithm</dfn> <strong>must</strong> be used to distribute <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in a pool into the <a href="#dfn-content-insertion-point">content insertion points</a> in a <a href="#dfn-tree">tree</a> and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
  <dd><var>SHADOW-ROOT</var>, a shadow root</dd>
  <dd><var>POOL</var>, an ordered list of nodes</dd>
<dt>Output</dt>
  <dd>Nodes in POOL are distributed into the content insertion points in the tree.</dd>
</dl>

<ol>
  <li>For each <a href="#dfn-content-insertion-point">content insertion point</a>, <var>CONTENT</var>, which is descendant of <var>SHADOW-ROOT</var>, in <a href="#dfn-tree">tree</a> order:
  <ol>
    <li>For each <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>NODE</var>, in <var>POOL</var>
    <ol>
      <li>If <var>NODE</var> satisfies <var>CONTENT</var>'s matching criteria:
      <ol>
        <li><a href="#dfn-distribute">Distribute</a> <var>NODE</var> into <var>CONTENT</var></li>
        <li>Remove <var>NODE</var> from <var>POOL</var></li>
      </ol></li>
    </ol></li>
    <li>If there is no <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> distributed to <var>CONTENT</var>:
    <ol>
      <li>For each child, <var>CHILD</var>, of <var>CONTENT</var>
      <ol>
        <li><a href="#dfn-distribute">Distribute</a> <var>CHILD</var> into <var>CONTENT</var></li>
      </ol></li>
    </ol></li>
  </ol></li>
</ol>

</div>

<div class="informative">When there is no nodes distributed into a <a href="#dfn-content-insertion-point">content insertion point</a> <var>CONTENT</var>, the child <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> of <var>CONTENT</var> are distributed into <var>CONTENT</var> as fallback nodes.</div>


<h3 id="satisfying-matching-criteria">Satisfying Matching Criteria</h3>

<p>The <a href="#dfn-matching-criteria">matching criteria</a> for an <a href="#dfn-insertion-point">insertion point</a> is a set of <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a>. These <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> are restricted to contain only these <a href="http://dev.w3.org/csswg/selectors4/#simple">simple selectors</a>:</p>

<ul>
    <li>A <a href="http://dev.w3.org/csswg/selectors4/#type-selector">type selector</a> or a <a href="http://dev.w3.org/csswg/selectors4/#universal-selector0">universal selector</a></li>
    <li><a href="http://dev.w3.org/csswg/selectors4/#class-selector">class selector(s)</a></li>
    <li>An <a href="http://dev.w3.org/csswg/selectors4/#id-selector">ID selector</a></li>
    <li><a href="http://dev.w3.org/csswg/selectors4/#attribute-selector">attribute selector(s)</a></li>
<!--     <li>the following <a href="http://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class selector(s)</a>:
        <ul>
            <li><code>:link</code></li>
            <li><code>:visited</code></li>
            <li><code>:target</code></li>
            <li><code>:enabled</code></li>
            <li><code>:disabled</code></li>
            <li><code>:checked</code></li>
            <li><code>:indeterminate</code></li>
            <li><code>:nth-child()</code></li>
            <li><code>:nth-last-child()</code></li>
            <li><code>:nth-of-type()</code></li>
            <li><code>:nth-last-of-type()</code></li>
            <li><code>:first-child</code></li>
            <li><code>:last-child</code></li>
            <li><code>:first-of-type</code></li>
            <li><code>:last-of-type</code></li>
            <li><code>:only-of-type</code></li>
        </ul>
    </li> -->
</ul>

<p>A <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> <dfn id="dfn-satisfies-matching-criteria">satisfies</dfn> a <a href="#dfn-matching-criteria">matching criteria</a> only if:
<ol>
    <li>all <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> in the set, contain only the <a href="http://dev.w3.org/csswg/selectors4/#simple">simple selectors</a> specified above; and</li>
    <li>a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> matches at least one <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selectors</a> in the set or the set is empty.</li>
</ol>

<h3 id="distributed-pseudo-element"><code>::distributed()</code> pseudo-element</h3>

<p>The <dfn id="dfn-distributed-pseudo-element">::distributed(selector)</dfn> is a functional pseudo-element taking a <a href="http://www.w3.org/TR/selectors-api2/#relative-selector">relative selector</a> as an argument. It represents a relationship between an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a> and an <a href="http://dom.spec.whatwg.org/#concept-element">element</a> whose <a href="http://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> is <a href="#dfn-distribution">distributed</a> into that <a href="#dfn-insertion-point">insertion point</a>. The argument is <a href="http://dev.w3.org/csswg/selectors4/#scope-contained-selectors">scope-contained</a>, with the <a href="http://dev.w3.org/csswg/selectors4/#reference-element-set">reference element set</a> initialized to the <a href="http://dom.spec.whatwg.org/#concept-tree-parent">parent</a> of the <a href="">element</a>, distributed to the <a href="#dfn-insertion-point">insertion point</a>.</p>

<div class="informative">
<p>For example, the following selector represents the all <code>div</code> elements that are descendants of an element, distributed into an insertion point</p>
<pre><code class="prettyprint">
    ::distributed(div)
</code></pre>
<p>This selector represents all child <code>span</code> elements that are distrubted into insertion points with class attribute <code>victory</code></p>
<pre><code class="prettyprint">
    .victory::distributed(>span)
</code></pre>
</div>

<p class="fixme">Should reference element set be insertion point or parent?</p>

<p>All other types of selectors <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> from a <a href="#dfn-shadow-tree">shadow tree</a> to the <a href="http://www.w3.org/TR/domcore/#trees">tree</a> of its <a href="#dfn-shadow-host">shadow host</a>.</p>


<h2 id="composition">Composition</h2>

<p>The <dfn id="dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</dfn> <strong>must</strong> be used to determine the child <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> of a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> in the <a href="#dfn-composed-tree">composed tree</a> and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
  <dd><var>NODE</var>, a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> which partitipates in a composed tree</dd>
<dt>Output</dt>
  <dd><var>CHILDREN</var>, the child nodes of <var>NODE</var> in the <a href="#dfn-composed-tree">composed tree</a>.</dd>
</dl>

<ol>
  <li>Let <var>CHILDREN</var> be an empty ordered list of nodes</li>
  <li>If <var>NODE</var> is a <a href="#dfn-shadow-host">shadow host</a>:
  <ol>
    <li>Let <var>CHILD-POOL</var> be the children of the <a href="#dfn-youngest-shadow-root">youngest shadow root</a> which <var>NODE</var> <a href="#dfn-verb-host">hosts</a>.</li>
  </ol></li>
  <li>Otherwise:
  <ol>
    <li>Let <var>CHILD-POOL</var> be the child <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> of NODE</li>
  </ol></li>
  <li>For each <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>CHILD</var>, in <var>CHILD-POOL</var>:
  <ol>
    <li>If <var>CHILD</var> is an <a href="#dfn-insertion-point">insertion point</a>:
    <ol>
      <li>For each <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>DISTRIBUTED-NODE</var>, in the <a href="dfn-distributed-nodes">distributed nodes</a> of the <a href="#dfn-insertion-point">insertion point</a> <var>CHILD</var>:
      <ol>
        <li>If <var>CHILD</var> is the <a href="#dfn-final-destination">final destination</a> of <var>DISTRIBUTED-NODE</var>, add <var>DISTRIBUTED-NODE</var> to <var>CHILDREN</var></li>
      </ol></li>
    </ol></li>
    <li>Otherwise:
    <ol>
      <li>Add <var>CHILD</var> to <var>CHILDREN</var></li>
    </ol></li>
  </ol></li>
</ol>

</div>

<p>For a given <a href="#dfn-tree-of-trees">tree of trees</a> <var>TREE-OF-TREES</var>, the <a href="#dfn-composed-tree">composed tree</a> costructed from <var>TREE-OF-TREES</var> <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to the following tree:
<ul>
  <li>The <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the <a href="#dfn-composed-tree">composed tree</a> is the <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the <a href="#dfn-root-tree">root tree</a> of <var>TREE-OF-TREES</var>.</li>
  <li>For a given <a href="http://www.3.org/TR/domcore/#concept-node">node</a> which participates in the <a href="#dfn-composed-tree">composed tree</a>, the child <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> of the <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is the resulf of the <a href="#dfn-composed-tree-children-calculation-algorithm">composed tree children calculation algorithm</a> with the <a href="http://www.3.org/TR/domcore/#concept-node">node</a> as input.
  </li>
</ul>
</p>


<h2 id="events">Events</h2>

<p>When an <a href="http://www.w3.org/TR/domcore/#events">event</a> is <a href="http://www.w3.org/TR/domcore/#dispatching-events">dispatched</a> in a <a href="#dfn-shadow-tree">shadow tree</a>, its path either crosses the <a href="#dfn-shadow-boundary">shadow boundary</a> or is terminated at the <a href="#dfn-shadow-boundary">shadow boundary</a>. One exception are the mutation events. The <a href="http://www.w3.org/TR/DOM-Level-2-Events/events.html#Events-eventgroupings-mutationevents">mutation event types</a> <strong>must</strong> never be dispatched in a <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>The <dfn id="dfn-event-path-calculation-algorithm">event path calculation algorithm</dfn> must be used to determine event path and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>


<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a node</dd>
<dt>Output</dt>
    <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
</dl>
<ol>
  <li>Let the <var>PATH</var> be the empty ordered list of nodes</li>
  <li>Let the <var>CURRENT</var> be NODE</li>
  <li><dfn id="event-path-calculation-algorithm-repeat">Repeat</dfn> while <var>CURRENT</var> exists:
  <ol>
    <li>Add <var>CURRENT</var> to <var>PATH</var></li>
    <li>If the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var> is not empty:
    <ol>
      <li>If the parent <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var> is a <a href="#dfn-shadow-root">shadow root</a>:
      <ol>
        <li>Add the parent <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var> to PATH</li>
      </ol></li>
      <li>Add all <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var> to <var>PATH</var></li>
      <li>Let <var>CURRENT</var> be the last item of the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var></li>
    </ol></li>
    <li>Otherwise:
    <ol>
      <li>If <var>CURRENT</var> is a <a href="#dfn-shadow-root">shadow root</a>:
      <ol>
        <li>Let <var>CURRENT</var> be the <a href="#dfn-shadow-host">shadow host</a> which <a href="#dfn-verb-host">hosts</a> <var>CURRENT</var></li>
      </ol></li>
      <li>Otherwise:
      <ol>
        <li>Let <var>CURRENT</var> be the <a href="http://dom.spec.whatwg.org/#concept-tree-parent">parent</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var></li>
      </ol></li>
    </ol></li>
  </ol></li>
</ol>
</div>

<div class="informative">For convenience, an event path may include shadow roots or <a href="#dfn-insertion-point">insertion points</a> so that event listeners registered on the shadow roots or the <a href="#dfn-insertion-point">insertion points</a> would be invoked.</div>

<h3 id="events-that-are-always-stopped">Events that are Always Stopped</h3>

<p>The <dfn id="dfn-events-always-stopped">following events</dfn> <strong>must</strong> always be stopped at the <a href="http://dom.spec.whatwg.org/#concept-tree-root">root</a> <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of the <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>:</p>
<ul>
    <li><code>abort</code></li>
    <li><code>error</code></li>
    <li><code>select</code></li>
    <li><code>change</code></li>
    <li><code>load</code></li>
    <li><code>reset</code></li>
    <li><code>resize</code></li>
    <li><code>scroll</code></li>
    <li><code>selectstart</code></li>
</ul>

<p>The <dfn id="dfn-vent-epath-calculation-algorithm">modified event path calculation algorithm</dfn> must be used to calculate an event path for the <a href="#dfn-events-always-stopped">those events</a> and must be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>NODE</var>, a node</dd>
<dt>Output</dt>
    <dd><var>PATH</var>, an event path, a ordered list of an event target</dd>
</dl>
<ol>
  <li>Let the <var>PATH</var> be the empty ordered list of nodes</li>
  <li>Let the <var>CURRENT</var> be <var>NODE</var></li>
  <li><dfn id="event-path-calculation-algorithm-repeat">Repeat</dfn> while <var>CURRENT</var> exists:
  <ol>
    <li>Add <var>CURRENT</var> to <var>PATH</var></li>
    <li>If the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var> is not empty:
    <ol>
      <li>If the parent <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var> is a <a href="#dfn-shadow-root">shadow root</a>:
      <ol>
        <li>Add the parent <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var> to <var>PATH</var></li>
      </ol></li>
      <li>Add all <a href="http://www.3.org/TR/domcore/#concept-node">nodes</a> in <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var> to <var>PATH</var></li>
      <li>Let <var>CURRENT</var> be the last item of the <a href="dfn-destination-insertion-points">destination insertion points</a> of <var>CURRENT</var></li>
    </ol></li>
    <li>Otherwise:
    <ol>
      <li>If <var>CURRENT</var> is a <a href="#dfn-shadow-root">shadow root</a>:
      <ol>
        <li>If <var>NODE</var> and <var>CURRENT</var> is in the same <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a>:
        <ol>
          <li>Stops this algorithms</li>
        </ol></li>
        <li>Let <var>CURRENT</var> be the <a href="#dfn-shadow-host">shadow host</a> which <a href="#dfn-verb-host">hosts</a> <var>CURRENT</var></li>
      </ol></li>
      <li>Otherwise:
      <ol>
        <li>Let <var>CURRENT</var> be the parent <a href="http://www.3.org/TR/domcore/#concept-node">node</a> of <var>CURRENT</var></li>
      </ol></li>
    </ol></li>
  </ol></li>
</ol>
</div>


<h3 id="event-retargeting">Event Retargeting</h3>

<p>In the cases where event path is across multiple node trees, the event's information about the target of the event is adjusted in order to maintain <a href="#dfn-encapsulation">encapsulation</a>. Event <dfn id="dfn-retargeting">retargeting</dfn> is a process of computing relative targets for each ancestor of the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> at which the event is dispatched. A <dfn id="dfn-relative-target">relative target</dfn> is a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that most accurately represents the target of a dispatched event at a given ancestor while maintaining the <a href="#dfn-encapsulation">ncapsulation</a>.

<p>The <dfn id="dfn-retargeting-algorithm">retargeting algorithm</dfn> is used to determine relative targets, and it <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>PATH</var>, an event path</dd>
    <dd><var>CURRENT-TARGET</var>, a <a href="http://www.3.org/TR/domcore/#concept-node">node</a> where the event listener is invoked.</dd>
<dt>Output</dt>
    <dd><var>RELATIVE-TARGET</var>, adjusted target</dd>
</dl>
<ol>
    <li>Let <var>CURRENT-TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>CURRENT-TARGET</var> participates in</li>
    <li>Let <var>TARGET</var> be the first item in PATH</li>
    <li>Let <var>TARGET-TREE</var> be the <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which ORIGINAL-TARGET participates in</li>
    <li>Let <var>RELATIVE-TARGET-TREE</var> be the lowest common <a href="http://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> tree of CURRENT-TARGET-TREE and TARGET-TREE</li>
    <li>Let <var>RELATIVE-TARGET</var> be the <a href="http://www.3.org/TR/domcore/#concept-node">node</a> which satisfie all the following conditions:
    <ol>
        <li>The <a href="http://www.3.org/TR/domcore/#concept-node">node</a> participates in RELATIVE-TARGET-TREE</li>
        <li>The <a href="http://www.3.org/TR/domcore/#concept-node">node</a> is a member of PATH</li>
        <li>There is no other decendant <a href="http://www.3.org/TR/domcore/#concept-node">node</a> which satisfies the conditions.</li>
    </ol></li>
</ol>
</div>

<p>The retargeting process <strong>must</strong> occur prior to dispatch of an event.</p>


<h3 id="retargeting-related-target">Retargeting <code>relatedTarget</code></h3>

<p>Some events have a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property, which holds a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that's not the event's target, but is related to the event.</p>

<p>For instance, a <code>mouseover</code> event's <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> may hold the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> from which the mouse has moved to event's <code>target</code>. In the case where <code>relatedTarget</code> is in a <a href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> not leak its actual value outside of this tree. In cases where both <code>relatedTarget</code> and <code>target</code> are part of the same <a href="#dfn-shadow-tree">shadow tree</a>, the conforming UAs <strong>must</strong> <em>stop</em> events at the <a href="#dfn-shadow-boundary">shadow boundary</a> to avoid the appearance of spurious <code>mouseover</code> and <code>mouseout</code> events firing from the same node.</p>

<p>Thus, if an event has a <code>relatedTarget</code>, its value and extent of event dispatch <strong>must</strong> be adjusted. In general:</p>
<ol>
    <li>For a given node, the <code>relatedTarget</code> <strong>must</strong> be changed to its ancestor (or self) that is in the same <a href="#dfn-shadow-tree">shadow tree</a> as the node</li>
    <li>Event listeners <strong>must not</strong> be invoked on a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> for which the <code>target</code> and <code>relatedTarget</code> are the same.</li>
</ol>

<p>The <dfn id="dfn-related-target-algorithm">related target resolution</dfn> algorithm <strong>must</strong> be used to determine the value of the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> property and <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to processing the following steps:</p>


<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>CURRENT-TARGET</var>, the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which event listeners would be invoked</dd>
    <dd><var>RELATED-TARGET</var>, the related target for the event</dd>
<dt>Output</dt>
    <dd><var>ADJUSTED-RELATED-TARGET</var>, the <dfn id="dfn-adjusted-related-target">adjusted related target</dfn> for <var>NODE</var></dd>
</dl>
<ol>
  <li>Let <var>ADJUSTED-RELATED-TARGET</var> be null</li>
  <li>Let <var>RELATED-TARGET-PATH</var> be the result of the event path calculation algorithm with <var>RELATED-TARGET</var> as input</li>
  <li>For each <a href="http://dom.spec.whatwg.org/#concept-tree-inclusive-ancestor">inclusive ancestor</a> tree, <var>CURRENT-TREE</var>, of the <a href="http://dom.spec.whatwg.org/#concept-node-tree">node tree</a> which <var>CURRENT-TARGET</var> participates in, in ascending order:
  <ol>
    <li>For each <a href="http://www.3.org/TR/domcore/#concept-node">node</a>, <var>RELATED-PATH-ANCESTOR</var>, in the <var>RELATED-PATH</var>:
    <ol>
      <li>If <var>RELATED-PATH-ANCESTOR</var> participates in <var>CURRENT-TREE</var>:
      <ol>
        <li>Let <var>ADJUSTED-RELATED-TARGET</var> be RELATED-PATH-ANCESTOR</li>
        <li>Stops</li>
      </ol></li>
    </ol></li>
  </ol></li>
</ol>
</div>

<div class="informative">The result of the related target resolution algorithm is not always null. Unless that, you should file a bug for this specification.</div>


<h3 id="retargeting-touch-events">Retargeting Touch Events</h3>

<p>The <a href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a href="http://www.w3.org/TR/touch-events/#widl-Touch-target"><code>target</code></a> attribute must be adjusted in the same way as an event with a <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a>. Each <a href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a href="http://www.w3.org/TR/touch-events/#widl-Touch-target"><code>target</code></a> in the <a href="http://www.w3.org/TR/touch-events/#touchlist-interface"><code>TouchList</code></a> returned from <a href="http://www.w3.org/TR/touch-events/#touchevent-interface"><code>TouchEvent</code></a> <a href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-touches"><code>touches()</code></a>, <a href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-changedTouches"><code>changedTouches()</code></a> and <a href="http://www.w3.org/TR/touch-events/#widl-TouchEvent-targetTouches"><code>targetTouches()</code></a> must be the result of <a href="#dfn-related-target-algorithm">related target resolution algorithm</a>, given <var>NODE</var> and <a href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a href="http://www.w3.org/TR/touch-events/#widl-Touch-target"><code>target</code></a> as arguments.

<h3 id="retargeting-focus-events">Retargeting Focus Events</h3>

<p>The <code>focus</code>, <code>DOMFocusIn</code>, <code>blur</code>, and <code>DOMFocusOut</code> events <strong>must</strong> be treated in the same way as events with a <code>relatedTarget</code>, where the corresponding <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that is losing focus as a result of <code>target</code> gaining focus or the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> that is gaining focus, and thus causing the blurring of <code>target</code> acts as the related target.</p>


<h3 id="event-dispatch">Event Dispatch</h3>

<p>At the time of event dispatch:</p>
<ul>
    <li>The <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> attributes <strong>must</strong> return the <a href="#dfn-relative-target">relative target</a> for the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which event listeners are <a href="http://www.w3.org/TR/domcore/#concept-event-listener-invoke">invoked</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent"><code>MouseEvent</code></a> <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target">adjusted related target</a></li>
    <li>The <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent"><code>MouseEvent</code></a> <a href="http://dev.w3.org/csswg/cssom-view/#widl-MouseEvent-offsetX"><code>offsetX</code></a> and <a href="http://dev.w3.org/csswg/cssom-view/#widl-MouseEvent-offsetY"><code>offsetY</code></a> attributes <strong>must</strong> return the coordinates relative to the origin of the <a href="http://dev.w3.org/csswg/cssom-view/#padding-edge">padding edge</a> of the <a href="#dfn-relative-target">relative target</a></li>
    <li>The <a href="http://www.w3.org/TR/touch-events/#touch-interface"><code>Touch</code></a> <a href="http://www.w3.org/TR/touch-events/#widl-Touch-target"><code>target</code></a> attribute <strong>must</strong> return the <a href="#dfn-adjusted-related-target">adjusted related target</a></li>
    <li>If the <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-MouseEvent-relatedTarget"><code>relatedTarget</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> are the same for a given node, its the event listeners <strong>must not</strong> be invoked. <a href="http://www.w3.org/TR/touch-events/#touchevent-interface"><code>TouchEvent</code></a> is not subject to this rule.</li>
    <li>When <em>capturing</em>, which entails processing step 6 of the <a href="http://dom.spec.whatwg.org/#concept-event-dispatch">event dispatch algorithm</a>, the event listeners <strong>must not</strong> be <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a> on a <a href="http://dom.spec.whatwg.org/#concept-node">node</a> <strong>if</strong> it is the same as its <a href="#dfn-relative-target">relative target</a></li>
    <li>When <em>bubbling</em>, which entails processing step 9 of the <a href="http://dom.spec.whatwg.org/#concept-event-dispatch">event dispatch algorithm</a>, the <a href="http://dom.spec.whatwg.org/#event"><code>Event</code></a> <a href="http://dom.spec.whatwg.org/#dom-event-eventphase">eventPhase</a> attribute <strong>must</strong> return <a href="http://dom.spec.whatwg.org/#dom-event-at_target">AT_TARGET</a> <strong>if</strong> the <a href="#dfn-relative-target">relative target</a> is same as the <a href="http://dom.spec.whatwg.org/#concept-node">node</a> on which event listeners are <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoked</a></li>
    <li>If the event's <a href="http://dom.spec.whatwg.org/#dom-event-bubbles"><code>bubbles</code></a> attribute value is <strong>false</strong>, run these substeps:
    <ol>
        <li>Reverse the order of <em>event path</em></li>
        <li>Initialize event's <a href="http://dom.spec.whatwg.org/#dom-event-eventphase"><code>eventPhase</code></a> attribute to <a href="http://dom.spec.whatwg.org/#dom-event-at_target"><code>AT_TARGET</code></a></li>
        <li>For each object in <em>event path</em> where the <a href="#dfn-relative-target">relative target</a> is same as the object, <a href="http://dom.spec.whatwg.org/#concept-event-listener-invoke">invoke</a> its <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listeners</a>, with event <em>event</em>, as long as <em>event</em>'s <a href="http://dom.spec.whatwg.org/#stop-propagation-flag">stop propagation flag</a> is unset</li>
    </ol>
</ul>

<p>Upon completion of the event dispatch, the <a href="http://www.w3.org/TR/domcore/#event"><code>Event</code></a> object's <a href="http://www.w3.org/TR/domcore/#dom-event-target"><code>target</code></a> and <a href="http://www.w3.org/TR/domcore/#dom-event-currenttarget"><code>currentTarget</code></a> <strong>must</strong> be to the highest ancestor's <a href="#dfn-relative-target">relative target</a>. Since it is possible for a script to hold on to the <code>Event</code> object past the scope of event dispatch, this step is necessary to avoid revealing the <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> in <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="event-retargeting-example">Event Retargeting Example</h3>

<p>Suppose we have a user interface for a media controller, represented by this tree, composed of both <a href="#dfn-document-tree">document tree</a> and the <a href="#dfn-shadow-tree">shadow trees</a>. In this example, we will assume that selectors are allowed to cross the shadow boundaries and we will use these selectors to identify the <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a>. Also, we will invent a fictional <code>shadow-root</code> <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> to demarcate the <a href="#dfn-shadow-boundary">shadow boundaries</a> and represent <a href="#dfn-shadow-root">shadow roots</a>:</p>
<pre><code>
&lt;div id=&quot;player&quot;&gt;
    <span class=shadow-boundary>&lt;shadow-root id=&quot;player-shadow-root&quot;&gt;</span>
        &lt;div id=&quot;controls&quot;&gt;
            &lt;button class=&quot;play-button&quot;&gt;PLAY&lt;/button&gt;
            &lt;input type=&quot;range&quot; id=&quot;timeline&quot;&gt;
                <span class=shadow-boundary>&lt;shadow-root id=&quot;timeline-shadow-root&quot;&gt;</span>
                    &lt;div class=&quot;slider-thumb&quot; id=&quot;timeline-slider-thumb&quot;&gt;&lt;/div&gt;
                <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
            &lt;/input&gt;
            &lt;div class=&quot;volume-slider-container&quot;&gt;
                &lt;input type=&quot;range&quot; class=&quot;volume-slider&quot;&gt;
                    <span class=shadow-boundary>&lt;shadow-root id=&quot;volume-shadow-root&quot;&gt;</span>
                        &lt;div class=&quot;slider-thumb&quot; id=&quot;volume-slider-thumb&quot;&gt;&lt;/div&gt;
                    <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
                &lt;/input&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    <span class=shadow-boundary>&lt;/shadow-root&gt;</span>
&lt;/div&gt;
</code></pre>

<p>Let's have a user position their pointing device over the volume slider's thumb (<code>#volume-slider-thumb</code>), thus triggering a <code>mouseover</code> event on that node. For this event, let's pretend it has no associated <code>relatedTarget</code>.</p>

<p>Just before the event is dispatched, we perform <a href="#dfn-retargeting">retargeting</a>:</p>
<ol>
    <li>Since <code>#volume-slider-thumb</code> is not an <a href="#dfn-insertion-point">insertion point</a>, we push it onto <var>STACK</var>, and add the first tuple to <var>TARGETS</var> as (<code>#volume-slider-thumb</code>, <code>#volume-slider-thumb</code>)</li>
    <li>We then <a href="#dfn-parent-calculation-algorithm">calculate parent</a> as <code>#volume-shadow-root</code> and proceed to second iteration, adding (<code>#volume-slider-thumb</code>, <code>#volume-shadow-root</code>) tuple to <var>TARGETS</var></li>
    <li>Because <code>#volume-shadow-root</code> is a <a href="#dfn-shadow-root">shadow root</a>, we pop <var>STACK</var>, thus emptying it</li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">parent calculation</a> yields <code>#volume-slider</code>, and so we begin the third iteration</li>
    <li>Here, <var>STACK</var> is empty again, so we push <code>#volume-slider</code> into it and add (<code>#volume-slider</code>, <code>#volume-slider</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">parent</a> of <code>#volume-slider</code> is <code>#volume-slider-container</code> not a <a href="#dfn-shadow-root">shadow root</a> and not an <a href="#dfn-insertion-point">insertion point</a>, which dictates that we add (<code>#volume-slider</code>, <code>#volume-slider-container</code>) to <var>TARGETS</var></li>
    <li>Next <a href="#dfn-parent-calculation-algorithm">up</a>, we see <code>#controls</code>, again neither a <a href="#dfn-shadow-root">shadow root</a> nor an <a href="#dfn-insertion-point">insertion point</a>, which means we add (<code>##volume-slider</code>, <code>#controls</code>) to <var>TARGETS</var></li>
    <li>The <a href="#dfn-parent-calculation-algorithm">next ancestor</a> is <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, and thus we add it (<code>#volume-slider</code>, <code>#player-shadow-root</code>) to <var>TARGETS</var>, then pop <var>STACK</var>, emptying it</li>
    <li>Its <a href="#dfn-parent-calculation-algorithm">parent</a> is <code>#player</code>, neither <a href="#dfn-shadow-root">shadow root</a> nor <a href="#dfn-insertion-point">insertion point</a>, and <var>STACK</var> is empty, so we push <code>#player</code> to <var>STACK</var>, then add (<code>#player</code>, <code>#player</code>) to <var>TARGETS</var></li>
    <li>In our example, there are no further <a href="#dfn-parent-calculation-algorithm">parents</a>, causing us to exit the <a href="#algo-reatargeting-repeat">loop</a> and stop.</li>
</ol>

<p>At the end of this process, we should have the following set of ancestors and relative targets:</p>
<table>
<thead>
<tr>
    <th>Ancestor</th>
    <th>Relative Target</th>
</tr>
</thead>
<tbody>
<tr>
    <td><code>#player</code></td>
    <td><code><strong>#player</strong></code></td>
</tr>
<tr>
    <td><code>#player-shadow-root</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#controls</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider-container</code></td>
    <td><code>#volume-slider</code></td>
</tr>
<tr>
    <td><code>#volume-slider</code></td>
    <td><code><strong>#volume-slider</strong></code></td>
</tr>
<tr>
    <td><code>#volume-shadow-root</code></td>
    <td><code>#volume-slider-thumb</code></td>
</tr>
<tr>
    <td><code>#volume-slider-thumb</code></td>
    <td><code><strong>#volume-slider-thumb</strong></code></td>
</tr>
</tbody>
</table>

<p>After we dispatch the <code>mouseover</code> event using these newly computed relative targets, the user decides to move their pointing device over the thumb of the timeline
(<code>#timeline-slider-thumb</code>). This triggers both a <code>mouseout</code> event for the volume slider thumb and the <code>mouseover</code> event for the timeline thumb.</p>

<p>Let's study how the <code>relatedTarget</code> value of the volume thumb's <code>mouseout</code> event is affected. For this event, the <code>relatedTarget</code> is the timeline thumb (<code>#timeline-slider-thumb</code>). Per <a href="#dfn-related-target-algorithm">algorithm</a>:</p>

<ol>
    <li>Starting with <var>NODE</var> as <code>#volume-slider-thumb</code> and <var>RELATED</var> as <code>#timeline-slider-thumb</code>,</li>
    <li>We <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var>:
    <ol>
        <li>First <a href="#dfn-parent-calculation-algorithm">up</a> is <code>#timeline-slider-thumb</code>, and we push it into <var>STACK</var></li>
        <li>Then it's <code>#timeline-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Next is <code>#timeline</code>, we push it into <var>STACK</var></li>
        <li>Then comes <code>#controls</code> and after it, <code>#player-shadow-root</code>, a <a href="#dfn-shadow-root">shadow root</a>, so we pop <var>STACK</var>, emptying it</li>
        <li>Final ancestor is <code>#player</code>, we push it into <var>STACK</var></li>
    </ol>
    <li>Set <var>TARGET</var> to <code>#volume-shadow-root</code></li>
    <li>We again <a href="#algo-ancestor-repeat">examine</a> ancestors of <var>RELATED</var> and notice that it produces the same result as our previous such examination</li>
    <li>We then set <var>TARGET</var> to <code>#volume-slider</code> and</li>
    <li>Repeat <a href="#algo-ancestor-repeat">examination</a> of ancestors once more&mdash;and realize that when <var>ANCESTOR</var> value is <code>#timeline</code>, the <var>ANCESTOR</var> and <var>TARGET</var> are in the same tree, and thus</li>
    <li>Return <code>#timeline</code> as the adjusted <code>relatedTarget</code> value.
</ol>

<p>Performing this computation with <var>NODE</var> as <code>#player</code> yields the result of both <code>target</code> and <code>relatedTarget</code> being the same value (<code>#player</code>), which means that we do not dispatch the event on this <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> and its ancestors.</p>

<h2 id="styles">Styles</h2>

<p>Each <a href="#dfn-shadow-root">shadow root</a> has an associated list of zero or more <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, named <dfn id="dfn-shadow-root-style-sheets">shadow root style sheets</dfn>. This is an ordered list that contains all <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheets</a>, associated with the <a href="#dfn-shadow-root">shadow root</a>, in <a href="http://www.w3.org/TR/dom/#concept-tree-order">tree order</a>.</p>

<p>When a <a href="#dfn-shadow-host">shadow host</a> has multiple <a href="#dfn-shadow-root">shadow roots</a>, the <a href="http://dev.w3.org/csswg/css3-cascade/#cascade">cascade order</a> of <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a>, defined in <a href="#dfn-shadow-root-style-sheets">shadow roow style sheets</a>, in ascending order of precedence <strong>must</strong> match the order of the <a href="#dfn-tree-stack">tree stack</a>, ending with the <a href="#dfn-youngest-tree">youngest tree</a>.</p>

<p>To enforce <a href="#deprecated-dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in an <a href="#deprecated-dfn-enclosed-tree">enclosing</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> <strong>must not</strong> apply in a <a href="#dfn-shadow-tree">shadow tree</a>, except when the <dfn id="dfn-apply-author-styles">apply-author-styles</dfn> flag is set for this tree. The flag signals that the rules declared in the <a href="#deprecated-dfn-enclosed-tree">enclosing</a> trees are applicable in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>Even when the <a href="#dfn-apply-author-styles">apply-author-styles</a> is set, the <a href="http://www.w3.org/TR/selectors4/">selectors</a> still <strong>must not</strong> cross the <a href="#dfn-shadow-boundary">shadow boundary</a> per <a href="#dfn-scoping-constraints">scoping constraints</a>. In other words, with <a href="#dfn-apply-author-styles">apply-author-styles</a> set, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> CSS rules only match wholly inside or outside of the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>For the purposes of the <a href="http://dev.w3.org/csswg/css3-cascade/#cascade">cascade order</a>, the  <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> for <a href="#dfn-shadow-tree">shadow trees</a> that have the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag set <strong>must</strong> be treated as <a href="http://www.w3.org/TR/selectors4/#scoping">scoped</a> selectors with <a href="#dfn-shadow-root">shadow root</a> as their scope. In this context, for <a href="#dfn-shadow-tree">shadow trees</a> <em>A</em> and <em>B</em>, the <em>A</em>'s <a href="#dfn-shadow-root">shadow root</a> is treated as <em>descendant</em> of <em>B</em>'s <a href="#dfn-shadow-root">shadow root</a> if <em>A</em> is <a href="#deprecated-dfn-enclosed-tree">enclosed</a> by <em>B</em>.</p>

<p>If a <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rule</a> in a <a href="#deprecated-dfn-nesting-tree">nesting</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> ends with a <a href="http://www.w3.org/TR/selectors4/#compound">compound selector</a> that contains a <a href="http://www.w3.org/TR/selectors4/#pseudo-elements">pseudo-element</a> whose name equals to a <a href="#dfn-valid-custom-pseudo-element-value">valid</a> <a href="#dfn-custom-pseudo-element-value">value</a> of a <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> that exists in this <a href="#dfn-shadow-tree">shadow tree</a>, this <a href="http://www.w3.org/TR/selectors4/#pseudo-elements">pseudo-element</a> <strong>must</strong> match the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>, associated with this <a href="#dfn-custom-pseudo-element">custom pseudo-element</a>.</p>

<p>Conversely, to enforce <a href="#deprecated-dfn-lower-boundary-encapsulation">lower-boundary encapsulation</a>, <a href="http://www.w3.org/TR/CSS2/syndata.html#rule-sets">CSS rules</a> declared in a <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> <strong>must not</strong> apply in the <a href="#dfn-document-tree">document tree</a>, with two exceptions:</p>
<ol>
    <li>Rules that contain <code>select</code> <a href="#dfn-distributed-pseudo-element"><code>::distributed()</code> pseudo-element</a> match <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in the <a href="#deprecated-dfn-enclosed-tree">enclosing</a> trees;</li>
    <li>The <a href="#host-at-rule"><code>@host</code> @-rule</a> matches a <a href="#dfn-shadow-host">shadow host</a> in the <a href="#deprecated-dfn-nesting-tree">nesting</a> tree.</li>
</ol>

<p>In a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> that contains <a href="#dfn-shadow-tree">shadow trees</a>, the CSS properties <strong>must</strong> be inherited from parent nodes, produced using the <a href="#dfn-parent-calculation-algorithm">parent calculation algorithm</a>. This requirement has the following effects:</p>
<ul>
    <li>the styles of the <a href="#dfn-shadow-host">shadow host</a> are inherited by the children of the <a href="#dfn-shadow-root">shadow root</a></li>
    <li>the styles of the <a href="#dfn-insertion-point">insertion point</a> <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> are inherited by those child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a> that are <a href="#dfn-assigned">assigned</a> to this <a href="#dfn-insertion-point">insertion point</a></li>
    <li>the styles of the <a href="#dfn-shadow-insertion-point">shadow insertion point</a> <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> are inherited by the child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-root">shadow root</a> of the <a href="#dfn-shadow-tree">shadow tree</a>, <a href="#dfn-distribution">distributed</a> to this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></li>
</ul>

<p>If the <dfn id="dfn-reset-style-inheritance">reset-style-inheritance</dfn> flag is set for a <a href="#dfn-shadow-tree">shadow tree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the upper boundary of the tree.</p>

<p>If the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag is set for an <a href="#dfn-insertion-point">insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a>, all <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#inheritance">inheritable</a> CSS properties <strong>must</strong> behave as if they were explicitly set to the <a href="http://www.w3.org/TR/2005/WD-css3-cascade-20051215/#initial0">initial value</a> at the lower boundary of the tree.</p>

<h3 id="css-variables">CSS Variables</h3>

<p>The <a href="#dfn-shadow-host">shadow host</a> styles being inherited by the children of the <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also apply to <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a>. This provides a way for <a href="#dfn-document-tree">document tree</a> styles to send signals into the <a href="#dfn-shadow-tree">shadow trees</a>, and for the <a href="#dfn-shadow-tree">shadow trees</a> to receive these signals with the use of the <a href="http://dev.w3.org/csswg/css-variables/#using-variables"><code>var()</code></a> function.</p>

<h3 id="text-decoration-property"><code>text-decoration</code> Property</h3>

<p>The text decorations, specified by the <a href="http://www.w3.org/TR/CSS2/text.html#lining-striking-props"><code>text-decoration</code></a> property <strong>must not</strong> be propagated from <a href="#dfn-shadow-host">shadow hosts</a> to <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="host-at-rule"><code>@host</code> @-rule</h3>

<p>Within styles, specified in <a href="#dfn-shadow-tree">shadow trees</a>, the author may use a <code>@host</code> @-rule. The syntax of this rule is defined as this addition to <a href="http://www.w3.org/TR/CSS21/grammar.html">CSS Grammar</a>:</p>

<p>The following production is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#grammar">grammar</a>:</p>

<pre><code>
host
    : HOST_SYM S* '{' S* ruleset* '}' S*
    ;
</code></pre>

<p>The following rule is added to the <a href="http://www.w3.org/TR/CSS21/grammar.html#scanner">tokenizer</a>:</p>

<pre><code>
@{H}{O}{S}{T}        {return HOST_SYM;}
</code></pre>

<p>The <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> of the rules in a <code>@host</code> @-rule <strong>must</strong> only be matched against the <a href="#dfn-shadow-host">shadow host</a> of the <a href="#dfn-shadow-tree">shadow tree</a> in which the style is specified, but only if this <a href="#dfn-shadow-tree">shadow tree</a> is <a href="#dfn-rendering">rendered</a>. When the <a href="#dfn-shadow-tree">shadow tree</a> is not <a href="#dfn-rendering">rendered</a> (when it's an older <a href="http://www.w3.org/TR/domcore/#trees">tree</a> that is not <a href="#dfn-assigned">assigned</a> to a <a href="#dfn-shadow-insertion-point">shadow insertion point</a>), the <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> <strong>must not</strong> be applied.</p>

<p>When a rule in <a href="#host-at-rule"><code>@host</code> @-rule</a> matches an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>, it <strong>must</strong> have higher <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than any <a href="http://www.w3.org/TR/selectors4/">selector</a>, but lower <a href="http://www.w3.org/TR/CSS2/cascade.html#specificity">specificity</a> than <a href="http://www.w3.org/TR/CSS21/syndata.html#x19">declarations</a> from a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#the-style-attribute"><code>style</code></a> attribute.</p>

<h3 id="custom-pseudo-elements">Custom Pseudo-Elements</h3>

<p>In certain situations, the author of a <a href="#dfn-shadow-tree">shadow tree</a> may wish to designate one or more <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> from that <a href="http://www.w3.org/TR/domcore/#trees">tree</a> as a structural abstraction that provides additional information about the contents of the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<div class="informative">
For example, when developing a 2-dimensional range slider widget, which offers a thumb that could be moved in 2 directions in a rectangular space, the author decides to allow the widget users to style the thumb directly.
</div>

<p>The <dfn id="dfn-custom-pseudo-element">custom pseudo-elements</dfn> enable this scenario. A <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> is an association between an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in a <a href="#dfn-shadow-tree">shadow tree</a> and a string value. This string value is called a <dfn id="dfn-custom-pseudo-element-value">custom pseudo-element value</dfn>. The <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> <strong>must</strong> be considered <dfn id="dfn-valid-custom-pseudo-element-value">valid</dfn> if it starts with a <var>U+0078 LATIN SMALL LETTER X</var>, followed by  <var>U+002D HYPHEN-MINUS</var>. Otherwise, the <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> <strong>must</strong> be considered invalid.</p>

<div class="informative">

<p>In the case of the aforementioned 2-dimensional slider widget, the author could build the widget's shadow tree as follows:</p>

<pre><code class="prettyprint">
var widget = document.createElement('div');
var root = widget.createShadowRoot();
var thumb = document.createElement('div');
thumb.pseudo = 'x-thumb';
root.appendChild(thumb);
</code></pre>

<p>Once the <code>pseudo</code> property is set, the consumer of the widget could style the widget's thumb using <code>x-thumb</code> pseudo-element, reaching into the widget's shadow tree directly to the thumb:</p>

<pre><code class="prettyprint">
div::x-thumb {
    width: 10px;
    height: 10px;
    color: bisque;
}
</code></pre>

</div>

<div class="fixme">
    Using the <code>x-</code> prefix was raised as a problem (see <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20600">bug 20600</a>), but no one presented better alternatives yet.
</div>

<h2 id="user-interaction">User Interaction</h2>

<h3 id="ranges-and-selection">Ranges and Selections</h3>

<p>Since a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in a <a href="#dfn-document-tree">document tree</a> and a <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in a <a href="#dfn-shadow-tree">shadow tree</a> never have the same <a href="http://www.w3.org/TR/domcore/#concept-tree-root">root</a>, there may never exist a valid <a href="http://www.w3.org/TR/domcore/#range">DOM range</a> that spans either both a <a href="#dfn-document-tree">document tree</a> and a <a href="#dfn-shadow-tree">shadow tree</a>, or multiple <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>Accordingly, <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selections</a> may only exist within one tree, because they are defined by a single <a href="http://www.w3.org/TR/domcore/#range">range</a>. To maintain <a href="#deprecated-dfn-upper-boundary-encapsulation">upper boundary encapsulation</a>, the selection, returned by the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#dom-window-getselection"><code>window.getSelection()</code></a> method <strong>must</strong> never return a selection within a <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>The <code>getSelection()</code> method of the <a href="#dfn-shadow-root">shadow root</a> object <strong>must</strong> return the current <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in this <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<h3 id="focus-navigation">Focus Navigation</h3>

<p><a href="#dfn-shadow-tree">Shadow trees</a> participate in <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential</a> or <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional</a> focus navigation as part of the <a href="#dfn-document-tree">document tree</a>. The <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a> within a <a href="#dfn-shadow-tree">shadow tree</a> <strong>must</strong> be computed as a list of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#tree-order">tree order</a> <a href="#deprecated-dfn-as-rendered">as-rendered</a>, with the exception of any <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a>, <a href="#dfn-distribution">distributed</a> into <a href="#dfn-insertion-point">insertion points</a>, and is called <dfn id="dfn-shadow-dom-navigation-order">shadow DOM navigation order</dfn>.</p>

<div class="informative">
Since the elements, distributed into insertion points are not part of the shadow tree, their order remains to be controlled by the navigation order of the nesting tree.
</div>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">sequential focus navigation</a>, the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> sequence <strong>must</strong> be inserted into the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>:</p>
<ol>
    <li>immediately after the <a href="#dfn-shadow-host">shadow host</a>, if the shadow host is <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#focusable">focusable</a>; or</li>
    <li>in place of the <a href="#dfn-shadow-host">shadow host</a> as if the shadow host were assigned the value of <a href="http://www.w3.org/TR/css3-ui/#keyboard"><code>auto</code></a> for determining its position.</li>
</ol>

<p>For <a href="http://www.w3.org/TR/css3-ui/#keyboard">directional focus navigation</a>, it is up to the user agent to integrate the <a href="#dfn-shadow-dom-navigation-order">shadow DOM navigation order</a> into the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/css3-ui/#keyboard">navigation order</a>.</p>

<h3 id="active-element">Active Element</h3>

<p>To maintain <a href="#deprecated-dfn-upper-boundary-encapsulation">upper-boundary encapsulation</a>, the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> object's focus API property <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> <strong>must</strong> be adjusted. To prevent loss of information when adjusting this value, each <a href="#dfn-shadow-root">shadow root</a> <strong>must</strong> also have an <code>activeElement</code> property to store the value of the focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>The <dfn id="active-element-adjustment-algorithm">active <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> adjustment algorithm</dfn> is used to determine the values of the respective <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties, and it <strong>must</strong> be equivalent to processing the following steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>ELEMENT</var>, the focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a></dd>
<dt>Output</dt>
    <dd>Adjusted values of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> properties.</dd>
</dl>
<ol>
    <li>Run the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>ELEMENT</var> as input</li>
    <li>For each <var>TUPLE</var> in the resulting list of tuples:
    <ol>
        <li>Let <var>ADJUSTED</var> be the first value of the <var>TUPLE</var></li>
        <li>Let <var>NODE</var> be the second value of the <var>TUPLE</var></li>
        <li>If <var>NODE</var> is a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">Document</a> or a <a href="#dfn-shadow-root">shadow root</a>, set the value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#dom-document-activeelement">activeElement</a> to <var>ADJUSTED</var>.</li>
    </ol>
    </li>
</ol>
</div>

<h3 id="editing">Editing</h3>

<p>The value of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/editing.html#attr-contenteditable"><code>contenteditable</code></a> attribute <strong>must not</strong> propagate from <a href="#dfn-shadow-host">shadow host</a> to its <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h3 id="assistive-technology">Assistive Technology</h3>

<p>User agents with assistive technology traverse the <a href="#dfn-document-tree">document tree</a> <a href="#deprecated-dfn-as-rendered">as rendered</a>, and thus enable full use of of <a href="http://www.w3.org/WAI/PF/aria/">WAI-ARIA</a> semantics in the <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<h2 id="html-elements">HTML Elements in Shadow Trees</h2>

<p>Comparatively, a <a href="#dfn-shadow-tree">shadow tree</a> can be seen as somewhere between <em>just part of a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a></em> and itself being a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. Since it is rendered, a <a href="#dfn-shadow-tree">shadow tree</a> aims to retain the traits of a typical <a href="http://www.w3.org/TR/domcore/#trees">tree</a> in a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>. At the same time, it is an encapsulation abstraction, so it has to avoid affecting the <a href="#dfn-document-tree">document tree</a>. Thus, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">as specified</a> in the <a href="#dfn-shadow-tree">shadow trees</a>, with a few exceptions.</p>

<h3 id="inert-html-elements">Inert HTML Elements</h3>

<p>A subset of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> behave as <dfn id="dfn-inert">inert</dfn>, or not part of the <a href="#dfn-document-tree">document tree</a>. This is consistent how the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> would behave in a <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">document fragment</a>. These <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> are:</p>
<ul>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-base-element"><code>base</code></a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#the-link-element"><code>link</code></a></li>
</ul>

<p>All other <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> in the <a href="#dfn-shadow-tree">shadow trees</a> <strong>must</strong> behave as if they were part of the <a href="#dfn-document-tree">document tree</a>, with the <a href="#dfn-scoping-constraints">scoping constraints</a> of their respective trees applied.</p>

<h3 id="html-forms">HTML Forms</h3>

<p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#forms">forms</a> in HTML are scoped at the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> level. That is, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a> are accessible using the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> <a href="http://www.w3.org/TR/domcore/#interface-document">DOM object</a>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#dom-tree-accessors">tree accessors</a>. Per <a href="#dfn-scoping-constraints">scoping constraints</a>, this <strong>must</strong> exclude <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> in the <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>Instead, each <a href="#dfn-shadow-tree">shadow tree</a> <strong>must</strong> scope its <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a> <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#form-associated-element">form-associated elements</a>. Because the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-form-element"><code>form</code></a>'s <a href="http://www.w3.org/TR/domcore/#dom-node-ownerdocument"><code>ownerDocument</code></a> is the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>, the form submission <strong>must</strong> continue to work <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#form-submission">as specified</a>.</p>

<h2 id="html-elements-and-their-shadow-trees">HTML Elements and Their Shadow Trees</h2>

<p>Per <a href="http://www.whatwg.org/specs/web-apps/current-work/">specification</a>, some <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> are designed to either not render their contents or have special requirements in regard to contents rendering. In order to reconcile these differences in rendering behavior with the <a href="#deprecated-dfn-shadow-dom">shadow DOM</a> <a href="#dfn-tree-composition">tree composition</a>, all <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a> <strong>must</strong> have an <a href="#dfn-processing-equivalence">equivalent</a> of a <a href="#dfn-shadow-tree">shadow tree</a> that is created and populated at the time of <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> instantiation. It is up to a user agent to define the content of these trees. However, all conforming user agents <strong>must</strong> satisfy the following requirements:</p>

<table>
<thead>
    <tr>
        <th style="width: 30%">HTML Element</th>
        <th>Shadow Tree Requirements</th>
    </tr>
</thead>
<tbody>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/embedded-content-1.html#the-img-element"><code>img</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-iframe-element"><code>iframe</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-embed-element"><code>embed</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-iframe-element.html#the-object-element"><code>object</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-video-element"><code>video</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element"><code>audio</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#the-canvas-element"><code>canvas</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-map-element.html#the-map-element"><code>map</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#the-input-element"><code>input</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-textarea-element"><code>textarea</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-progress-element"><code>progress</code></a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-button-element.html#the-meter-element"><code>meter</code></a></td>
        <td>If the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> can have <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>, contains one <a href="#dfn-insertion-point">insertion point</a>. The <a href="#dfn-matching-criteria">matching criteria</a> value is the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> only when the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> needs to show <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#fallback-content">fallback content</a>. Otherwise, contains no <a href="#dfn-insertion-point">insertion points</a> or an <a href="#dfn-insertion-point">insertion point</a> that matches nothing.</td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/forms.html#the-fieldset-element"><code>fieldset</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>legend:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/interactive-elements.html#the-details-element"><code>details</code></a></td>
        <td>Contains two <a href="#dfn-insertion-point">insertion points</a> with the following <a href="#dfn-matching-criteria">matching criteria</a>:
        <ol>
            <li><code>summary:first-of-type</code></li>
            <li><a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a></li>
        </ol>
        </td>
    </tr>
    <tr>
        <td>All other <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a></td>
        <td>Contains one <a href="#dfn-insertion-point">insertion point</a> with the <a href="http://www.w3.org/TR/css3-selectors/#universal-selector">universal selector</a> as the <a href="#dfn-matching-criteria">matching criteria</a></td>
    </tr>
</tbody>
</table>

<h2 id="elements-and-dom-objects">Elements and DOM Objects</h2>

<h3 id="shadow-root-object"><code>ShadowRoot</code> Object</h3>

<p>The <code>ShadowRoot</code> object represents the <a href="#dfn-shadow-root">shadow root</a>.</p>

<pre><code>
interface <dfn id="api-shadow-root">ShadowRoot</dfn> : <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">DocumentFragment</a> {
    <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement">HTMLElement</a> <a href="#api-shadow-root-get-element-by-id">getElementById</a>(DOMString elementId);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-class-name">getElementsByClassName</a>(DOMString tagName);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name">getElementsByTagName</a>(DOMString className);
    <a href="http://www.w3.org/TR/domcore/#nodelist">NodeList</a> <a href="#api-shadow-root-get-elements-by-tag-name-ns">getElementsByTagNameNS</a>(DOMString? namespace, DOMString localName);
    <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#selection">Selection</a>? <a href="#api-shadow-root-selection">getSelection</a>();
    <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a>? <a href="#api-shadow-root-element-from-point">elementFromPoint</a>(float x, float y);
<!--
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-add-style-sheet">addStyleSheet</a>(HTMLElement element);
    <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> <a href="#api-shadow-root-remove-style-sheet">removeStyleSheet</a>(<a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> styleSheet);
-->
    attribute bool <a href="#api-shadow-root-apply-author-styles">applyAuthorStyles</a>;
    attribute bool <a href="#api-shadow-root-reset-style-inheritance">resetStyleInheritance</a>;
    readonly attribute <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a>? <a href="#api-shadow-root-active-element">activeElement</a>;
    attribute DOMString <a href="#api-shadow-root-inner-html">innerHTML</a>;
    readonly attribute <a href="http://www.w3.org/TR/cssom/#the-stylesheet-interface">StyleSheetList</a> <a href="#api-shadow-root-style-sheets">styleSheets</a>;
}
</code></pre>

<h4 id="shadow-root-attributes"><code>ShadowRoot</code> Attributes</h4>

<dl>
<dt id="api-shadow-root-apply-author-styles"><code>applyAuthorStyles</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag and indicates whether or not the rules in <a href="http://www.w3.org/TR/CSS2/cascade.html">author styles</a> associated with the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>'s <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> apply to the <a href="#dfn-shadow-tree">shadow tree</a>. If <code>false</code> (default value), the author styles <strong>are not</strong> applied to the <a href="#dfn-shadow-tree">shadow tree</a>. If <code>true</code>, the author styles <strong>are</strong> applied.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-apply-author-styles">apply-author-styles</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#trees">tree</a> to specified value.</dd>
<dt id="api-shadow-root-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>bool</code></dt>
<dd>Represents the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag and indicates whether or not the inheritable CSS properties are set to the initial value at the shadow boundary. If <code>false</code> (default value), the properties continue to inherit. If <code>true</code>, the properties are set to initial value.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>
<dd>On setting, the attribute <strong>must</strong> set the value of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for the <a href="#dfn-shadow-host">shadow host</a>'s <a href="http://www.w3.org/TR/domcore/#trees">tree</a> to specified value.</dd>
<dt id="api-shadow-root-active-element"><code>activeElement</code> of type <code>Element</code>, readonly</dt>
<dd>Represents the currently focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the currently focused <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-shadow-tree">shadow tree</a> or <code>null</code>, if there is none.</dd>
<dt id="api-shadow-root-inner-html"><code>innerHTML</code> of type <code>DOMString</code></dt>
<dd>represents the markup of <a href="#api-shadow-root"><code>ShadowRoot</code></a>'s contents.</dd>
<dd>On getting, the attribute <strong>must</strong> return the result of running the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a> with the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a>.</dd>
<dd>On setting, these steps <strong>must</strong> be run:
<ol>
    <li>Let <var>FRAGMENT</var> be the result of invoking the <a href="http://html5.org/specs/dom-parsing.html#concept-parse-fragment">fragment parsing algorithm</a> with the new value as <var>MARKUP</var>, and the <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> as <a href="#dfn-shadow-host"><code>shadow host</code></a></li>
    <li><a href="http://www.w3.org/TR/dom/#concept-node-replace-all">Replace all</a> with <var>FRAGMENT</var> within the <a href="#dfn-shadow-root">shadow root</a>.</li>
</ol></dd>
<dt id="api-shadow-root-style-sheets"><code>styleSheets</code> of type <code>StyleSheetList</code>, readonly</dt>
<dd>Represents the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return a <code>StyleSheetList</code> sequence containing the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.
</dd>
</dl>

<p>The <a href="http://www.w3.org/TR/domcore/#dom-node-nodetype"><code>nodeType</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <a href="http://www.w3.org/TR/domcore/#dom-node-document_fragment_node"><code>DOCUMENT_FRAGMENT_NODE</code></a>. Accordingly, the <a href="http://www.w3.org/TR/domcore/#dom-node-nodename"><code>nodeName</code></a> attribute of a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> return <code>"#document-fragment"</code>.</p>

<h4 id="shadow-root-methods"><code>ShadowRoot</code> Methods</h4>

<dl>
<dt id="api-shadow-root-get-element-by-id"><code>getElementById</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementbyid">document.getElementById</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-class-name"><code>getElementsByClassName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbyclassname">document.getElementsByClassName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name"><code>getElementsByTagName</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagname">document.getElementsByTagName</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-get-elements-by-tag-name-ns"><code>getElementsByTagNameNS</code></dt>
<dd><strong>Must</strong> behave exactly like <a href="http://www.w3.org/TR/domcore/#dom-document-getelementsbytagnamens">document.getElementsByTagNameNS</a>, except <a href="#dfn-scoping-constraints">scoped</a> to the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dt id="api-shadow-root-selection"><code>getSelection</code><dt>
<dd>Returns the current selection in the <a href="#dfn-shadow-tree">shadow tree</a>.</dd>
<dd>When invoked, it <strong>must</strong> return the <a href="http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#concept-selection">selection</a> in the <a href="#dfn-shadow-host">shadow host</a>'s tree.</dd>

<dt id="api-shadow-root-element-from-point"><code>elementFromPoint</code></dt>
<dd>Returns an <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> at specified coordinates.
<div class="informative">Eventually, this needs to be part of <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html">CSSOM View Module</a> specification</div>
When invoked, it <strong>must</strong> return result of running the following steps:
<ol>
    <li>If <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a> is not a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
    <li>If either argument is negative, <code>x</code> is greated than the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a> width excluding the size of a rendered scroll bar (if any), or if <code>y</code> is greated than the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a> height excluding the size of a rendered scroll bar (if any), return <strong>null</strong>.</li>
    <li>Let <var>HIT</var> be the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> at coordinates <code>x</code> and <code>y</code> in the <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom-view/Overview.html#viewport">viewport</a>, determined through hit testing</li>
    <li>Let <var>TARGETS</var> be the result of running the <a href="#dfn-retargeting-algorithm">retargeting algorithm</a> with <var>HIT</var> as its argument</li>
    <li>Let <var>TUPLE</var> be the tuple in <var>TARGETS</var>, whose <em>second</em> value is <a href="http://html5.org/specs/dom-parsing.html#context-object">context object</a></li>
    <li>Return <em>first</em> value of <var>TUPLE</var>.</li>
</ol></dd>
<!--
<dt id="api-shadow-root-add-style-sheet"><code>addStyleSheet</code></dt>
<dd>Adds a new <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> to <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.
<div class="informative">
There is a <a href="http://lists.w3.org/Archives/Public/www-style/2012Oct/thread.html#msg491">discussion</a> under way in the <a href="http://www.w3.org/Style/CSS/">CSS WG</a> to make <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> constructable. Once that is the case, this API will change to simply accept a <a href="http://www.w3.org/TR/cssom/#the-cssstylesheet-interface">CSSStyleSheet</a> object.
</div>
</dd>
<dd>When invoked, the method <strong>must</strong> run the following steps:
<ol>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmllinkelement">HTMLLinkElement</a>:
    <ol>
        <li>Follow <a href="http://www.w3.org/TR/cssom/#requirements-on-user-agents-implementing-the-http-link-header">requirements</a> for implementing the HTTP <code>link</code> header with the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol></li>
    <li>If the parameter is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#htmlstyleelement">HTMLStyleElement</a>:
    <ol>
        <li><a href="http://www.w3.org/TR/cssom/#create-a-style-sheet">Create a style sheet</a> with the following properties and the exception that the newly created style sheet <strong>must</strong> be appended to the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>, not <a href="http://www.w3.org/TR/cssom/#document-style-sheets">document style sheets</a>:
        <dl>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-location">style sheet location</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-node">style sheet owner node</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-parent">style sheet parent</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-owner-css-rule">style sheet owner CSS rule</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-media">style sheet media</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-title">style sheet title</a></dt>
            <dd>null</dd>
            <dt><a href="http://www.w3.org/TR/cssom/#style-sheet-alternate-flag">style sheet alternate flag</a></dt>
            <dd>false</dd>
        </dl></li>
        <li>Return the newly created <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> object.</li>
    </ol>
    <li>Otherwise, throw an <a href="http://dom.spec.whatwg.org/#invalidnodetypeerror"><code>InvalidNodeTypeError</code></a>.</li>
</ol></dd>
<dt id="api-shadow-root-remove-style-sheet"><code>removeStyleSheet</code></dt>
<dd>Removes a <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>.</dd>
<dd>When invoked, the method <strong>must</strong> run these steps:
<ol>
    <li>If the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a>, represented by the method parameter exists in the <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a> and was added with <a href="#api-shadow-root-add-style-sheet"><code>addStyleSheet</code></a>:
    <ol>
        <li>Remove the <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> from <a href="#dfn-shadow-root-style-sheets">shadow root style sheets</a>.</li>
        <li>Return the removed <a href="http://www.w3.org/TR/cssom/#style-sheet">style sheet</a> instance.</li>
    </ol></li>
    <li>Otherwise, throw a <a href="http://www.w3.org/TR/domcore/#nomodificationallowederror"><code>NoModificationAllowedError</code></a> exception.</li>
</ol></dd>
-->
</dl>

<p>Invoking the <a href="http://www.w3.org/TR/domcore/#dom-node-clonenode"><code>cloneNode()</code></a> method on a <a href="#api-shadow-root"><code>ShadowRoot</code></a> instance <strong>must</strong> always throw a <a href="http://www.w3.org/TR/domcore/#dom-domexception-data_clone_err"><code>DATA_CLONE_ERR</code></a> exception.</p>


<h3 id="extensions-to-element">Extensions to <code>Element</code> Interface</h3>

<pre><code>
partial interface <a href="http://dom.spec.whatwg.org/#element">Element</a> {
    <a href="#api-shadow-root">ShadowRoot</a> <a href="#api-partial-element-create-shadow-root">createShadowRoot</a>();
    readonly attribute <a href="#api-shadow-root">ShadowRoot</a>? <a href="#api-partial-element-shadow-root">shadowRoot</a>;
    attribute DOMString <a href="#api-partial-element-pseudo">pseudo</a>;
}
</code></pre>

<h4 id="partial-element-attributes">Attributes</h4>

<dl>
<dt><dfn id="api-partial-element-pseudo">pseudo</dfn> of type <code>DOMString</code></dt>
<dd>Represents the <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a>, associated with the <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>.</dd>
<dd>On getting, the attribute <strong>must</strong> return the current <a href="#dfn-custom-pseudo-element-value">custom pseudo-element value</a> or <strong>empty string</strong> if there is no <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> associated with this <a href="http://www.w3.org/TR/domcore/#concept-element">element</a>.</dd>
<dd>On setting, these steps <strong>must</strong> be run:
<ol>
    <li>If the <a href="#dfn-custom-pseudo-element">custom pseudo-element</a>, associated with this <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> already exists, discard it</li>
    <li>If the new value is not <strong>null</strong>, create a new <a href="#dfn-custom-pseudo-element">custom pseudo-element</a> with <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> and the new value as its <a href="#dfn-custom-pseudo-element-value">value</a>.</li>
</ol></dd>
<dt><dfn id="api-partial-element-shadow-root">shadowRoot</dfn> of type <a href="#api-shadow-root"><code>ShadowRoot</code></a><dt>
<dd>Represents the top <a href="#dfn-shadow-tree">shadow tree</a> in the "<a href="#deprecated-dfn-as-rendered">as rendered</a>" structure.</dd>
<dd>On getting, the attribute <strong>must</strong> return the <a href="#dfn-youngest-tree">youngest tree</a> that has the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a> as its <a href="#dfn-shadow-host">shadow host</a>, or <strong>null</strong> if no such <a href="#dfn-shadow-tree">shadow tree</a> is accesible.</dd>
<dd>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a href="#dfn-shadow-tree">shadow trees</a> <strong>must not</strong> be accessible.</dd>
</dl>

<h4 id="partial-element-methods">Methods</h4>

<dl>
<dt><dfn id="api-partial-element-create-shadow-root"><code>createShadowRoot</code></dfn></dt>
<dd>When invoked, these steps <strong>must</strong> be run:
<ol>
  <li>Create a new instance of the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object</li>
  <li>Establish the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a> as the <a href="#dfn-shadow-host">shadow host</a> of the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object</li>
  <li>Add the <a href="#api-shadow-root"><code>ShadowRoot</code></a> object at the top of the <a href="#dfn-tree-stack">tree stack</a> of its <a href="#dfn-shadow-host">host</a></li>
  <li>Return <a href="#api-shadow-root"><code>ShadowRoot</code></a> object.</li>
</ol></dd>
</dl>


<h3 id="css-host-rule-interface"><code>CSSHostRule</code> Interface</h3>

<p>The <code>CSSHostRule</code> represents the <a href="#host-at-rule"><code>@host</code></a> at-rule in a CSS style sheet.</p>

<pre><code>
interface <dfn id="api-css-host-rule">CSSHostRule</dfn> : <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> {
    readonly attribute <a href="http://dev.w3.org/csswg/cssom/#the-cssrulelist-sequence">CSSRuleList</a> <a href="#api-css-host-rule-css-rules">cssRules</a>;
    unsigned long <a href="#api-css-host-rule-insert-rule">insertRule</a>(DOMString rule, unsigned long index);
    void <a href="#api-css-host-rule-delete-rule">deleteRule</a>(unsigned long index);
};
</code></pre>

<h4 id="css-host-rule-attributes"><code>CSSHostRule</code> Attributes</h4>

<dl>
    <dt><dfn id="api-css-host-rule-css-rules"><code>cssRules</code></dfn> of type <a href="http://dev.w3.org/csswg/cssom/#the-cssrulelist-sequence">CSSRuleList</a></dt>
    <dd>Represents the CSS rules in the <code>@host</code> style block</dd>
    <dd>On getting, the attribute <strong>must</strong> return the list of all CSS rules, specified in the <code>@host</code> at-rule, represented by the <a href="http://domparsing.spec.whatwg.org/#context-object">context object</a>.</dd>
</dl>

<h4 id="css-host-rule-methods"><code>CSSHostRule</code> Methods</h4>

<dl>
    <dt><dfn id="api-css-host-rule-insert-rule"><code>insertRule(DOMSTring <em>rule</em>, unsigned long <em>index</em>)</code></dfn></dt>
    <dd>When invoked, the method <strong>must</strong> <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom/Overview.html#insert-a-css-rule">insert a CSS rule</a> <em>rule</em> into the CSS rule list returned by <a href="#api-css-host-rule-css-rules"><code>cssRules</code></a> at <em>index</em>.</dd>
    <dt><dfn id="api-css-host-rule-delete-rule"><code>deleteRule(unsigned long <em>index</em>)</code></dfn></dt>
    <dd>When invoked, the method <strong>must</strong> <a href="http://dvcs.w3.org/hg/csswg/raw-file/tip/cssom/Overview.html#remove-a-css-rule">remove a CSS rule</a> <em>rule</em> from the CSS rule list returned by <a href="#api-css-host-rule-css-rules"><code>cssRules</code></a> at <em>index</em>.</dd>
</dl>

<p>The <code>HOST_RULE</code> type is added to <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> interface.</p>

<pre><code>
partial interface <a href="http://dev.w3.org/csswg/cssom/#the-cssrule-interface">CSSRule</a> {
    const unsigned short <a href="#api-css-rule-host-rule">HOST_RULE</a> = 1001;
};
</code></pre>

<dl>
    <dt><dfn id="api-css-rule-host-rule"><code>HOST_RULE</code></dfn></dt>
    <dd>When the value of the <code>type</code> attribute is <code>HOST_RULE</code>, then the object that implements this interface <strong>must</strong> implement <a href="#api-css-host-rule"><code>CSSHostRule</code></a> interface.</dd>
</dl>

<h3 id="content-element">The <code>content</code> HTML element</h3>

<p>The <dfn id="dfn-content-element"><code>content</code></dfn> HTML element represents a <a href="#dfn-insertion-point">insertion point</a> in the <a href="#dfn-shadow-tree">shadow tree</a>.</p>

<p>If a <code>content</code> HTML element does not satisfy the condition of an <a href="#dfn-insertion-point">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
    <dl>
<!--    <dt id="markup-content-apply-shadow-styles"><code>apply-shadow-styles</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean attribute</a></dt>
    <dd>indicates whether or not the rules in the scoped styles, defined in shadow tree are applied to the <a href="#dfn-shadow-host">shadow host</a>'s children that are inserted in place of this <code>content</code> element. If present, the styles are applied.</dd> -->
    <dt id="markup-content-select"><code>select</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#comma-separated-tokens">set of comma-separated tokens</a></dt>
    <dd>
        represents the <a href="#dfn-matching-criteria">matching criteria</a> for <a href="#dfn-distribution">distributing</a> child <a href="http://www.w3.org/TR/domcore/#concept-node">nodes</a> of the <a href="#dfn-shadow-host">shadow host</a>. Each token <strong>must</strong> be a <a href="http://dev.w3.org/csswg/selectors4/#compound">compound selector</a>.
    </dd>
    <dt id="markup-content-reset-style-inheritance"><code>resetstyleinheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-insertion-point">insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
    </dl>
</dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-content-element">HTMLContentElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {<!--    attribute bool <a href="#api-html-content-element-apply-shadow-styles">applyShadowStyles</a>; -->
    attribute DOMString <a href="#api-html-content-element-select">select</a>;
    attribute boolean <a href="#api-html-content-element-reset-style-inheritance">resetStyleInheritance</a>;
    <a href="http://www.w3.org/TR/domcore/#interface-nodelist">NodeList</a> <a href="#api-html-content-element-get-distributed-nodes">getDistributedNodes</a>();
}
    </code></pre>
    <dl>
    <dt>Attributes</dt>
    <dd>
    <dl>
<!--        <dt id="api-html-content-element-apply-shadow-styles"><code>applyShadowStyles</code> of type <code>bool</code></dt>
        <dd>Must <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-apply-shadow-styles">apply-shadow-styles</a> attribute.</dd> -->
        <dt id="api-html-content-element-select"><code>select</code> of type <code>DOMString</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-select">select</a> attribute.</dd>
        <dt id="api-html-content-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
        <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-content-reset-style-inheritance">resetstyleinheritance</a> attribute.</dd>
    </dl>
    </dd>
    </dl>
    <dl>
        <dt>Methods</dt>
        <dd><dl>
            <dt id="api-html-content-element-get-distributed-nodes"><code>getDistributedNodes</code></dt>
            <dd><strong>Must</strong> return a <a href="http://www.w3.org/TR/domcore/#concept-collection-static">static</a> <a href="http://www.w3.org/TR/domcore/#nodelist"><code>NodeList</code></a> consisting of nodes, currently <a href="#dfn-distribution">distributed</a> into this <a href="#dfn-insertion-point">insertion point</a>.</dd>
        </dl></dd>
    </dl>
</dd>
</dl>


<h3 id="shadow-element">The <code>shadow</code> HTML element</h3>

<p>The <dfn id="dfn-shadow-element"><code>shadow</code></dfn> HTML element represents an <a href="#dfn-shadow-insertion-point">shadow insertion point</a> in a <a href="#dfn-shadow-tree">shadow tree</a>.</p>
<p>If a <code>shadow</code> HTML element does not satisfy the condition of an <a href="#dfn-insertion-point">insertion point</a>, it <strong>must</strong> have the same rendering behavior as the <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlunknownelement"><code>HTMLUnknownElement</code></a>.</p>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#transparent">Transparent</a></dd>
<dt>Children</dt>
<dd>Anything as <a href="#dfn-fallback-content">fallback content</a></dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd>
<dl>
    <dt id="markup-shadow-reset-style-inheritance"><code>resetstyleinheritance</code>, a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-microsyntaxes.html#boolean-attribute">boolean</a> attribute</dt>
    <dd>indicates the state of the <a href="#dfn-reset-style-inheritance">reset-style-inheritance</a> flag for this <a href="#dfn-shadow-insertion-point">shadow insertion point</a>. If present, the value of the flag <strong>must</strong> be set to <strong>true</strong>. Otherwise, the value <strong>must</strong> be set to <strong>false</strong>.</dd>
</dl></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-shadow-element">HTMLShadowElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
    readonly attribute <a href="#api-shadow-root">ShadowRoot</a>? <a href="#api-html-shadow-element-older-shadow-root">olderShadowRoot</a>;
    attribute boolean <a href="#api-html-shadow-element-reset-style-inheritance">resetStyleInheritance</a>;
}
    </code></pre>
    <dl>
        <dt>Attributes</dt>
        <dd><dl>
            <dt id="api-html-shadow-element-older-shadow-root"><code>olderShadowRoot</code> of type <a href="#api-shadow-root"><code>ShadowRoot</code></a></dt>
            <dd>Represents the <a href="#dfn-shadow-tree">shadow tree</a> that is <a href="#deprecated-dfn-as-rendered">rendered</a> in place of this <a href="#dfn-shadow-insertion-point">shadow insertion point</a></dd>
            <dd>On getting, the attribute <strong>must</strong> return a result that is <a href="#dfn-processing-equivalence">equivalent</a> to running the following steps:
            <ol>
                <li>Let <var>TREE</var> be the <a href="#dfn-shadow-tree">shadow tree</a> that contains the <a href="http://www.w3.org/TR/domcore/#context-object">context object</a></li>
                <li>If <var>TREE</var> does not exist, return <strong>null</strong>.</li>
                <li>If <a href="http://www.w3.org/TR/domcore/#context-object">context object</a>, in <a href="http://www.w3.org/TR/domcore/#concept-tree-order">tree order</a>, is not the first <a href="#dfn-active-insertion-point">active</a> instance of <a href="#dfn-shadow-element"><code>shadow</code></a> element in <var>TREE</var>, return <strong>null</strong>.</li>
                <li>Let <var>HOST</var> be the <a href="#dfn-shadow-host">shadow host</a> of <var>TREE</var></li>
                <li>From <var>HOST</var>'s <a href="#dfn-tree-stack">tree stack</a>, return the <a href="#dfn-older-tree">older tree</a> relative to <var>TREE</var>, or <strong>null</strong> if no such <a href="#dfn-shadow-tree">shadow tree</a> is accessible.</li>
            </ol></dd>
            <dd>For <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#semantics">HTML elements</a>, the <a href="#html-elements-and-their-shadow-trees">UA-provided</a> <a href="#dfn-shadow-tree">shadow trees</a> <strong>must not</strong> be accessible.</dd>
            <dt id="api-html-shadow-element-reset-style-inheritance"><code>resetStyleInheritance</code> of type <code>boolean</code></dt>
            <dd><strong>Must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#markup-shadow-reset-style-inheritance">resetstyleinheritance</a> attribute.</dd>
        </dl></dd>
    </dl>
</dd>
</dl>

<h3 id="extensions-to-event">Extensions to <code>Event</code> Interface</h3>

<pre><code>
partial interface <a href="http://dom.spec.whatwg.org/#event">Event</a> {
    readonly attribute <a href="http://www.w3.org/TR/domcore/#interface-nodelist">NodeList</a> <a href="#api-partial-event-path">path</a>;
}
</code></pre>

<h4 id="partial-event-attributes">Attributes</h4>
<dl>
<dt><dfn id="api-partial-event-path">path</dfn> of type <a href="http://www.w3.org/TR/dom/#interface-nodelist"><code>NodeList</code></a></dt>
<dd>Represents the adjusted event path.</dd>
<dd>To enforce upper-boundary encapsulation, some nodes must be excluded from the event path, depending on the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listeners</a> would be invoked.</dd>
<dd>On getting, the attribute <strong>must</strong> return a result that is <a href="#dfn-processing-equivalence">equivalent</a> to running the following steps:

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>PATH</var>, a populated event path with <a href="#dfn-adjusted-parent">adjusted parents</a></dd>
    <dd><var>NODE</var>, the <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> on which event listeners would be invoked</dd>
<dt>Output</dt>
    <dd><var>RESULT</var>, an adjusted event path</dd>
</dl>
<ol>
    <li>Let <var>TREE1</var> be the <a href="http://www.w3.org/TR/domcore/#concept-tree">tree</a> that contains <var>NODE</var></li>
    <li>Let <var>RESULT</var> be the empty list</li>
    <li>For each item <var>NODE2</var> in <var>PATH</var>, repeat these steps:
        <ol>
            <li>Let <var>TREE2</var> be the <a href="http://www.w3.org/TR/domcore/#concept-tree">tree</a> that contains <var>NODE2</var></li>
            <li>If <var>TREE1</var> and <var>TREE2</var> are the same, push <var>NODE2</var> to <var>RESULT</var></li>
            <li>Otherwise, if <var>TREE1</var> is <a href="#deprecated-dfn-enclosed-tree">enclosed</a> by <var>TREE2</var>, push <var>NODE2</var> to <var>RESULT</var></li>
        </ol></li>
    </li>
</ol>
</div>
<p>These steps <strong>must</strong> run prior to invoking <a href="http://dom.spec.whatwg.org/#concept-event-listener">event listeners</a> on any <a href="http://www.w3.org/TR/domcore/#concept-node">node</a> in <var>PATH</var>.</p>
</dd>
</dl>

<h2 id="shadow-dom-example">Shadow DOM Example</h2>

<p>Bob was asked to turn a simple list of links into a News Widget, which has links organized into two categories: breaking news and just news. The current document markup for the stories looks like this:</p>
<pre class="prettyprint"><code>
&lt;ul class=&quot;stories&quot;&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/1&quot;&gt;A story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/2&quot;&gt;Another story&lt;/a&gt;&lt;/li&gt;
    &lt;li class=&quot;breaking&quot;&gt;&lt;a href=&quot;//example.com/stories/3&quot;&gt;Also a story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/4&quot;&gt;Yet another story&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;//example.com/stories/4&quot;&gt;Awesome story&lt;/a&gt;&lt;/li&gt;
    &lt;li class=&quot;breaking&quot;&gt;&lt;a href=&quot;//example.com/stories/5&quot;&gt;Horrible story&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre>

<p>To organize the stories, Bob decides to use <strong>shadow DOM</strong>. Doing so will allow Bob to keep the document markup uncluttered, and harnessing the power of insertion point makes sorting stories by class name a very simple task. After getting another cup of <a href="http://en.wikipedia.org/wiki/List_of_coffee_beverages#Green_Eye">Green Eye</a>, he quickly mocks up the following shadow tree, to be hosted by the <code>ul</code> element:</p>
<pre class="prettyprint"><code>
&lt;div class=&quot;breaking&quot;&gt;
    &lt;ul&gt;
        &lt;content select=&quot;.breaking&quot;&gt;&lt;/content&gt; &lt;!-- insertion point for breaking news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;other&quot;&gt;
    &lt;ul&gt;
        &lt;content&gt;&lt;/content&gt; &lt;!-- insertion point for the rest of the news --&gt;
    &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<p>Bob then styles the newborn widget according to comps from the designer by adding this to the shadow tree mockup:</p>
<pre class="prettyprint"><code>
&lt;style&gt;
    div.breaking {
        color: Red;
        font-size: 20px;
        border: 1px dashed Purple;
    }
    div.other {
        padding: 2px 0 0 0;
        border: 1px solid Cyan;
    }
&lt;/style&gt;
</code></pre>
<p>While pondering if his company should start looking for a new designer, Bob converts the mockup to code:</p>
<pre class="prettyprint"><code>
function createStoryGroup(className, contentSelector)
{
    var group = document.createElement('div');
    group.className = className;
    // Empty string in select attribute or absence thereof work the same, so no need for special handling.
    group.innerHTML = '&lt;ul&gt;&lt;content select=&quot;' + contentSelector + '&quot;&gt;&lt;/content&gt;&lt;/ul&gt;';
    return group;
}

function createStyle()
{
    var style = document.createElement('style');
    style.textContent = 'div.breaking { color: Red;font-size: 20px; border: 1px dashed Purple; }' +
        'div.other { padding: 2px 0 0 0; border: 1px solid Cyan; }';
    return style;
}

function makeShadowTree(storyList)
{
    var root = storyList.createShadowRoot();
    root.appendChild(createStyle());
    root.appendChild(createStoryGroup('breaking', '.breaking'));
    root.appendChild(createStoryGroup('other', ''));
}

document.addEventListener('DOMContentLoaded', function() {
    [].forEach.call(document.querySelectorAll('ul.stories'), makeShadowTree);
});
</code></pre>

<p>Well done, Bob! With the cup of coffee still half-full, the work is complete. Recognizing his awesomeness, Bob returns to teaching n00bs the ways of <a href="http://en.wikipedia.org/wiki/World_of_Warcraft">WoW</a>.</p>

<p>A few months pass.</p>

<p>It's election time. With Bob at his annual conference, Alice is charged with adding <strong>another</strong>, temporary box to the news widget, filled with election-related stories. Alice studies Bob's code, reads up on the shadow DOM spec and realizes that, thanks to multiple shadow tree support, she doesn't have to touch his code. As usual, her solution is elegant and simple, fitting neatly right under Bob's code:</p>
<pre class="prettyprint"><code>
// TODO(alice): BEGIN -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.
var ELECTION_BOX_REMOVAL_DEADLINE = ...;

function createElectionStyle()
{
    var style = document.createElement('style');
    // TODO(alice): Check designer's desk for hallucinogens.
    style.textContent = 'div.election { color: Magenta;font-size: 24px; border: 2px dotted Fuchsia; }';
    return style;
}

function makeElectionShadowTree(storyList)
{
    var root = storyList.createShadowRoot();
    // Add and style election story box.
    root.appendChild(createElectionStyle());
    root.appendChild(createStoryGroup('election', '.election'));
    // Insert Bob's shadow tree under the election story box.
    root.appendChild(document.createElement('shadow'));
}

if (Date.now() &lt; ELECTION_BOX_REMOVAL_DEADLINE) {
    document.addEventListener('DOMContentLoaded', function() {
        [].forEach.call(document.querySelectorAll('ul.stories'), makeElectionShadowTree);
    });
}
// TODO(alice): END -- DELETE THIS CODE AFTER ELECTIONS ARE OVER.
</code></pre>
<p>Using the <code>shadow</code> element allows Alice to compose Bob's widget <strong>inside</strong> of hers&mdash;without having to change a line of production code. Smiling to herself, Alice realizes that Bob may have come up with a way to keep the document markup clean, but <strong>she</strong> is the one who takes the cake for using shadow tree composition in such a cool way.</p>

<div class="deprecated">

<h2 id="shadow-trees">Shadow Trees</h2>

<p>To solve this problem at its core, a new abstraction is introduced. The <dfn id="deprecated-dfn-shadow-dom">shadow DOM</dfn> allows multiple <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees (in addition to the <a href="#dfn-document-tree">document tree</a>) to be composed into one larger <a href="http://www.w3.org/TR/domcore/#trees">tree</a> when rendered. The existence of multiple <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees is enabled by letting any <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in the <a href="#dfn-document-tree">document tree</a> to host one or more additional <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees. These <dfn id="deprecated-dfn-shadow-tree">shadow trees</dfn> are governed by a set of rules that establish encapsulation <a href="#dfn-boundary">boundaries</a> while retaining the standard <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> composability semantics.</p>

<p>The encapsulation <a href="#dfn-boundary">boundaries</a> between the <a href="#dfn-document-tree">document tree</a> and <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="deprecated-dfn-shadow-boundary">shadow boundaries</dfn>. The <a href="http://www.w3.org/TR/domcore/#concept-element">elements</a> that host <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="deprecated-dfn-shadow-host">shadow hosts</dfn>, and the <a href="http://www.w3.org/TR/domcore/#concept-tree-root">roots</a> of the <a href="#dfn-shadow-tree">shadow trees</a> are called <dfn id="deprecated-dfn-shadow-root">shadow roots</dfn>.</p>

<object data="../../assets/images/shadow-trees.svg" width="800" height="430"></object>

<p>When rendered, the <a href="#dfn-shadow-tree">shadow tree</a> takes place of the <a href="#dfn-shadow-host">shadow host</a>'s content.</p>

<object data="../../assets/images/shadow-rendering.svg" width="450" height="400"></object>

<p>To enable composition of <a href="#dfn-shadow-host">shadow host</a>'s children and the <a href="#dfn-shadow-tree">shadow tree</a>, a notion of insertion points is added to the abstraction. An <dfn id="deprecated-dfn-insertion-point">insertion point</dfn> is a defined location in the <a href="#dfn-shadow-tree">shadow tree</a>, to which the <a href="#dfn-shadow-host">shadow host</a>'s children are transposed when rendering. The mechanism that determines which <a href="#dfn-shadow-host">shadow host</a>'s children are transposed into which <a href="#dfn-insertion-point">insertion points</a> is called <dfn id="deprecated-dfn-distribution">distribution</dfn>.</p>

<object data="../../assets/images/insertion-points.svg" width="800" height="900"></object>

<p>Thus, the encapsulation of a <a href="#dfn-shadow-tree">shadow tree</a> can be viewed as a two-fold problem:
<ol>
    <li>the <dfn id="deprecated-dfn-upper-boundary-encapsulation">upper-boundary encapsulation</dfn>, or governing the boundary between the shadow root and the shadow host; and</li>
    <li>the <dfn id="deprecated-dfn-lower-boundary-encapsulation">lower-boundary encapsulation</dfn>, or governing the boundary between the insertion points and the shadow host's children.</li>
</ol>
</p>

<h3 id="nested-shadow-trees">Nested Shadow Trees</h3>

<p>Any <a href="http://www.w3.org/TR/domcore/#concept-element">element</a> in a <a href="#dfn-shadow-tree">shadow tree</a> can be a <a href="#dfn-shadow-host">shadow host</a>, thus producing nested <a href="#dfn-shadow-tree">shadow trees</a>. A <a href="#dfn-shadow-tree">shadow tree</a> is <dfn id="deprecated-dfn-nested-tree">nested</dfn> when its <a href="#dfn-shadow-host">shadow host</a> is itself a part of a <a href="#dfn-shadow-tree">shadow tree</a>. Conversely, a <a href="#dfn-shadow-tree">shadow tree</a> <em>A</em> is said to be <dfn id="deprecated-dfn-nesting-tree">nesting</dfn> the <a href="#dfn-shadow-tree">shadow tree</a> <em>B</em> if <em>B</em> is <a href="#dfn-nested-tree">nested</a> by <em>A</em>. If a <a href="#dfn-shadow-host">shadow host</a> is declared in the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> is the <a href="#deprecated-dfn-nesting-tree">nesting</a> <a href="http://www.w3.org/TR/domcore/#trees">tree</a> of its <a href="#dfn-shadow-tree">shadow trees</a>.</p>

<p>A <a href="#dfn-shadow-tree">shadow tree</a> is <dfn id="deprecated-dfn-enclosed-tree">enclosed</dfn> by another <a href="#dfn-shadow-tree">shadow tree</a> when the enclosing <a href="http://www.w3.org/TR/domcore/#trees">tree</a> nests the enclosed <a href="http://www.w3.org/TR/domcore/#trees">tree</a> through one or more levels of nesting. All <a href="#dfn-shadow-tree">shadow trees</a> are <a href="#deprecated-dfn-enclosed-tree">enclosed</a> by the <a href="#dfn-document-tree">document tree</a>.</p>

<h3 id="rendering-shadow-trees">Rendering Shadow Trees</h3>

<p>This process of <a href="#dfn-rendering">rendering</a> produces a structure that is a composition of several <a href="http://www.w3.org/TR/domcore/#introduction-to-the-dom">DOM</a> trees, including the <a href="#dfn-document-tree">document tree</a>. The term "<dfn id="deprecated-dfn-as-rendered">as rendered</dfn>" is used to refer to this structure.</p>

</div>

<div class="fixme">Remove this deprecated parts after the refactoring is finished.</div>

<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of functional encapsulation and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of shadow DOM and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem of functional encapsulation within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Brandon Payton</span>, <span class="vcard">Brian Kardell</span>, <span class="vcard">Darin Fisher</span>, <span class="vcard">Eric Bidelman</span>, <span class="vcard">Deepak Sherveghar</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Elisée Maurer</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Glenn Adams</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Malte Ubl</span>, <span class="vcard">Mike Taylor</span>, <span class="vcard">Oliver Nightingale</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Richard Bradshaw</span>, <span class="vcard">Ruud Steltenpool</span>, <span class="vcard">Sam Dutton</span>, <span class="vcard">Sergey G. Grekhov</span>, <span class="vcard">Shinya Kawanaka</span>, <span class="vcard">Tab Atkins</span>, <span class="vcard">Takashi Sakamoto</span>, and <span class="vcard">Yoshinori Sano</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</body>
</html>
