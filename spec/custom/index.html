<!DOCTYPE html>
<html lang="en">
<head>
<title>Custom DOM Elements</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="../../assets/styles/spec.css" type="text/css">
<link rel="stylesheet" href="../../assets/styles/prettify.css" type="text/css">
<link rel="stylesheet" href="http://www.w3.org/StyleSheets/TR/W3C-ED" type="text/css" >
<script src="../../assets/scripts/bug-assist.js"></script>
<script src="../../assets/scripts/spec-assist.js"></script>
<script src="../../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="14968">
<meta name="bug.short_desc" content="[Custom]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>Custom DOM Elements</h1>
<h2 id="editors-draft">W3C Editor's Draft</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/custom/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/custom/index.html</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/custom/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/custom/index.html</a></dd>
<dt>Previous version</dt>
    <dd>none</dd>
<dt>Revision history</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/log/tip/spec/custom/index.html">http://dvcs.w3.org/hg/webcomponents/log/tip/spec/custom/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=14968&amp;short_desc=%5BCustom%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editor</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy; 2012 <a href="http://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>&copy;</sup> (<a href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="http://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. <abbr title="World Wide Web Consortium">W3C</abbr> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method of establishing and maintaining functional boundaries between DOM subtrees and how these subtrees interact with each other within a document tree, thus enabling better functional encapsulation within DOM.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as an Editor's Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as an Editor's Draft does not imply endorsement by the <abbr title="World Wide Web Consortium">W3C</abbr> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="http://www.w3.org/2004/01/pp-impl/45559/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2 id="toc">Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#terminology"><span class="section">3</span> Terminology</a></li>
    <li><a href="#introduction"><span class="section">4</span> Introduction</a></li>
    <li><a href="#declaring-custom-elements"><span class="section">5</span> Declaring Custom DOM Elements</a></li>
    <li><a href="#serializing-and-parsing"><span class="section">6</span> Serializing and Parsing Custom DOM Elements in HTML</a></li>
    <li><a href="#unknown-element-pseudoclass"><span class="section">7</span> Unknown Element Pseudoclass</a></li>
    <li><a href="#event-definitions"><span class="section">8</span> Event Definitions</a></li>
    <li><a href="#elements-and-dom-interfaces"><span class="section">9</span> Elements and DOM Interfaces</a>
    <ol>
        <li><a href="#extensions-to-document-interface"><span class="section">9.1</span> Extensions to <code>Document</code> interface</a></li>
        <li><a href="#the-element-element"><span class="section">9.2</span> The <code>element</code> HTML element</a></li>
    </ol></li>
    <li><a href="#other-languages"><span class="section">10</span> Other Languages</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about">About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
<ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/CSS2/">CSS Level 2 Revision 1</a></li>
    <li><a href="http://dev.w3.org/csswg/cssom/">CSSOM</a></li>
    <li><a href="http://www.w3.org/TR/DOM-Level-3-Events/">DOM Level 3 Events</a></li>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
    <li><a href="http://ecma-international.org/ecma-262/5.1/">ECMAScript Language Specification</a></li>
    <li><a href="http://www.w3.org/TR/selectors/">Selectors Level 3</a></li>
    <li><a href="http://dev.w3.org/2006/webapi/selectors-api/">Selectors API Level 1</a></li>
    <li><a href="http://www.w3.org/TR/shadow-dom/">Shadow DOM</a></li>
    <li><a href="http://www.w3.org/TR/WebIDL/">Web IDL</a></li>
</ul>

<h2 id="terminology">Terminology</h2>

<p>The following terms are used throughout the specification:

<dl>
<dt>DOM</dt>
    <dd>The <a href="http://www.w3.org/TR/domcore/">document object model</a></dd>
<dt>document</dt>
    <dd>The Document Object Model's underlying document</dd>
<dt>node</dt>
    <dd>Any DOM object that <a href="http://www.w3.org/TR/domcore/#concept-tree-participate">participates in a tree</a></dd>
<dt>DOM tree</dt>
    <dd>Any <a href="http://www.w3.org/TR/domcore/#trees">tree</a>, composed of DOM objects</dd>
<dt>DOM structure</dt>
    <dd>A DOM tree or fragment of a DOM tree</dd>
<dt>JavaScript</dt>
    <dd>The term "JavaScript" is used to refer to ECMA262, rather than the official term ECMAScript, since the term JavaScript is more widely known.</dd>
</dl>

</section>

<section class="physics">

<h2 id="introduction">Introduction</h2>

<p><dfn id="dfn-custom-dom-element">Custom DOM elements</dfn> are new types of <a href="http://www.w3.org/TR/domcore/#interface-element">elements</a>. The <a href="http://www.w3.org/TR/WebIDL/#dfn-interface">interfaces</a> for these elements <strong>must</strong> be defined as <a href="http://www.w3.org/TR/WebIDL/#interface-prototype-object">interface prototype objects</a>, called <dfn id="dfn-element-prototype">element prototypes</dfn>. The <a href="#dfn-element-prototype">element prototype</a> itself <strong>must</strong> <a href="http://www.w3.org/TR/WebIDL/#dfn-inherit">inherit</a> from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement"><code>HTMLElement</code></a> <a href="http://www.w3.org/TR/WebIDL/#dfn-interface">interface</a>.</p>

<p>When created, new instances of <a href="#dfn-custom-dom-element">custom DOM elements</a> are given an opportunity to create a <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-dom-subtree">shadow DOM subtree</a> which it <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-host">hosts</a>. The <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-dom-subtree">shadow DOM subtree</a> is populated by cloning an <a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html#dfn-template">HTML template</a>, which is called the <dfn id="dfn-custom-element-template">custom element template</dfn>.

<p>After a new instance of a <a href="#dfn-custom-dom-element">custom DOM Element</a> is created, the author of the element can optionally provide a set of callbacks to have monitor the state of the element throughout its lifecycle. This set of callbacks is stored in a <a href="http://www.w3.org/TR/WebIDL/#dfn-dictionary">dictionary</a> that is called <dfn id="dfn-lifecycle-callbacks">lifecycle callbacks</dfn>.

<p>The <dfn id="dfn-custom-element-name">custom element name</dfn> is an <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/syntax.html#syntax-tag-name">HTML tag name</a>, which is used to identify a <a href="#dfn-custom-dom-element">custom DOM element</a>. The <a href="#dfn-custom-element-name">custom element name</a> <strong>must</strong> start with a <var>U+0078 LATIN SMALL LETTER X</var>, followed by <var>U+002D HYPHEN-MINUS</var>. For an element or token, the <a href="#dfn-custom-element-name">custom element name</a> is the element's tag name. An element or token is considered <dfn id="dfn-custom-element-matchable">matchable</dfn> if and only if its tag name is a <a href="#dfn-custom-element-name">custom element name</a>.</p>

<p>The <dfn id="dfn-element-definition">element definition</dfn> is an association between an <a href="#dfn-element-prototype">element prototype</a>, a <a href="#dfn-custom-element-name">custom element name</a>, and optionally, a <a href="#dfn-custom-element-template">custom element template</a> and <a href="#dfn-lifecycle-callbacks">lifecycle callbacks</a>.</p>

<p><span id="dfn-invalid-definition" class="fixme">Specify invalid definition state</span></p>

<p><dfn id="dfn-element-registration">Element registration</dfn> is a process of associating an <a href="#dfn-element-definition">element definition</a> with a <a href="http://www.w3.org/TR/domcore/#concept-document">document</a>.</p>

<p>A new instance of a <a href="#dfn-custom-dom-element">custom DOM element</a> <strong>must</strong> be created with the <dfn id="dfn-custom-element-instantiation">custom element instantiation algorithm</dfn>, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to running these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>PROTOTYPE</var>, the <a href="#dfn-element-prototype">element prototype</a></dd>
<dt>Output</dt>
    <dd><var>ELEMENT</var>, the DOM element</dd>
</dl>
<ol>
    <li><a href="http://ecma-international.org/ecma-262/5.1/#sec-15.2.3.5">Create</a> a new object that implements <var>PROTOTYPE</var></li>
    <li>Let <var>ELEMENT</var> be this new object</li>
    <li>Let <var>CHAIN</var> be <var>ELEMENT</var>'s <a href="http://ecma-international.org/ecma-262/5.1/#sec-4.2.1">prototype chain</a>, in reverse order (starting with at the top of the prototype chain)</li>
    <li><dfn id="algo-chain-iteration">For each</dfn> item in <var>CHAIN</var>:
    <ol>
        <li>Let <var>ITEM</var> be this item</li>
        <li>Let <var>DEFINITION</var> be a <a href="#dfn-element-registration">registered</a> <a href="#dfn-element-definition">element definition</a> that has <var>ITEM</var> as <a href="#dfn-element-prototype">element prototype</a>.</li>
        <li>If <var>DEFINITION</var> was not found, <strong>stop.</strong></li>
        <li>If <var>DEFINITION</var> has <a href="#dfn-custom-element-template">element template</a>:
        <ol>
            <li>Let <var>TEMPLATE</var> be this template</li>
            <li>Create a <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-root">shadow root</a> with <var>ELEMENT</var> as its <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-host">host</a></li>
            <li><a href="http://www.w3.org/TR/domcore/#dom-node-clonenode">Clone</a> <var>TEMPLATE</var> as contents of this <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-root">shadow root</a></li>
        </ol></li>
    </ol>
</ol>
</div>
<p>Some user agents treat DOM objects as special, hybrid entities. They exist in JavaScript environment only as thin <a href="http://en.wikipedia.org/wiki/Adapter_pattern">wrappers</a> that hide some monolothic implementation of the object. In such user agents, the <a href="#dfn-custom-element-instantiation">custom element instantiation algorithm</a> <strong>must</strong> also ensure that the output is a valid DOM element with the proper wrapper in place.</p>

<p>All <a href="#dfn-custom-dom-element">custom DOM elements</a> <strong>must</strong> be constructable with a <a href="http://www.w3.org/TR/WebIDL/#dfn-function-object">function object</a>, called <dfn id="dfn-custom-element-constructor">custom element constructor</dfn>. This constructor <strong>must</strong> be created with the <dfn id="dfn-custom-element-constructor-generation">custom element constructor generation algorithm</dfn>, which <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to running these steps:</p>
<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>PROTOTYPE</var>, the <a href="#dfn-element-prototype">element prototype</a>.</dd>
<dt>Output</dt>
    <dd><var>CONSTRUCTOR</var>, the <a href="#dfn-custom-element-constructor">custom element constructor</a></dd>
</dl>
<ol>
    <li>Generate a <a href="http://www.w3.org/TR/WebIDL/#dfn-function-object">function object</a> which, when called:
    <ol>
        <li>Runs the <a href="#dfn-custom-element-instantiation">custom element instantiation algorithm</a> with <var>PROTOTYPE</var> as argument</li>
        <li>Returns algorithm's output as result</li>
    </ol></li>
    <li>Let <var>CONSTRUCTOR</var> be that <a href="http://www.w3.org/TR/WebIDL/#dfn-function-object">function object</a></li>
    <li>Set <var>PROTOTYPE</var> as the <code>prototype</code> property on <var>CONSTRUCTOR</var></li>
    <li>Set <var>CONSTRUCTOR</var> as the <code>constructor</code> property on <var>PROTOTYPE</var>.</li>
</ol>
</div>

<h2 id="declaring-custom-elements">Declaring Custom DOM Elements</h2>

<p><span class="fixme">Specify how custom DOM elements are defined declaratively</span></p>

<p>The <dfn id="dfn-element-upgrade">element upgrade algorithm</dfn> <strong>must</strong> be <a href="#dfn-processing-equivalence">equivalent</a> to running these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>TREE</var>, a DOM tree</dd>
    <dd><var>DEFINITION</var>, an <a href="#dfn-element-defintion">element definition</a></dd>
<dt>Output</dt>
    <dd><var>TREE</var> in a new state</dd>
</dl>
<ol>
    <li>Let <var>NAME</var> be the <a href="#dfn-custom-element-name">custom element name</a> part of <var>DEFINITION</var></li>
    <li>For each element <var>ELEMENT</var> in <var>TREE</var> whose <a href="#dfn-custom-element-name">custom element name</a> is <var>NAME</var>:
    <ol>
        <li>Let <var>PROTOTYPE</var> be the <a href="#dfn-element-prototype">element prototype</a> in <var>DEFINITION</var></li>
        <li>Let <var>UPGRADE</var> be the result of running <a href="#dfn-custom-element-instantiation">custom element instantiation algorithm</a> with <var>PROTOTYPE</var> as argument</li>
        <li>Let <var>REFERENCE</var> be the next sibling of <var>ELEMENT</a></li>
        <li>Let <var>PARENT</var> be the parent of <var>ELEMENT</var></li>
        <li><a href="http://www.w3.org/TR/domcore/#concept-node-remove">Remove</a> <var>ELEMENT</var> from <var>PARENT</var> with <em>suppress observers flag</em> set</li>
        <li>Let <var>CHILDREN</var> be the list of all child nodes of <var>ELEMENT</var>
        <li>For each item in <var>CHILDREN</var>:
        <ol>
            <li>Let <var>CHILD</var> be this item</li>
            <li><a href="http://www.w3.org/TR/domcore/#concept-node-append">Append</a> <var>CHILD</var> to <var>UPGRADE</var></li>
        </ol></li>
        <li>Let <var>ATTRIBUTES</var> be <var>ELEMENT</var>'s <a href="http://www.w3.org/TR/domcore/#concept-element-attribute">attribute list</a></li>
        <li>For each item in <var>ATTRIBUTES</var>:
        <ol>
            <li>Let <var>ATTRIBUTE</var> be this item</li>
            <li>Append <var>ATTRIBUTE</var> to <var>UPGRADE</var>'s <a href="http://www.w3.org/TR/domcore/#concept-element-attribute">attribute list</a></li>
        </ol></li>
        <li><a href="">Insert</a> <var>UPGRADE</var> into <var>PARENT</var> before <var>REFERENCE</var> with <em>suppress observers flag</em> set</li>
        <li><a href="http://www.w3.org/TR/domcore/#concept-node-replace">Replace</a> <var>ELEMENT</var> with <var>UPGRADE</var> in <var>TREE</var></li>
        <li>If <var>DEFINITION</var> contains <a href="#dfn-lifecycle-callbacks">lifecycle callbacks</a>:
        <ol>
            <li>Let <var>CREATED</var> be the callback, corresponding to the <em>created</em> key in <a href="#dfn-lifecycle-callbacks">lifecycle callbacks</a> dictionary</li>
            <li>If <var>CREATED</var> exists:
            <ol>
                <li>Call <var>CREATE</var> callback with <a href="http://www.w3.org/TR/WebIDL/#dfn-callback-this-value">callback this value</a> of <var>UPGRADE</var></li>
            </ol></li>
        </ol></li>
        <li>On <var>ELEMENT</var>, <a href="http://www.w3.org/TR/domcore/#concept-event-fire">fire</a> an <a href="#api-element-replace-event"><code>ElementReplaceEvent</code></a> event, initialized with values <em>upgrade</em> as <var>UPGRADE</var> and <em>bubbles</em> as <code>false</code>.</li>
        <li>On <var>UPGRADE</var>, <a href="http://www.w3.org/TR/domcore/#concept-event-fire">fire an event</a> named <code>elementupgrade</code> with its <code>bubbles</code> attribute set to <code>true</code>.</li>
    </ol></li>
</ol>
</div>

<p>The <a href="#dfn-element-upgrade">element upgrade algorithm</a> <strong>must not</strong> <a href="http://www.w3.org/TR/domcore/#concept-MO-queue">queue</a> any observer records</a>.

<h2 id="serializing-and-parsing">Serializing and Parsing Custom DOM Elements in HTML</h2>

<p>When <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#create-an-element-for-the-token">creating an element for a token</a>, a conforming UA <strong>must</strong> first check if the token is <a href="#dfn-custom-element-matchable">matchable</a>. If so, it <strong>must</strong> run the following steps instead:

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>DOCUMENT</var>, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> in which the element is being created</dd>
    <dd><var>TOKEN</var>, the token</dd>
    <dd><var>NAME</var>, <a href="#dfn-custom-element-name">custom element name</a> of the token</dd>
<dt>Output</dt>
    <dd><var>ELEMENT</var>, an element</dd>
</dl>
<ol>
    <li>Let <var>DEFINITION</var> be the <a href="#dfn-element-defintion">element defintion</a> with the <a href="#dfn-custom-element-name">custom element name</a> of <var>NAME</var> that is <a href="#dfn-element-registration">registered</a> with <var>DOCUMENT</var></li>
    <li>If <var>DEFINTION</var> is missing, let <var>ELEMENT</var> be the result of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#create-an-element-for-the-token">creating an element for token</a>.</li>
    <li>Otherwise:
    <ol>
        <li>Let <var>PROTOTYPE</var> be the <a href="#dfn-element-prototype">element prototype</a> in <var>DEFINITION</var></li>
        <li>If <var>PROTOTYPE</var> does not <a href="http://www.w3.org/TR/WebIDL/#dfn-inherit">inherit</a> from the the <a href="http://www.w3.org/TR/WebIDL/#dfn-interface-prototype-object">interface prototype object</a> for the <a href="http://www.w3.org/TR/domcore/#interface-element">element</a> type corresponding to the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/syntax.html#syntax-tag-name">HTML tag name</a> of <var>TOKEN</var>, let <var>ELEMENT</var> be the result of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#create-an-element-for-the-token">creating an element for token</a>.</li>
        <li>Otherwise, return result of running the <a href="#dfn-custom-element-instantiation">custom element instantiation algorithm</a> with <var>PROTOTYPE</var> as argument.</li>
    </ol></li>
</ol>
</div>

<div class="informative">
<p>This modification to <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/tree-construction.html#create-an-element-for-the-token">creating an element for a token</a> has the following consequences:</p>
<ul>
    <li>The <a href="#dfn-custom-dom-element">custom DOM elements</a> are created when <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#parsing">parsing HTML documents</a></li>
    <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#parsing">Parsing HTML documents</a> could trigger creation of a <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-root">shadow root</a> and instantiation of a <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-dom-subtree">shadow DOM subtree</a></li>
</ul>
</div>

<p>The <a href="#dfn-custom-dom-element">custom DOM elements</a> <strong>must</strong> be serialized like <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-end.html#serializing-html-fragments">any HTML elements</a>.</p>

</section>

<section class="mechanics">

<h2 id="unknown-element-pseudoclass">Unknown Element Pseudoclass</h2>

<p>The <code>:unknown</code> <a href="http://www.w3.org/TR/CSS2/selector.html#pseudo-elements">pseudoclass</a> <strong>must</strong> match any element that has the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlunknownelement"><code>HTMLUnknownElement</code></a> interface.</p>

<div class="informative">
<p>Since the <a href="#dfn-element-definition">definitions</a> for <a href="#dfn-custom-dom-element">custom DOM elements</a> may become available after the element is inserted in the document, the <code>:unknown</code> <a href="http://www.w3.org/TR/CSS2/selector.html#pseudo-elements">pseudoclass</a> could be used to mitigate the <a href="http://en.wikipedia.org/wiki/Flash_of_unstyled_content">Flash of Unstyled Content</a> (FOUC) issues with <a href="#dfn-custom-dom-element">custom DOM elements</a>.
</div>

<h2 id="event-definitions">Event Definitions</h2>

<p>The <code>elementreplace</code> event is fired when an element is being replaced with an <a href="#dfn-element-upgrade">upgraded</a> element.</p>

<pre><code>
[Constructor(DOMString type, optional <a href="#api-element-replace-event-init">ElementReplaceEventInit</a> eventInitDict)]
interface <dfn id="api-element-replace-event">ElementReplaceEvent</dfn> : <a href="http://www.w3.org/TR/dom/#event">Event</a> {
    readonly attribute <a href="http://www.w3.org/TR/dom/#element">Element</a> upgrade;
};

dictionary <dfn id="api-element-replace-event-init">ElementReplaceEventInit</dfn> : <a href="http://www.w3.org/TR/dom/#eventinit">EventInit</a> {
    <a href="http://www.w3.org/TR/dom/#element">Element</a> <dfn id="#api-element-replace-event-upgrade">upgrade</dfn>;
}
</code></pre>

<p>The <a href="#api-element-replace-event-upgrade"><code>upgrade</code></a> attribute holds the <a href="#dfn-element-upgrade">upgraded</a> element and <strong>must</strong> return the value it was initialized to. When the object is created, this attribute <strong>must</strong> be initialized to <strong>null</strong>.</p>

<h2 id="elements-and-dom-interfaces">Elements and DOM Interfaces</h2>

<h3 id="extensions-to-document-interface">Extensions to <code>Document</code> interface</h3>

<pre><code>
partial interface <a href="http://www.w3.org/TR/domcore/#document">Document</a> {
    Function <a href="#dfn-document-register">register</a>(DOMString <a href="#var-document-register-name">name</a>, optional <a href="#api-options">Options</a> options);
}

dictionary <dfn id="api-options">Options</dfn> {
    object? <a href="#var-options-prototype">prototype</a>;
    <a href="http://www.w3.org/TR/domcore/#documentfragment">DocumentFragment</a>? <a href="#var-options-template">template</a>;
    <a href="#api-lifecycle-callbacks">LifecycleCallbacks</a>? <a href="#var-options-lifecycle">lifecycle</a>;
}

dictionary <dfn id="api-lifecycle-callbacks">LifecycleCallbacks</dfn> {
    void created();
}
</code></pre>

<p>The <dfn id="dfn-document-register"><code>register</code></dfn> method of the <a href="http://www.w3.org/TR/domcore/#document">Document</a> interface provides a way to <a href="#dfn-element-registration">register</a> a <a href="#dfn-custom-dom-element">custom DOM element</a> and returns its <a href="#dfn-custom-element-constructor">custom element constructor</a>.</p>

<p>When called, the <a href="#dfn-document-register"><code>register</code></a> method <strong>must</strong> run these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>DOCUMENT</var>, the <a href="http://www.w3.org/TR/domcore/#concept-document">document</a> on which the method is called</dd>
    <dd><var id="var-document-register-name">NAME</var>, the <a href="#dfn-custom-element-name">custom element name</a> of the element being registered</dd>
    <dd><var id="var-options-prototype">PROTOTYPE</var>, the <a href="#dfn-element-prototype">element prototype</a>, optional</dd>
    <dd><var id="var-options-template">FRAGMENT</var>, the <a href="http://www.w3.org/TR/domcore/#documentfragment">document fragment</a> that represents the <a href="#dfn-custom-element-template">custom element template</a>, optional</dd>
    <dd><var id="var-options-lifecycle">LIFECYCLE</var>, the <a href="#dfn-lifecycle-callbacks">lifecycle callbacks</a>, optional</dd>
<dt>Output</dt>
    <dd><var>CONSTRUCTOR</var>, the <a href="#dfn-custom-element-constructor">custom element constructor</a></dd>
</dl>
<ol>
    <li>If <var>NAME</var> is an invalid <a href="#dfn-custom-element-name">custom element name</a>, throw an <a href="http://www.w3.org/TR/domcore/#invalidcharactererror"><code>InvalidCharacterError</code></a> exception.</li>
    <li>If <var>PROTOTYPE</var> is missing, let <var>PROTOTYPE</var> be the <a href="http://www.w3.org/TR/WebIDL/#dfn-interface-prototype-object">interface prototype object</a> for the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/text-level-semantics.html#htmlspanelement"><code>HTMLSpanElement</code></a> <a href="http://www.w3.org/TR/WebIDL/#dfn-interface">interface</a></li>
    <li>Otherwise, if <var>PROTOTYPE</var> does not <a href="http://www.w3.org/TR/WebIDL/#dfn-inherit">inherit</a> from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#htmlelement"><code>HTMLElement</code></a> <a href="http://www.w3.org/TR/WebIDL/#dfn-interface">interface</a>, throw a <a href="http://www.w3.org/TR/domcore/#typemismatcherror"><code>TypeMismatchError</code></a> exception.</li>
    <li>If <var>FRAGMENT</var> is present, let <var>TEMPLATE</var> be <a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html#dfn-template">HTML template</a> with <var>FRAGMENT</var> as <a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html#dfn-template-contents">template contents</a></li>
    <li>Let <var>DEFINITION</var> be the tuple of (<var>PROTOTYPE</var>, <var>TEMPLATE</var>, <var>NAME</var>, <var>LIFECYCLE</var>)</li>
    <li><a href="#dfn-element-registration">Register</a> the <var>DEFINITION</var> with <var>DOCUMENT</var></li>
    <li>For <var>DOCUMENT</var> tree and every <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-dom-subtree">shadow DOM subtree</a> <a href="http://www.w3.org/TR/shadow-dom/#dfn-enclosed-subtree">enclosed</a> by <var>DOCUMENT</var> tree:
    <ol>
        <li>Let <var>TREE</var> be this tree</li>
        <li>Run <a href="#dfn-element-upgrade">element upgrade algorithm</a> with <var>TREE</var> and <var>DEFINITION</var> as arguments</li>
    </ol></li>
    <li>Return result of running <a href="#dfn-custom-element-constructor-generation">custom element constructor generation algorithm</a> with <var>PROTOTYPE</var> as argument</li>
</ol>
</div>

<div class="informative">
<p>Invoking <a href="#dfn-document-register"><code>register</code></a> has no effect on the elements that are not in document or its <a href="http://www.w3.org/TR/shadow-dom/#dfn-shadow-dom-subtree">shadow DOM subtrees</a>. This means that any elements that were created imperatively and not inserted into the document, or any elements in document fragments will not be <a href="#dfn-element-upgrade">upgraded</a>.</p>
</div>


<h3 id="the-element-element">The <code>element</code> HTML element</h3>

<dl>
<dt>Context</dt>
<dd>Where <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#flow-content-0">flow content</a> is expected.</dd>
<dt>Content model</dt>
<dd><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/elements.html#metadata-content">Metadata content</a></dd>
<dt>Children</dt>
<dd>One <code>template</code> element and zero or more <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element"><code>script</code></a> elements</dd>
<dt>Content attributes</dt>
<dd><a href="http://dev.w3.org/html5/spec/Overview.html#global-attributes">Global attributes</a></dd>
<dd><a href="#dfn-element-constructor"><code>constructor</code></a></dd>
<dd><a href="#dfn-element-extends"><code>extends</code></a></dd>
<dd><a href="#dfn-element-name"><code>name</code></a></dd>
<dt>DOM Interface</dt>
<dd>
    <pre><code>
interface <dfn id="api-html-element-element">HTMLElementElement</dfn> : <a href="http://dev.w3.org/html5/spec/Overview.html#htmlelement">HTMLElement</a> {
    attribute DOMString <a href="#dfn-html-element-element-constructor-name">constructorName</a>;
    attribute DOMString <a href="#dfn-html-element-element-extends">extends</a>;
    attribute DOMString <a href="#dfn-html-element-element-name">name</a>;
    readonly attribute Function <a href="#dfn-html-element-element-generated-constructor">generatedConstructor</a>;
}</code></pre>
</dd>
</dl>
<p>The <a href="#the-element-element"><code>element</code></a> HTML element represents a <a href="#dfn-element-definition">definition</a> of a <a href="#dfn-custom-dom-element">custom DOM element</a>.</p>

<p>The <dfn id="dfn-element-extends">extends</dfn> attribute specifies the name of the HTML element or the <a href="#dfn-custom-element-name">custom element name</a>, which is <a href="#dfn-extend-dom-element">extended</a> by the defined <a href="#dfn-custom-dom-element">custom DOM element</a>.</p>

<p>The <dfn id="dfn-element-name">name</dfn> attribute provides the <a href="#dfn-custom-element-name">name</a> of the new <a href="#dfn-custom-dom-element">custom DOM element</a>.</p>

<p>The <dfn id="dfn-element-constructor">constructor</dfn> attribute gives the name of the <a href="#dfn-custom-element-constructor">custom element constructor</a>. The value of the attribute <strong>must</strong> be a valid <a href="http://ecma-international.org/ecma-262/5.1/#sec-7.6">IdentifierName</a>. If the value is not a valid <a href="http://ecma-international.org/ecma-262/5.1/#sec-7.6">IdentifierName</a>, the <a href="#dfn-element-definition">definition</a> state must be set to <a href="#dfn-invalid-definition">invalid</a>.</p>

<p>The <dfn id="dfn-html-element-element-constructor-name">constructorName</dfn> IDL attribute <strong>must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the <a href="#dfn-element-constructor">constructor</a> content attribute.</p>

<p>The <dfn id="dfn-html-element-element-extends">extends</dfn> and <dfn id="dfn-html-element-element-name">name</dfn> IDL attributes <strong>must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/common-dom-interfaces.html#reflect">reflect</a> the respective content attributes of the same name.</p>

<p>The <dfn id="dfn-html-element-element-generated-constructor">generatedConstructor</dfn> IDL attribute <strong>must</strong> return <a href="#dfn-custom-dom-element">custom DOM element</a>'s <a href="#dfn-custom-element-constructor">custom element constructor</a>.</p>

<p>A <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element"><code>script</code></a> element that is a child of the <code><a href="#the-element-element">element</a></code> element has these additional requirements:</p>
<ol>
    <li>The actual values of <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#attr-script-async"><code>async</code></a> and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#attr-script-defer"><code>defer</code></a> attributes <strong>must</strong> be ignored</li>
    <li>When the script is being <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#prepare-a-script">prepared</a>:
    <ol>
        <li>The element <strong>must</strong> be added to the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#list-of-scripts-that-will-execute-in-order-as-soon-as-possible">set of scripts that will execute as soon as possible</a> of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a>, of the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-element"><code>script</code></a> element at the time the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#prepare-a-script">prepare a script</a> algorithm started.</li>
        <li>The user agent then <strong>must</strong> <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#queue-a-task">queue</a> a <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task">task</a> to to <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#execute-the-script-block">execute the script block</a> and then remove the element from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#set-of-scripts-that-will-execute-as-soon-as-possible">set of scripts that will execute as soon as possible</a>. The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#task-source">task source</a> is the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#networking-task-source">networking task source</a> if the element has the <a href=""><code>src</code></a> attribute, and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#dom-manipulation-task-source">DOM manipulation task source</a> otherwise.</p></li>
    </ol></li>
    <li><p>The <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-block's-source">script's block source</a> <strong>must</strong> contain valid JavaScript code which, when parsed, would match the <a href="http://ecma-international.org/ecma-262/5.1/#sec-13">FunctionBody</a> production after the <a href="http://ecma-international.org/ecma-262/5.1/#sec-7.9">automatic semicolon insertion</a>.<p>

    <p>When <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-block's-source">creating a script</a> from a node that is a child of the <code><a href="#the-element-element">element</a></code> element, the user agent must run the following steps:</p>
    <div class="algorithm">
    <dl>
    <dt>Input</dt>
        <dd><var>ELEMENT</var>, the <a href="#the-element-element"><code>element</code></a> element</dd>
        <dd><var>SOURCE</var>, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#the-script-block's-source">script's block source</a>.</dd>
        <dd><var>GLOBAL</var>, the <a href="http://ecma-international.org/ecma-262/5.1/#sec-10.2.3">global environment</a></dd>
    <dt>Output</dt>
        <dd><var>SCRIPT</var>, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-script">script</a> to be executed</dd>
    </dl>
    <ol>
        <li>Let <var>DOCUMENT</var> be the <var>ELEMENT</var>'s <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document"><code>Document</code></a></dd>
        <li>If <var>SOURCE</var> is not parsable as <a href="http://ecma-international.org/ecma-262/5.1/#sec-13">FunctionBody</a> or if parsing detects an <a href="http://ecma-international.org/ecma-262/5.1/#sec-16">early error</a>, then <a href="#dfn-invalid-definition">set the definition state to invalid</a> and <strong>stop</strong>.</li>
        <li>Let <var>STRICT</var> be <strong>true</strong> if <var>SOURCE</var> begins with a <a href="http://ecma-international.org/ecma-262/5.1/#sec-14.1">Directive Prologue</a> that contains a <a href="http://ecma-international.org/ecma-262/5.1/#sec-14.1">Use Strict Directive</a>, and <strong>false</strong> otherwise</li>
        <li>Let <var>DOCUMENTSCOPE</var> be the result of running <a href="http://ecma-international.org/ecma-262/5.1/#sec-10.2.2.3">NewObjectEnvironment</a> with parameters <em>O</em> as <var>DOCUMENT</var> and <em>E</em> as <var>GLOBAL</var>.</li>
        <li>Let <var>SCOPE</var> be the result of running <a href="http://ecma-international.org/ecma-262/5.1/#sec-10.2.2.3">NewObjectEnvironment</a> with parameters <em>O</em> as <var>ELEMENT</var> and <em>E</em> as <var>DOCUMENTSCOPE</var>.</li>
        <li>Let <var>ENVIRONMENT</var> be a new <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script-execution-environment">script execution environment</a> for JavaScript.</li>
        <li>Let <var>FUNCTION</var> be the result of <a href="http://ecma-international.org/ecma-262/5.1/#sec-13.2">creating a function object</a> in <var>ENVIRONMENT</var> with parameters <em>FormalParameterList</em> empty, <em>FunctionBody</em> as <var>SOURCE</var>, <em>Scope</em> as <var>SCOPE</var>, and <em>Strict</em> as <var>STRICT</var></li>
        <li>Return <var>SCRIPT</var> with:
        <ol>
            <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script-execution-environment">script execution environment</a> as <var>ENVIRONMENT</var></li>
            <li><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#list-of-code-entry-points">list of code entry points</a> consisting on <var>FUNCTION</var> as the only entry, and</li>
            <li>the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script's-global-object>">script's global object</a>, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script's-browsing-context">script's browsing context</a>, the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script's-document">script's document</a>, <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script's-url-character-encoding">script's URL character encoding</a>, and the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#script's-base-url">script's base URL</a> from the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#the-script-settings-determined-from-the-node">the script settings determined on</a> <var>ELEMENT</var></li>
        </ol></li>
    </ol>
    </div></li>
</ol>

<h2 id="other-languages">Supporting Other Languages</h2>

<p><span class="fixme">Explain how inheritance in custom DOM elements can be extended to other languages.</span></p>

</section>

<h2 id="acknowledgements">Acknowledgements</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Daniel Buchner</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Scott Miles</span>, <span class="vcard">Steve Orvell</span> and <span class="vcard">Tab Atkins</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</body>
</html>
