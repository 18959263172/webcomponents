<!DOCTYPE html>
<html lang="en">
<head>
<title>HTML Templates</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="stylesheet" href="../../assets/styles/spec.css" type="text/css">
<link rel="stylesheet" href="../../assets/styles/prettify.css" type="text/css">
<link rel="stylesheet" href="//www.w3.org/StyleSheets/TR/W3C-ED" type="text/css" >
<script src="../../assets/scripts/bug-assist.js"></script>
<script src="../../assets/scripts/spec-assist.js"></script>
<script src="../../assets/scripts/prettify.js"></script>
<meta name="bug.blocked" content="15476">
<meta name="bug.short_desc" content="[Templates]: ">
<meta name="bug.product" content="WebAppsWG">
<meta name="bug.component" content="Component Model">
</head>

<body>

<div class="head">

<div class="logo">
    <a href="http://www.w3.org/"><img width="72" height="48" src="http://www.w3.org/Icons/w3c_home" alt="W3C"></a>
</div>

<h1>HTML Templates</h1>
<h2 id="editors-draft">W3C Editor's Draft</h2>
<dl>
<dt>This version</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html</a></dd>
<dt>Latest editor's draft</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">http://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html</a></dd>
<dt>Previous version</dt>
    <dd>none</dd>
<dt>Revision history</dt>
    <dd><a href="http://dvcs.w3.org/hg/webcomponents/log/tip/spec/templates/index.html">http://dvcs.w3.org/hg/webcomponents/log/tip/spec/templates/index.html</a></dd>
<dt>Participate</dt>
    <dd>Discuss on <a href="http://lists.w3.org/Archives/Public/public-webapps/">public-webapps@w3.org</a> (<a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a>)</dd>
    <dd><a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?comment=&amp;blocked=15476&amp;short_desc=%5BTemplates%5D%3A%20&amp;product=WebAppsWG&amp;component=Component%20Model">File bugs</a> (w3.org's <a href="https://www.w3.org/Bugs/Public/">Bugzilla</a>)</dd>
<dt>Editors</dt>
    <dd class="vcard"><span class="fn">Dimitri Glazkov</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:dglazkov@chromium.org">dglazkov@chromium.org</a>&gt;</dd>
    <dd class="vcard"><span class="fn">Rafael Weinstein</span>, <span class="org">Google</span>, &lt;<a class="email" href="mailto:rafaelw@chromium.org">rafaelw@chromium.org</a>&gt;</dd>
    <dd class="vcard"><span class="fn">Tony Ross</span>, <span class="org">Microsoft</span>, &lt;<a class="email" href="mailto:tross@microsoft.com">tross@microsoft.com</a>&gt;</dd>
</dl>

<p class="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> &copy; 2012 <a href="http://www.w3.org/"><acronym title="World Wide Web Consortium">W3C</acronym></a><sup>&copy;</sup> (<a href="http://www.csail.mit.edu/"><acronym title="Massachusetts Institute of Technology">MIT</acronym></a>, <a href="http://www.ercim.eu/"><acronym title="European Research Consortium for Informatics and Mathematics">ERCIM</acronym></a>, <a href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. <acronym title="World Wide Web Consortium">W3C</acronym> <a href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="http://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p>

<hr>

<h2 id="abstract">Abstract</h2>

<p>This specification describes a method for declaring inert DOM subtrees in HTML and manipulating them to instantiate document fragments with identical contents.</p>

<h2 id="status">Status of This Document</h2>

<p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document. A list of current <acronym title="World Wide Web Consortium">W3C</acronym> publications and the latest revision of this technical report can be found in the <a href="http://www.w3.org/TR/"><acronym title="World Wide Web Consortium">W3C</acronym> technical reports index</a> at http://www.w3.org/TR/.</em></p>

<p>This document was published by the <a href="http://www.w3.org/2008/webapps/">Web Applications Working Group</a> as an Editor's Draft. If you wish to make comments regarding this document, please send them to <a href="mailto:public-webapps@w3.org">public-webapps@w3.org</a> (<a href="mailto:public-webapps-request@w3.org?subject=subscribe">subscribe</a>, <a href="http://lists.w3.org/Archives/Public/public-webapps/">archives</a>). All feedback is welcome.</p><p>Publication as an Editor's Draft does not imply endorsement by the <acronym title="World Wide Web Consortium">W3C</acronym> Membership. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress.</p>

<p>This document was produced by a group operating under the <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 <acronym title="World Wide Web Consortium">W3C</acronym> Patent Policy</a>. <acronym title="World Wide Web Consortium">W3C</acronym> maintains a <a href="http://www.w3.org/2004/01/pp-impl/45559/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential Claim(s)</a> must disclose the information in accordance with <a href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section 6 of the <acronym title="World Wide Web Consortium">W3C</acronym> Patent Policy</a>.</p>

</div>

<section class="toc">
<h2>Table of Contents</h2>
<ol>
    <li><a href="#about"><span class="section">1</span> About this Document</a></li>
    <li><a href="#dependencies"><span class="section">2</span> Dependencies</a></li>
    <li><a href="#terminology"><span class="section">3</span> Terminology</a></li>
    <li><a href="#introduction"><span class="section">4</span> Introduction</a>
    <ol>
        <li><a href="#declare-as-markup"><span class="section">4.1</span> Declare as Markup</a></li>
        <li><a href="#document-fragments-not-strings"><span class="section">4.2</span> Declare Document Fragments, not Strings</a></li>
        <li><a href="#declare-anything"><span class="section">4.3</span> Declare Anything</a></li>
        <li><a href="#declare-anywhere"><span class="section">4.4</span> Declare Anywhere</a></li>
        <li><a href="#limit-external-effects"><span class="section">4.5</span> Limit External Effects</a></li>
    </ol>
    </li>
    <li><a href="#definitions"><span class="section">5</span> Definitions</a></li>
    <li><a href="#template-element"><span class="section">6</span> The <code>template</code> element</a></li>
    <li><a href="#parsing"><span class="section">7</span> Parsing HTML Templates</a>
    <ol>
        <li><a href="#appending-to-a-template"><span class="section">7.1</span> Appending to a template</a></li>
        <li><a href="#clearing-the-stack"><span class="section">7.2</span> Clearing the stack back to a given context</a></li>
        <li><a href="#foster-parent-addition"><span class="section">7.3</span> Additions to "foster parenting"</a></li>
        <li><a href="#reset-insertion-mode-addition"><span class="section">7.4</span> Additions to "reset the insertion mode appropriately"</a></li>
        <li><a href="#in-table-scope-addition"><span class="section">7.5</span> Additions to "has an element in table scope"</a></li>
        <li><a href="#in-head-addition"><span class="section">7.6</span> Additions to the "in head" Insertion Mode</a></li>
        <li><a href="#in-body-addition"><span class="section">7.7</span> Additions to the "in body" Insertion Mode</a></li>
        <li><a href="#in-table-addition"><span class="section">7.8</span> Additions to the "in table" Insertion Mode</a></li>
        <li><a href="#in-cell-addition"><span class="section">7.9</span> Additions to the "in cell" Insertion Mode</a></li>
        <li><a href="#in-colgroup-addition"><span class="section">7.10</span> Additions to the "in column group" Insertion Mode</a></li>
        <li><a href="#in-select-addition"><span class="section">7.11</span> Additions to the "in select" Insertion Mode</a></li>
        <li><a href="#in-frameset-addition"><span class="section">7.12</span> Additions to the "in frameset" Insertion Mode</a></li>
        <li><a href="#template-contents-insertion-mode"><span class="section">7.13</span> The "template contents" Insertion Mode</a></li>
    </ol>
    </li>
    <li><a href="#serializing-html-templates"><span class="section">8</span> Serializing HTML Templates</a></li>
    <li><a href="#css-additions"><span class="section">9</span> Additions to the CSS user agent style sheet</a></li>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
</ol>

</section>

<section class="math">

<h2 id="about">About this Document</h2>

<p>All diagrams, examples, notes, are non-normative, as well as sections explicitly marked as non-normative. Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the normative parts of this document are to be interpreted as described in <a href="http://dev.w3.org/2006/xbl2/#refsRFC2119">RFC2119</a>. For readability, these words do not appear in all uppercase letters in this specification.</p>

<p>To help with layering and to avoid circular dependencies between various parts of specification, this document consists of three consecutive narratives:
<ol>
    <li>setting up the stage for the specification,</li>
    <li>explaining of the conceptual model and algorithms behind it, and</li>
    <li>expressing this model with DOM interfaces and HTML elements.</li>
</ol>
<p>In a sense, these parts can be viewed as <em>math</em>, which sets up the reasoning environment, <em>physics</em>, which is the theoretical reasoning about the concept, and <em>mechanics</em>, which is the is the practical application of this reasoning.</p>

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="http://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This document relies on the following specifications:</p>

<ul>
    <li><a href="http://www.w3.org/TR/domcore/">DOM4 (DOM Core)</a></li>
    <li><a href="http://dev.w3.org/html5/spec/">HTML</a></li>
    <li><a href="http://html5.org/specs/dom-parsing.html">DOM Parsing and Serialization</a></li>
</ul>

<h2 id="terminology">Terminology</h2>

<p>The following terms are used throughout the specification:

<p><a class="fixme" href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=15541">Populate terminology section</a></p>

<dl>
<dt>DOM</dt>
    <dd>The <a href="http://www.w3.org/TR/domcore/">document object model</a></dd>
<dt>document</dt>
    <dd>The Document Object Model's underlying document</dd>
<dt>node</dt>
    <dd>Any DOM object that <a href="http://www.w3.org/TR/domcore/#concept-tree-participate">participates in a tree</a></dd>
<dt>document fragment</dt>
    <dd>A DOM object that implements the <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-documentfragment"><code>DocumentFragment</code></a> interface</dd>
<dt>element</dt>
    <dd>A DOM object that implements the <a href="http://www.w3.org/TR/domcore/#interface-element">Element</a> interface</dd>
<dt>DOM tree</dt>
    <dd>Any <a href="http://www.w3.org/TR/domcore/#trees">tree</a>, composed of DOM objects</a>
</dl>

</section>

<section class="physics">

<h2 id="introduction">Introduction</h2>

<p><em>This section is non-normative.</em></p>
<p>Web developers commonly need to create a <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documentfragment">document fragment</a> that they could later insert into the document. This document fragment could be a part of temporary structure that is used to quickly switch in and out parts of the document DOM as a reaction to some trigger, such as timer or user action. It could also be an intermediate structure that serves as a template and is populated with specific data, to then be cloned or moved into the document DOM.</p>

<p>Let's examine the desired properties of declaring document fragments and challenges of acquiring these properties.</p>

<h3 id="declare-as-markup">Declare As Markup</h3>

<p>A typical approach for creating temporary or intermediate DOM trees is to build them with DOM APIs:</p>

<code><pre class="prettyprint">

var tree = document.createDocumentFragment();
// add tree nodes imperatively &hellip;
var div = tree.appendChild(document.createElement('div'));
// &hellip; and/or use strings and innerHTML.
div.innerHTML = '&lt;a href="//example.com/link"&gt;LINK&lt;/a&gt;';
// &hellip;

</pre></code>

<p>While achieving its objective, such code views the elements either as purely DOM objects or strings. Both of the perspectives are removed from the document's markup flow, with the DOM objects perspective being imperative and verbose, thus difficult to reason about without first executing code, and the strings perspective being a poor-man's bootstrap into the HTML parser.</p>

<p>Subsequently, a more elegant solution is necessary: something that allows developers declare arbitrary DOM subtrees <em>in</em> the document markup. Empirically, all widely used Web frameworks and toolkits attempt to solve this problem, whether by using the <a href="http://dev.w3.org/html5/spec/scripting-1.html#the-script-element"><code>script</code></a> element with a custom type or with the help of specially-named attributes.</p>

<h3 id="document-fragments-not-strings">Declare Document Fragments, not Strings</h3>

<p>There are two approaches to parsing the document fragment declarations:</p>
<ul>
    <li>treat <strong>declaration as string</strong> of characters</li>
    <li>treat <strong>declaration as tokens</strong> that represent DOM elements</li>
</ul>

<p>The "declaration-as-string" approach is convenient on the surface, since it allows delaying the tokenization of a document fragment until it needs to be instantiated. In turn, this opens opportunity for easy string matching to substitute some specially marked placeholders with the actual data when templating. However, the delay also introduces an unhappy side effect of only discovering whether a document fragment declaration is valid at runtime.</p>

<p>Additionally, should the Web developer require for declarations to nest&mdash;to provide the templating for two-dimensional data, for instance&mdash;things start falling apart quickly. To address this, one must contemplate drastic additions to <a href="http://dev.w3.org/html5/spec/tokenization.html#tokenization">HTML tokenization</a> to keep track of the nesting level in the declaration. Alternatively, a distinct syntax for nested declarations could be introduced to differentiate the first level of nesting, with a special tokenization mode inside of the outer declaration.</p>

<p>These undesirable consequences force us to consider the "declaration-as-tokens" approach. This approach, while still requiring some changes to the <a href="http://dev.w3.org/html5/spec/parsing.html#parsing">HTML parsing</a>, handles nested templates more gracefully, and ensures that construction of the declared document fragment happens while parsing the document.</p>

<h3 id="declare-anything">Declare Anything</h3>

<p>Attempting to declare arbitrary document fragments runs into the limitations on the <a href="http://dev.w3.org/html5/spec/parsing.html#current-node">context</a> of the element, imposed by the HTML parser. For example, in order for a <code>tr</code> element to succeed in being inserted into a tree while parsing, its parent has to be either <a href="http://dev.w3.org/html5/spec/tabular-data.html#the-table-element"><code>table</code></a>, <a href="http://dev.w3.org/html5/spec/tabular-data.html#the-thead-element"><code>thead</code></a>, <a href="http://dev.w3.org/html5/spec/tabular-data.html#the-tbody-element"><code>tbody</code></a>, or <a href="http://dev.w3.org/html5/spec/tabular-data.html#the-tfoot-element"><code>tfoot</code></a>. Since the developers are creating these tree outside of a document, they have to work around these limitations by either:<p>
<ul>
    <li>providing an ersatz context element structure at the top of the tree, or</li>
    <li>using DOM APIs to build the tree.</li>
</ul>
<p>Both solutions incur unnecessary costs: the former requires extra work to manage the transient contextualizing elements, and the latter takes us away from the declarative syntax. Thus, we must consider relaxing the HTML <a href="http://dev.w3.org/html5/spec/tokenization.html#tree-construction">tree construction</a> rules to allow context-free element insertion in certain cases.</p>

<h3 id="declare-anywhere">Declare Anywhere</h3>

<p>Whenever developers declare a document fragment, they may need to place it at to the site of its instantiation. For instance, if the tree is used as a template for repeating elements, it would make sense to place it at the insertion site for the repeating elements:</p>

<code><pre class="prettyprint">

&lt;!-- uses fictional syntax --&gt;
&lt;ul&gt;
    &lt;stuff-to-repeat&gt;
        &lt;li class=&quot;<span class="nocode" style="color:blue">${importance}</span>&quot;&gt;&lt;a href=&quot;<span class="nocode" style="color:blue">${link}</span>&quot;&gt;<span class="nocode" style="color:blue">${title}</span>&lt;/a&gt;&lt;/li&gt;
    &lt;/stuff-to-repeat&gt;
&lt;/ul&gt;
</pre></code>

<p>Once again, the developers run into HTML parser limitations. Consider this, slightly modified example:</p>

<code><pre class="prettyprint">

&lt;!-- uses fictional syntax --&gt;
&lt;select&gt;
    &lt;stuff-to-repeat&gt;
        &lt;option class=&quot;<span class="nocode" style="color:blue">${importance}</span>&quot;&gt;<span class="nocode" style="color:blue">${title}</span>&lt;/option&gt;
    &lt;/stuff-to-repeat&gt;
&lt;/select&gt;
</pre></code>

<p>According to HTML <a href="http://dev.w3.org/html5/spec/tokenization.html#tree-construction">tree construction</a> algorithm, the <code>stuff-to-repeat</code> element will be never inserted into the resulting document DOM tree, thus losing information about the presence of the declaration. Similarly to the "do-what-I-mean" situation, we must consider relaxing the HTML <a href="http://dev.w3.org/html5/spec/tokenization.html#tree-construction">tree construction</a> rules to allow the placement of document fragment tree declarations anywhere in the document.</p>

<h3 id="limit-external-effects">Limit External Effects</h3>

<p>One reason for creating a document fragment is to clone it multiple times to create repeating items that vary in some content, but have common basic structure of across all instances.</p>

<p>Then, a typical flow of processing steps involves using this DOM tree and its clones as intermediaries to populate the document:</p>
<ol>
    <li>Create a prototype: a document fragment to serve as a template</li>
    <li>Instantiate the prototype: clone the fragment to create a template document fragment</li>
    <li>Poplate the template document fragment with data for this fragment</li>
    <li>Append the template document fragment to the document</li>
    <li>Instantiate the prototype: clone the document fragment to create a template document fragment</li>
    <li>Populate the template document fragment with data for that fragment</li>
    <li>&hellip;</li>
</ol>

<p>In these steps, developers typically assume that modifying these intermediate document fragments does not have any external effects. In other words, changes to elements or structure of a document fragment is not perceptible outside of this tree. For most elements, this condition is immediately satisfied, since most HTML elements do not have external effects, such as rendering or firing events, until they are in the document tree. However, a small set of HTML elements, such as those representing <a href="http://dev.w3.org/html5/spec/embedded-content-1.html#embedded-content-1">embedded content</a> requires special treatment.</p>

<p>For example, if developers wish to automate the process of populating a newly cloned template in the processing steps above, they would opt to use some specially-marked placeholders as attribute or text node values in the document fragment:</p>

<code><pre class="prettyprint">
&lt;div class="comment"&gt;
    &lt;img src="<span class="nocode" style="color:blue;">${avatar}</span>"&gt;
    &lt;div class="text"&gt;<span class="nocode" style="color:blue;">${text}</span>&lt;/div&gt;
&lt;/div&gt;
</pre></code>

<p>Then, when populating the newly cloned template document fragment, the placeholders are replaced with the actual values. Unfortunately, the <a href="http://dev.w3.org/html5/spec/embedded-content-1.html#the-img-element"><code>img</code></a> element will likely attempt to <a href="http://dev.w3.org/html5/spec/embedded-content-1.html#update-the-image-data">update the image data</a> as soon as its <a href="http://dev.w3.org/html5/spec/embedded-content-1.html#attr-img-src"><code>src</code></a> attribute is set to any non-empty value. In the scenario above, this leads to an unintended effect of making server requests with the url of <code>${avatar}</code> for first document fragment, and then all other instances that are cloned from it.</p>

<p>To enforce developers' assumption on external effects, a slightly different set of restrictions is needed for the elements in intermediate trees. These restrictions would make the elements in the intermediate trees appear <em>inert</em>, or lacking any externals effects that are perceptible outside of the intermediate trees.</p>

<h2 id="definitions">Definitions</h2>

<p>A <dfn id="dfn-template">template</dfn> provides a method for declaring document fragments in <a href="http://dev.w3.org/html5/spec/">HTML</a>. The document fragment that is declared by a <a href="#dfn-template">template</a> is called <dfn id="dfn-template-contents">template contents</dfn>.</p>

<p>The <a href="#dfn-template-contents">template contents</a> <strong>must</strong> be declared using the <a href="http://dev.w3.org/html5/spec/syntax.html#syntax">HTML syntax</a> in an HTML document. Once parsed, the <a href="#dfn-template-contents">template contents</a> <strong>must not</strong> be in the document tree.</p>

<p>All elements in <a href="#dfn-template-contents">template contents</a> <strong>must</strong> be <em>inert</em>. An element is <dfn id="dfn-inert">inert</dfn> when modifying its attributes or contents does not trigger any effects that can be perceived outside of the tree, in which it <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-participate">participates</a>.</p>

<p>Conversely, serializing a <a href="#dfn-template">template</a> <strong>must</strong> result in the <a href="#dfn-template-contents">template contents</a> serialized as part of the HTML document.</p>

</section>

<section class="mechanics">

<h2 id="template-element">The <code>template</code> element</h2>

<p>The <dfn id="dfn-template-element"><code>template</code></dfn> element represents a <a href="#dfn-template">template</a>.</p>

<dl>
<dt>Context</dt>
    <dd>As a descendant of the <a href="http://dev.w3.org/html5/spec/the-head-element.html#the-head-element">head</a> element.</dd>
    <dd>As a descendant of the <a href="http://dev.w3.org/html5/spec/the-body-element.html#the-body-element">body</a> element.</dd>
    <dd>As a descendant of the <a href="http://dev.w3.org/html5/spec/obsolete.html#frameset">frameset</a> element.</dd>
<dt>Content Model</dt>
    <dd>Any, except the <a href="http://dev.w3.org/html5/spec/the-html-element.html#the-html-element">html</a> element, the <a href="http://dev.w3.org/html5/spec/the-head-element.html#the-head-element">head</a> element, the <a href="http://dev.w3.org/html5/spec/the-body-element.html#the-body-element">body</a> element, or the <a href="http://dev.w3.org/html5/spec/obsolete.html#frameset">frameset</a> element.</dd>
<dt>Content attributes</dt>
    <dd><a href="http://dev.w3.org/html5/spec/elements.html#global-attributes">Global attributes</a></dd>
<dt>DOM Interface</dt>
    <dd>
        <pre><code>
interface <dfn id="api-html-template-element">HTMLTemplateElement</dfn> : <a href="http://dev.w3.org/html5/spec/elements.html#htmlelement">HTMLElement</a> {
    readonly attribute <a href="http://www.w3.org/TR/domcore/#interface-documentfragment">DocumentFragment</a> <a href="#api-html-template-element-content">content</a>;
}
        </code></pre>
        <dl>
        <dt>Attributes</dt>
        <dl>
            <dt id="api-html-template-element-content"><code>content</code> of type <a href="http://www.w3.org/TR/domcore/#interface-documentfragment"><code>DocumentFragment</code></a>, read-only</dt>
            <dd>Provides access to <a href="#dfn-template-contents">template contents</a></dd>
        </dd>
        </dl>
    </dd>
</dl>

<p>Prior to first access, the <a href="#api-html-template-element-content"><code>content</code></a> property <strong>must</strong> be <dfn id="dfn-template-contents-initialization">initialized</dfn> in a way that is <a href="#dfn-processing-equivalence">equivalent</a> to processing these steps:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>TEMPLATE</var>, the <a href="#dfn-template">template</a></dd>
<dt>Output</dt>
    <dd><var>CONTENTS</var>, the <a href="#dfn-template-contents">template contents</a></dd>
</dl>
<ol>
    <li>Let <var>DOCUMENT</var> be a new <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-document">Document</a> node that does not have a <a href="http://dev.w3.org/html5/spec/browsers.html#browsing-context">browsing context</a></li>
    <li>Mark <var>DOCUMENT</var> as an <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-document">HTML document</a></li>
    <li>Let <var>CONTENTS</var> be a new <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#interface-documentfragment">DocumentFragment</a> object whose <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node-document">node document</a> is <var>DOCUMENT</var></li>
</ol>
</div>

<p>The <a href="http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node-clone-ext">cloning steps</a> for the <a href="#dfn-template-element"><code>template</code></a> template element <strong>must</strong> include the cloning of <a href="#dfn-template-contents">template contents</a>.</p>

<h2 id="parsing">Parsing HTML Templates</h2>

<p>The parsing of <a href="#dfn-template">templates</a> is defined as a set of additions to the <a href="http://dev.w3.org/html5/spec/parsing.html#parsing">HTML parsing algorithm</a>. When parsing, the <a href="#dfn-template-element"><code>template</code></a> element is in the <a href="http://dev.w3.org/html5/spec/parsing.html#special">special</a> category.</p>

<p class="fixme">These additions cause the HTML parsing algorithm to enter some conditions previously marked as <a href="http://dev.w3.org/html5/spec/the-end.html#fragment-case">fragment case</a>. These cases still need to be documented.</p>

<h3 id="appending-to-a-template">Appending to a template</h3>

<p>Whenever the HTML parser is about to append a node to a <a href="#dfn-template-element"><code>template</code></a> element, the node <strong>must</strong> be appended to the <a href="#dfn-template-contents">template contents</a> of the <a href="#dfn-template-element"><code>template</code></a> element instead.</p>

<p class="note">As a result, the HTML parser will never place any nodes as direct children of a <a href="#dfn-template-element"><code>template</code></a> element.</p>

<h3 id="clearing-the-stack">Clearing the stack back to a given context</h3>

<p>When popping elements from the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a>, a conforming UA <strong>must</strong> abort the following procedures when the <a href="http://dev.w3.org/html5/spec/parsing.html#current-node">current node</a> is <a href="#dfn-template-element"><code>template</code></a>:
<ol>
    <li><a href="http://dev.w3.org/html5/spec/tokenization.html#clear-the-stack-back-to-a-table-context">Clearing the stack back to a table context</a></li>
    <li><a href="http://dev.w3.org/html5/spec/tokenization.html#clear-the-stack-back-to-a-table-body-context">Clearing the stack back to a table body context</a></li>
    <li><a href="http://dev.w3.org/html5/spec/tokenization.html#clear-the-stack-back-to-a-table-row-context">Clearing the stack back to a table row context</a></li>
</ol>

<h3 id="foster-parent-addition">Additions to "foster parenting"</h3>

<p>When a node is to be <a href="http://dev.w3.org/html5/spec/tokenization.html#foster-parent"><strong>foster parented</strong></a>, the last <a href="#dfn-template-element"><code>template</code></a> element with no <a href="http://dev.w3.org/html5/spec/the-table-element.html#the-table-element"><code>table</code></a> element is below it in the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a> is the <a href="http://dev.w3.org/html5/spec/tokenization.html#foster-parent-element"><strong>foster parent element</strong></a> <em>(NOT the template's parent!)</em> if there is such a <a href="#dfn-template-element"><code>template</code></a> element in the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a>. Otherwise normal rules for <a href="http://dev.w3.org/html5/spec/tokenization.html#foster-parenting">foster parenting</a> apply.</p>

<p class="note">This prevents the HTML parser from "lifting" content outside of a template when a node is to be <a href="http://dev.w3.org/html5/spec/tokenization.html#foster-parent"><strong>foster parented</strong></a>, aligning template behavior more closely with the <a href="http://dev.w3.org/html5/spec/the-end.html#html-fragment-parsing-algorithm">HTML fragment parsing algorithm</a>.</p>

<h3 id="reset-insertion-mode-addition">Additions to "reset the insertion mode appropriately"</h3>

<p>Just after the step labeled <strong>"Loop"</strong> in the algorithm to <a href="http://dev.w3.org/html5/spec/parsing.html#reset-the-insertion-mode-appropriately">reset the insertion mode appropriately</a>, add the following step:</p>
<ol start="4">
    <li>If <em>node</em> is a <a href="#dfn-template-element"><code>template</code></a> element, then switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to "<a href="#template-contents-insertion-mode">template contents</a>" and abort these steps.</li>
</ol>

<p>Modify the step which begins <em>"If node is a head element..."</em> to be:</p>
<ol start="11">
    <li>If <em>node</em> is a <a href="http://dev.w3.org/html5/spec/the-head-element.html#the-head-element"><code>head</code></a> element <strong>and</strong> <em>node</em> is the <a href="http://dev.w3.org/html5/spec/the-end.html#concept-frag-parse-context"><em>context</em></a> element, then switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">"in body"</a> ("<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">in body</a>"! not "<em><a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">in head</a></em>") and abort these steps (<a href="http://dev.w3.org/html5/spec/the-end.html#fragment-case">fragment case</a>). Otherwise, switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a>, and abort these steps.</li>
</ol>

<h3 id="in-table-scope-addition">Additions to "has an element in table scope"</h3>

<p>Add the following to the list of element types for the algorithm to <a href="http://dev.w3.org/html5/spec/parsing.html#has-an-element-in-table-scope"><strong>have an element in table scope</strong></a>:</p>
<ul>
    <li><a href="#dfn-template-element"><code>template</code></a> in the <a href="http://dev.w3.org/html5/spec/namespaces.html#html-namespace-0">HTML namespace</a>
</ul>

<h3 id="in-head-addition">Additions to the "in head" Insertion Mode</h3>

<p>Just before the <strong>A start tag whose tag name is "head"</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode, add the following rules:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
    <dd>Run these steps:
    <ol>
        <li>Insert a marker at the end of the <a href="http://dev.w3.org/html5/spec/parsing.html#list-of-active-formatting-elements">list of active formatting elements</a></li>
        <li><a href="#dfn-template-insertion-algorithm">Insert new template HTML element</a></li>
        <li>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="#template-contents-insertion-mode">"template contents"</a>
    </ol>
    </dd>
<dt>An end tag whose name is "template"</dt>
    <dd>If the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a> does not <a href="http://dev.w3.org/html5/spec/parsing.html#has-an-element-in-scope">have an element in scope</a> with the same tag name as that of the token, then this is a <a href="http://dev.w3.org/html5/spec/parsing.html#parse-error">parse error</a>; ignore the token.</dd>
    <dd>Otherwise, run these steps:
    <ol>
        <li><a href="http://dev.w3.org/html5/spec/tokenization.html#generate-implied-end-tags">Generate implied end tags</a></li>
        <li>If the <a href="http://dev.w3.org/html5/spec/parsing.html#current-node">current node</a> is not an element with the same tag name as that of the token, then this is a <a href="http://dev.w3.org/html5/spec/parsing.html#parse-error">parse error</a></li>
        <li>Pop elements from the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a> until an element with the same tag name as the token has been popped from the stack</li>
        <li><a href="http://dev.w3.org/html5/spec/parsing.html#clear-the-list-of-active-formatting-elements-up-to-the-last-marker">Clear the list of active formatting elements up to the last marker</a></li>
        <li><a href="http://dev.w3.org/html5/spec/parsing.html#reset-the-insertion-mode-appropriately">Reset the insertion mode appropriately</a></li>
    </ol>
    </dd>
</dl>

<h3 id="in-body-addition">Additions to the "in body" Insertion Mode</h3>

<p>Just before the <strong>Any other start tag</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">"in body"</a> insertion mode, add the following rule:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
<dt>An end tag whose name is "template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode</dd>
</dl>

<h3 id="in-table-addition">Additions to the "in table" Insertion Mode</h3>

<p>Just before the <strong>Anything else</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intable">"in table"</a> insertion mode, add the following rule:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
<dt>An end tag whose name is "template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode</dd>
</dl>

<p class="note">The "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intbody">in table body</a>" and "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inrow">in row</a>" insertion modes are not modified because they defer to "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intable">in table</a>" for <strong>"Anything else"</strong>. Likewise, the "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-incaption">in caption</a>" and "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-incell">in cell</a>" insertion modes are not modified because they defer to "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">in body</a>".</p>


<h3 id="in-cell-addition">Additions to the "in cell" Insertion Mode</h3>

<p>Modify the parenthetical comment within the <strong>An end tag whose tag name is one of: "table", "tbody", "tfoot", "thead", "tr"</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intd">"in cell"</a> insertion mode, to be:</p>

<p>(which can only happen for "tbody", "tfoot" and "thead", when parsing template contents, or in the fragment case)</p>

<h3 id="in-colgroup-addition">Additions to the "in column group" Insertion Mode</h3>

<p>Just before the <strong>Anything else</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-incolgroup">"in column group"</a> insertion mode, add the following rule:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
<dt>An end tag whose name is "template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode</dd>
</dl>

<h3 id="in-select-addition">Additions to the "in select" Insertion Mode</h3>

<p>Just before the <strong>Anything else</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inselect">"in select"</a> insertion mode, add the following rule:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
<dt>An end tag whose name is "template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode</dd>
</dl>

<h3 id="in-frameset-addition">Additions to the "in frameset" Insertion Mode</h3>

<p>Just before the <strong>Anything else</strong> rule in the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inframeset">"in frameset"</a> insertion mode, add the following rule:</p>
<dl>
<dt>A start tag whose tag name is "template"</dt>
<dt>An end tag whose name is "template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">"in head"</a> insertion mode</dd>
</dl>

<h3 id="template-contents-insertion-mode">The "template contents" Insertion Mode</h3>

<p>When the user is to apply the rules for the "template contents" <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a>, the user agent <strong>must</strong> handle the token as follows:</p>
<dl>
<dt>A character token</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">in body</a>" <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a>.</dd>
<dt>A comment token</dt>
<dt>A start tag whose name is one of: "link", "script", "style", "meta", template"</dt>
    <dd>Process the token <a href="http://dev.w3.org/html5/spec/parsing.html#using-the-rules-for">using the rules for</a> the "<a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inhead">in head</a>" <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a>.</dd>
<dt>A start tag whose name is "frame"</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inframeset">"in frameset"</a> and reprocess the current token</dd>
<dt>A start tag whose name is "col"</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-incolgroup">"in column group"</a> and reprocess the current token</dd>
<dt>A start tag whose name is one of: "caption", "colgroup", "tbody", "tfoot", "thead"</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intable">"in table"</a> and reprocess the current token</dd>
<dt>A start tag whose name is one of: "tr"</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intbody">"in table body"</a> and reprocess the current token</dd>
<dt>A start tag whose name is one of: "td", "th"</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-intr">"in row"</a> and reprocess the current token</dd>
<dt>An end tag whose name is "template"</dt>
    <dd>
    <ol>
        <li>Pop the <a href="http://dev.w3.org/html5/spec/parsing.html#current-node">current node</a> off the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a></li>
        <li><a href="http://dev.w3.org/html5/spec/parsing.html#reset-the-insertion-mode-appropriately">Reset the insertion mode appropriately</a></li>
    </ol>
    </dd>
<dt>An end-of-file token</dt>
    <dd><a href="http://dev.w3.org/html5/spec/parsing.html#parse-error">Parse error</a></dd>
    <dd>Run these steps:
    <ol>
        <li>Pop the <a href="http://dev.w3.org/html5/spec/parsing.html#current-node">current node</a> off the <a href="http://dev.w3.org/html5/spec/parsing.html#stack-of-open-elements">stack of open elements</a></li>
        <li><a href="http://dev.w3.org/html5/spec/parsing.html#reset-the-insertion-mode-appropriately">Reset the insertion mode appropriately</a> and reprocess the token</li>
    </ol>
    </dd>
<dt>Anything else</dt>
    <dd>Switch the <a href="http://dev.w3.org/html5/spec/parsing.html#insertion-mode">insertion mode</a> to <a href="http://dev.w3.org/html5/spec/tokenization.html#parsing-main-inbody">"in body"</a> and reprocess the current token</dd>
</dl>

<h2 id="serializing-html-templates">Serializing HTML Templates</h2>

<p>The serialization of HTML Templates is defined this addition to the <a href="http://dev.w3.org/html5/spec/the-end.html#html-fragment-serialization-algorithm">HTML fragment serialization algorithm</a>:</p>

<p>In the rule "If current node is an Element", just before the step of recursing into the algorithm, add this step</p>

<dl>
<dt>If current nodes in an Element</dt>
    <dd>If <em>current node</em> is a <a href="#dfn-template-element"><code>template</code></a> element, then set <em>current node</em> to <a href="#dfn-template-contents">template contents</a>.</dd>
</dl>

<h2 id="css-additions">Additions to the CSS user agent style sheet</h2>

<p>The <a href="#dfn-template-contents">template contents</a> are hidden implicitly since they are not part of the document. The <a href="#dfn-template">template</a> element itself <strong>must</strong> be hidden by default through the following addition to the user agent style sheet.</p>

<code><pre class="prettyprint">

@namespace "http://www.w3.org/1999/xhtml";

template {
    display : none;
}

</pre></code>

</section>

<h2 id="acknowledgements">Acknowledgements</h2>

<p>The <code>template</code> element was described by <span class="vcard">Ian Hickson</span> in the <a href="http://dev.w3.org/2006/xbl2/#the-template-element">XBL 2.0</a> specification, and this HTML Templates specification borrows most of semantics from there, applying them to the HTML realm.</p>

<p><span class="vcard">Erik Arvidsson</span> and <span class="vcard">Adam Klein</span> worked closely with the editors to help identify requirements and use cases for the templates, producing the <a href="http://code.google.com/p/mdv/">Model-driven Views</a> library, which uses a <code>template</code> element extensively.</p>

<p>The editors would also like to thank <span class="vcard">Adam Barth</span>, <span class="vcard">Henri Sivonen</span>, and <span class="vcard">Tab Atkins</span> for their useful comments and contributions to the specification.</p>

</body>
</html>
