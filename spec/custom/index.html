<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Custom Elements</title>
  <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
  <script src='https://resources.whatwg.org/dfn.js' defer class='remove'></script>
  <link rel="stylesheet" href="../../assets/styles/respec-complement.css">
  <script class='remove'>
  function resolveBacklink() {
      // For dfn.js
      if (window.initDfn) {
          initDfn();
      }
  }
  var respecConfig = {
    shortName: "custom-elements",
    specStatus: "ED",
    useExperimentalStyles: true,
    edDraftURI: "https://w3c.github.io/webcomponents/spec/custom/",
    editors: [{
       name: "Domenic Denicola",
       url: "mailto:d@domenic.me",
       company: "Google, Inc."
    }],
    wg: "Web Platform Working Group",
    wgURI: "http://www.w3.org/WebPlatform/WG/",
    wgPublicList: "public-webapps",
    subjectPrefix: "[custom-elements]",
    postProcess: [resolveBacklink],
    license: "w3c-software-doc",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/webcomponents/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/webcomponents/labels/custom-elements'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/webcomponents/commits/gh-pages/spec/custom'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-webapps@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-webapps/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use Custom Elements?',
        href: 'http://caniuse.com/#feat=custom-elements'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/custom-elements/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/custom-elements'
      }]
    }],
    localBiblio:  {
      'FOUC': {
        title: 'Flash of unstyled content',
        href: 'https://en.wikipedia.org/wiki/Flash_of_unstyled_content',
        publisher: "Wikipedia"
      },
      'WEBIDL': {
        title: 'Web IDL',
        href: 'https://heycam.github.io/webidl/',
        publisher: 'W3C',
        authors: [
            'Cameron McCormack',
            'Boris Zbarsky'
        ]
      }
    },
    wgPatentURI: "http://www.w3.org/2004/01/pp-impl/83482/status"
  };
  </script>
<style>
div.algorithm {
    padding: 0 0 0 20px;
    border-left: 5px solid #EAF7F9;
}
var {
    font-size: 0.8em;
    color: #005A9C;
    font-style: normal;
}
</style>

</head>

<body>

<section id='abstract'>

<p>This specification describes the method for enabling the author to define and use new types of DOM elements in a document. It will eventually be upstreamed into [[!WHATWG-DOM]], [[!HTML]], and [[!WEBIDL]].</p>

</section>

<section id='sotd'>

<!-- draft specific information on status goes here -->

</section>

<section class='informative'>

<h2>Motivations</h2>

<p>There are two motivations that fueled the development of this specification:</p>
<ol>
    <li id="dfn-help-web-developers"><strong>Provide a way for Web developers to build their own, fully-featured DOM elements</strong>. Though it was long possible to create DOM elements with any tag names in HTML, these elements weren't very functional. By giving Web developers the means to both inform the parser on how to properly construct an element and to react to lifecycle changes of an element, the specification eliminates the need for DOM-as-a-render-view scaffolding that has to exist today in most web frameworks or libraries.</li>
    <li id="dfn-rationalize-the-platform"><strong>Rationalize the platform</strong>. The specification ensures that all of its new features and abilities are in concert with how the relevant bits of the Web platform work today, so that these new features could be used to explain the functionality of existing Web platform features, such as HTML elements.</li>
</ol>
<p>Most of the effort went into finding the right balance between the two motivations, driven by the hope that these motivations do not run counter to each other, but are rather complementary parts of the same larger story. For example, though the scope of the spec is currently limited to only creating custom elements by authors, it is designed to shorten the distance to a much more ambitious goal of rationalizing all HTML, SVG, and MathML elements into one coherent system.</p>
</section>

<section id="conformance">

<p>Any point, at which a conforming UA must make decisions about the state or reaction to the state of the conceptual model, is captured as <a href="https://en.wikipedia.org/wiki/Algorithm">algorithm</a>. The algorithms are defined in terms of processing equivalence. The <dfn id="dfn-processing-equivalence">processing equivalence</dfn> is a constraint imposed on the algorithm implementors, requiring the output of the both UA-implemented and the specified algorithm to be exactly the same for all inputs.</p>

<p>The IDL fragments in this specification must be interpreted as required for conforming IDL fragments, as described in the Web IDL specification [[!WEBIDL]].</p>
</section>

<section>
<h2>Concepts</h2>

<p>A <dfn id="dfn-custom-element">custom element</dfn> is an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> whose constructor and prototype are defined by a developer, instead of by the user agent. The developer-supplied constructor function is called the <dfn id="dfn-custom-element-constructor">custom element constructor</dfn>.</p>

<p>The <dfn id="dfn-custom-element-name">custom element name</dfn> identifies a <a>custom element</a> <a href="https://heycam.github.io/webidl/#dfn-interface">interface</a> and is a sequence of characters that MUST match the <a href="https://www.w3.org/TR/xml-names/#NT-NCName">NCName</a> production [[!XML-NAMES]], MUST contain a <var>U+002D HYPHEN-MINUS</var> character, and MUST NOT contain any <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#uppercase-ascii-letters">uppercase ASCII letters</a> [[!HTML]]. The <a>custom element name</a> MUST NOT be one of the following values:</p>
<ul>
    <li><code>annotation-xml</code></li>
    <li><code>color-profile</code></li>
    <li><code>font-face</code></li>
    <li><code>font-face-src</code></li>
    <li><code>font-face-uri</code></li>
    <li><code>font-face-format</code></li>
    <li><code>font-face-name</code></li>
    <li><code>missing-glyph</code></li>
</ul>

<div class="note">
The list of names above is the summary of all hyphen-containing element names from the <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">applicable specifications</a>, namely <a href="https://www.w3.org/TR/SVG/eltindex.html">SVG</a> [[SVG11]] and <a href="https://www.w3.org/TR/MathML/">MathML</a> [[MathML]].
</div>

<p>A <dfn id="dfn-element-definition">custom element definition</dfn> describes a <a>custom element</a> and consists of:</p>
<ul>
    <li>a <dfn id="dfn-element-definition-name" for="custom element definition">name</dfn>, which is a <a>custom element name</a>,</li>
    <li>a <dfn id="dfn-element-definition-local-name" for="custom element definition">local name</dfn>, which is a <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a>,</li>
    <li>a <dfn id="dfn-element-definition-constructor" for="custom element definition">konstructor</dfn>, which is a <a>custom element constructor</a>,</li> <!-- https://github.com/w3c/respec/issues/582 for why it's k -->
    <li>a <dfn id="dfn-element-definition-prototype" for="custom element definition">prototype</dfn>, which is a JavaScript object;</li>
    <li>a collection of <dfn id="dfn-element-definition-lifecycle-callbacks" dfn-for="custom element definition">lifecycle callbacks</dfn>, which is a <a>collection of lifecycle callbacks</a>; and</li>
    <li>a <dfn id="dfn-element-definition-construction-stack" for="custom element definition">construction stack</dfn>, which is a list (initially empty).</li>
</ul>

<p>Each <a>custom element definition</a>'s <a href="#dfn-element-definition-construction-stack">construction stack</a> is manipulated by the <a>upgrade a custom element</a> algorithm and the <a href="#dom-htmlelement-constructor"><code>HTMLElement</code> constructor</a>. Each entry in the list will be either an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> or an <dfn id="dfn-already-constructed-marker"><i>already constructed</i></dfn> marker.</p>

<p>Each <a href="https://dom.spec.whatwg.org/#concept-document">document</a> has an associated <dfn id="dfn-registry">custom element registry</dfn>, which is either a set of <a data-lt="custom element definition">custom element definitions</a> or is null. Unless stated otherwise, a <a href="https://dom.spec.whatwg.org/#concept-document">document</a>'s <a>custom element registry</a> is null.</p>

<p class="note">In general, only <a href="https://dom.spec.whatwg.org/#concept-document">documents</a> associated with a <a href="https://html.spec.whatwg.org/multipage/browsers.html#browsing-context">browsing context</a> have non-null <a data-lt="custom element registry">custom element registries</a>. Trying to <a data-lt="element registration">register</a> or create custom elements in other documents, such as those created by <a href="https://dom.spec.whatwg.org/#dom-domimplementation-createhtmldocument"><code>createDocument</code></a> method or a <a href="https://html.spec.whatwg.org/multipage/scripting.html#appropriate-template-contents-owner-document">template contents owner document</a>, will fail.</p>

<p>To <dfn id="dfn-create-element">create an element</dfn>, given a <var>document</var>, <var>localName</var>, <var>prefix</var>, <var>namespace</var>, <var>typeExtension</var>, and optional <var>synchronous custom elements flag</var>, run the following steps:</p>

<ol>
    <li>Let <var>registry</var> be the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>'s <a>custom element registry</a>.</li>

    <li>
        <p>If <var>typeExtension</var> is not null:</p>

        <ol>
            <li>If <var>registry</var> is null, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

            <li>If <var>namespace</var> is not the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception and abort these steps.</li>

            <li>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#dfn-element-definition-name">custom element name</a> <var>typeExtension</var>.</li>

            <li>If <var>definition</var>'s <a href="#dfn-element-definition-local-name">local name</a> is not <var>localName</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception and abort these steps.</li>

            <li>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>.</li>

            <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</li>

            <li><a href="https://dom.spec.whatwg.org/#concept-element-attributes-set-value">Set an attribute value</a> for <var>result</var> using "<code>is</code>" and <var>type</var>.</li>

            <li><a>Enqueue a custom element upgrade</a> given <var>result</var>.</li>

            <li>Return <var>result</var>.</li>
        </ol>
    </li>

    <li>
        <p>Otherwise, if <var>registry</var> is not null, <var>namespace</var> is the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, and <var>registry</var> contains an entry with <a href="#dfn-element-definition-local-name">local name</a> <var>localName</var>:</p>

        <ol>
            <li>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#dfn-element-definition-local-name">local name</a> <var>localName</var>.</li>

            <li>
                <p>If <var>synchronous custom elements flag</var> is set:</p>

                <ol>
                    <li>Let <var>C</var> be <var>definition</var>'s <a href="#dfn-element-definition-constructor">constructor</a>.</li>

                    <li>Let <var>result</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>). Rethrow any exceptions.</li>

                    <li>
                        <p>If <var>result</var> does not implement the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception and abort these steps.</p>

                        <p class="note">This is meant to be a brand check to ensure that the object was allocated by the <a href="#dom-htmlelement-constructor"><code>HTMLElement</code></a> constructor. Eventually Web IDL may give us a more precise way to do brand checks.</p>
                    </li>

                    <li>Return <var>result</var>.</li>
                </ol>
            </li>

            <li>
                <p>Otherwise:</p>

                <ol>
                    <li>Let <var>result</var> be a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set <var>document</var>.</li>

                    <li><a>Enqueue a custom element upgrade</a> given <var>result</var>.</li>

                    <li>Return <var>result</var>.</li>
                </ol>
            </li>
        </ol>
    </li>

    <li>
        <p>Otherwise:</p>

        <ol>
            <li>Let <var>interface</var> be the <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>localName</var> and <var>namespace</var>.</li>

            <li>Return a new <a href="https://dom.spec.whatwg.org/#concept-element">element</a> that implements <var>interface</var>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to <var>namespace</var>, <a href="https://dom.spec.whatwg.org/#concept-element-namespace-prefix">namespace prefix</a> set to <var>prefix</var>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>.</li>
        </ol>
    </li>
</ol>

<section id="registry-modifications-to-html">
<h3>Registry-Related Changes to the HTML Standard</h3>

<p>Inside the <a href="https://html.spec.whatwg.org/multipage/browsers.html#initialise-the-document-object">initialization of a new <code>Document</code> object</a> during navigation, set the new <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a> object's <a>custom element registry</a> to a new empty set.</p>

<p>Inside the algorithm for the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#dom-document-open"><code>document.open()</code></a> method, add a step (near step 18, replacing the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s singleton objects) that sets the <a href="https://html.spec.whatwg.org/multipage/dom.html#document"><code>Document</code></a>'s custom element registry to a new empty set.</p>
</section>

<section id="clone-modifications-to-dom">
<h3>Cloning Changes to the DOM Standard</h3>

<p>The <a href="https://dom.spec.whatwg.org/#concept-node-clone">clone a node</a> algorithm will need to be modified as follows. A new case, separate from the main switch, will be needed to generate <var>copy</var> for <code>Element</code>s. It should use <a>create an element</a>, given <var>document</var>, <var>node</var>'s local name, <var>node</var>'s namespace prefix, <var>node</var>'s namespace, and the value of <var>node</var>'s <code>is</code> attribute (if present). The <var>synchronous custom elements flag</var> should be unset.</p>

</section>

</section>

<section id="custom-element-lifecycle">
<h2>Custom Element Lifecycle</h2>

<p>A <a>custom element</a> can go through these changes during its lifetime:</p>
<ul>
    <li><a>Custom element</a> is created before its <a data-lt="custom element definition">definition</a> is <a data-lt="element registration">registered</a></li>
    <li><a data-lt="custom element definition">Definition</a> of a <a>custom element</a> is <a data-lt="element registration">registered</a></li>
    <li><a>Custom element</a> instance is created after its <a data-lt="custom element definition">definition</a> was <a data-lt="element registration">registered</a></li>
    <li><a>Custom element</a> is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#insert-an-element-into-a-document">inserted into active document</a></li>
    <li><a>Custom element</a> is <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#remove-an-element-from-a-document">removed from active document</a></li>
    <li><a>Custom element</a>'s <a href="https://dom.spec.whatwg.org/#concept-attribute">attribute</a> is created, removed, or modified.</li>
</ul>

<p>Various callbacks can be invoked when a <a>custom element</a> goes through some of these changes. These callbacks are stored internally as a <dfn id="dfn-lifecycle-callbacks">collection of lifecycle callbacks</dfn>. They can be looked up by name, which is one of <code>attachedCallback</code>, <code>detachedCallback</code>, or <code>attributeChangedCallback</code>.</p>

<section id="enqueuing-and-invoking-callbacks">
<h3>Enqueuing and Invoking Callbacks</h3>

<p>To facilitate invoking callbacks, each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has a <dfn id="dfn-processing-stack">processing stack</dfn>, which is initially empty. Each item in the stack is an <dfn id="dfn-element-queue">element queue</dfn>, which is initially empty as well. Each item in the <a>element queue</a> is a <a>custom element</a>.</p>

<p><a data-lt="custom element">Custom elements</a> have an associated <dfn id="dfn-callback-queue">custom element action queue</dfn>, initially empty. Each item in the <a>custom element action queue</a> is of one of two types:</p>

<ul>
    <li>An <dfn>upgrade action</dfn>, which will <a href="#dfn-upgrade-a-custom-element">upgrade</a> the custom element and contains a <a>custom element definition</a>; or</li>
    <li>A <dfn>callback action</dfn>, which will call a lifecycle callback, and contains a <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> as well as a list of arguments.</li>
</ul>

<p>To <dfn id="dfn-enqueue-lifecycle-callback">enqueue a custom element callback action</dfn>, given a <a>custom element</a> <var>element</var>, a callback name <var>callbackName</var>, and a list of arguments <var>args</var>, run the following steps:</p>

<ol>
    <li>Let <var>registry</var> be the <a>custom element registry</a> for <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</li>

    <li>Assert: <var>registry</var> is not null.</li>

    <li>
        Let <var>definition</var> be the the entry in <var>registry</var> with entry name equal to <var>element</var>'s <a>custom element name</a>.

        <p class="note">This algorithm can only be called when such a definition exists.</p>
    </li>

    <li>Let <var>callbacks</var> be <var>definition</var>'s <a href="#dfn-element-definition-lifecycle-callbacks">lifecycle callbacks</a>.</li>

    <li>Let <var>callback</var> be callback in <var>callbacks</var> named <var>callbackName</var>. If there is no such callback, abort these steps.</li>

    <li>Add a <a>callback action</a> to <var>element</var>'s <a>custom element action queue</a>, with <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> <var>callback</var> and arguments <var>args</var>.</li>

    <li>If <var>element</var>'s <a>element is being created</a> flag is false, add <var>element</var> to the <a>current element queue</a>.</li>
</ol>

<p>To <dfn id="dfn-enqueue-upgrade">enqueue a custom element upgrade</dfn>, given an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run the following steps:</p>

<ol>
    <li>Let <var>registry</var> be the <a>custom element registry</a> for <var>element</var>'s <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a>.</li>

    <li>Assert: <var>registry</var> is not null.</li>

    <li>
        Let <var>definition</var> be the the entry in <var>registry</var> with entry name equal to <var>element</var>'s <a>custom element name</a>.

        <p class="note">This algorithm can only be called when such a definition exists.</p>
    </li>

    <li>Add an <a>upgrade action</a> to <var>element</var>'s <a>custom element action queue</a>, with <a>custom element definition</a> <var>definition</var>.</li>

    <li>If <var>element</var>'s <a>element is being created</a> flag is false, add <var>element</var> to the <a>current element queue</a>.</li>
</ol>

<p>To <dfn id="dfn-invoke-custom-element-actions">invoke custom element actions</dfn> in an <a>element queue</a> <var>queue</var>, run the following steps:</p>

<ol>
    <li>
        <p>For each <a>custom element</a> <var>element</var> in <var>queue</var>:</p>

        <ol>
            <li>Let <var>actions</var> be <var>element</var>'s <a>custom element action queue</a>.</li>
            <li>
                <p>Repeat until <var>actions</var> is empty:</p>

                <ol>
                    <li>
                        <p>Remove the first element of <var>actions</var>, letting <var>action</var> be the result. Switch on <var>action</var>'s type:</p>

                        <dl class="switch">
                            <dt><a>upgrade action</a></dt>
                            <dd><a href="#dfn-upgrade-a-custom-element">Upgrade</a> <var>element</var> using <var>action</var>'s <a>custom element definition</a>.</dd>

                            <dt><a>callback action</a></dt>
                            <dd><a href="https://heycam.github.io/webidl/#es-invoking-callback-functions">Invoke</a> <var>action</var>'s <a href="https://heycam.github.io/webidl/#idl-callback-function">callback function</a> with <var>action</var>'s arguments, and with <var>element</var> as the <a href="https://heycam.github.io/webidl/#dfn-callback-this-value">callback this value</a>.</dd>
                        </dl>

                        <p>If this throws any exception, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#report-the-exception">report the exception</a>.</p>
                    </li>
                </ol>
            </li>
        </ol>
    </li>
</ol>

<p>Any time a script calls a method, reads or sets a property that is implemented by the user agent, the following actions MUST occur:</p>
<ul>
    <li>When transitioning from script to the user agent code, push a new <a>element queue</a> to the <a>processing stack</a></li>
    <li>When transitioning back from the user agent code to script, pop the <a>element queue</a> from the <a>processing stack</a> and <a>invoke custom element actions</a> in that queue.</li>
</ul>

<p class="warning">This needs to become more precise. Find all platform APIs that can create elements? Or invent a new algorithm for creating elements and make sure everyone calls it?</p>

<div class="note">As described, these actions wrap every user agent-implemented method or property accessor. The intended effect is that any lifecycle callbacks, enqueued as a result of running these methods or accessors are invoked prior to returning control back to script. If a method or accessor is known to never enqueue a custom element action, the user agent could choose not to wrap it as a performance optimization.</div>

<p><a data-lt="custom element">Custom elements</a> have an associated <dfn id="dfn-element-is-being-created-flag">element is being created</dfn> flag, initially false.</p>

<p>In addition to an <a>element queue</a>, there is also a <dfn id="dfn-sorted-element-queue">sorted element queue</dfn>. The <a data-lt='custom element'>custom elements</a> are kept in the order of increasing <a>custom element order</a>.</p>

<p>The <dfn id="dfn-custom-element-order">custom element order</dfn> is a numerical value, associated with every <a>custom element</a>. This value is assigned as a result of <a>custom element</a>'s <a href="https://dom.spec.whatwg.org/#concept-document">document</a> keeping a numerical value that is incremented and assigned to <a>custom element</a> as its <a>custom element order</a> whenever the following occurs:</p>
<ul>
    <li>A <a>custom element</a> is popped from the <a href="https://html.spec.whatwg.org/multipage/syntax.html#stack-of-open-elements">stack of open elements</a></li>
    <li>A <a>custom element</a> is created with means other than a parser</li>
</ul>

<p>Each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> has an initially-empty <a>sorted element queue</a>, called <dfn id="dfn-base-element-queue">base element queue</dfn>.</p>

<p>Whenever a <a>base element queue</a> becomes non-empty, the user agent MUST <a href="https://html.spec.whatwg.org/#queue-a-microtask">queue a microtask</a> to <a>process base element queue</a> for the <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> to which the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-browsing-context">scripts' browsing context</a> belongs.</p>

<p>To prevent reentrance while <a data-lt="process base element queue">processing base element queue</a>, each <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin contexts</a> has a <dfn id="dfn-processing-base-element-queue">processing base element queue</dfn> flag, which MUST initially be <strong>false</strong>.</p>

<p>To <dfn id="dfn-process-base-element-queue">process base element queue</dfn>, a conforming user agent MUST run the following steps or their <a data-lt="processing equivalence">equivalent</a>:</p>

<div class="algorithm">
<dl>
<dt>Input</dt>
    <dd><var>ENVIRONMENT</var>, the <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a></dd>
<dt>Output</dt>
    <dd>None</dd>
</dl>
<ol class='algorithm'>
    <li>Let <var>PROCESSING</var> be the <a data-lt="process base element queue">processing base element queue</a> flag</li>
    <li>If <var>PROCESSING</var> is <strong>true</strong>, <strong>stop</strong>.</li>
    <li>Set <var>PROCESSING</var> to <strong>true</strong>.</li>
    <li><a>Invoke custom element actions</a> in <var>ENVIRONMENT</var>'s <a>base element queue</a></li>
    <li>Set <var>PROCESSING</var> to <strong>false</strong>.</li>
</ol>
</div>

<p>In the <a href="https://html.spec.whatwg.org/multipage/browsers.html#unit-of-related-similar-origin-browsing-contexts">unit of related similar-origin browsing contexts</a> to which the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-browsing-context">scripts' browsing context</a> belongs, the <dfn id="dfn-current-element-queue">current element queue</dfn> is the <a>element queue</a> at the top of the <a>processing stack</a> or the <a>base element queue</a> if the <a>processing stack</a> is empty.</p>

</section>
<section id="types-of-callbacks">
<h3>Changes to DOM's Mutation Algorithms</h3>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-node-insert">insert</a> algorithm as follows. Replace step 6.2 with:</p>

<ol start="2">
    <li>
        <p>For each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, run these subsubsteps:</p>

        <ol>
            <li>Run the <a href="https://dom.spec.whatwg.org/#concept-node-insert-ext">insertion steps</a> with <var>inclusiveDescendant</var> and <var>parent</var>.</li>

            <li>If <var>inclusiveDescendant</var> is a <a>custom element</a>, and was previously not <a href="http://w3c.github.io/webcomponents/spec/shadow/#dfn-in-a-composed-document">in a composed document</a>, but now is, <a>enqueue a custom element callback action</a> with <var>inclusiveDescendant</var>, callback name "<code>connectedCallback</code>", and an empty argument list.</li>
        </ol>
    </li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-node-remove">remove</a> algorithm as follows. Replace step 9 with:</p>

<ol start="9">
    <li>
        <p>For each <a href="https://dom.spec.whatwg.org/#concept-tree-inclusive-descendant">inclusive descendant</a> <var>inclusiveDescendant</var> of <var>node</var>, in <a href="https://dom.spec.whatwg.org/#concept-tree-order">tree order</a>, run these substeps:</p>

        <ol>
            <li>Run the <a href="https://dom.spec.whatwg.org/#concept-node-remove-ext">removing steps</a> with <var>inclusiveDescendant</var> and <var>parent</var>.</li>

            <li>If <var>inclusiveDescendant</var> is a <a>custom element</a>, and was previously <a href="http://w3c.github.io/webcomponents/spec/shadow/#dfn-in-a-composed-document">in a composed document</a>, but now is not, <a>enqueue a custom element callback action</a> with <var>inclusiveDescendant</var>, callback name "<code>disconnectedCallback</code>", and an empty argument list.</li>
        </ol>
    </li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-change">change an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is a <a>custom element</a>, <a>enqueue a custom element callback action</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>value</var>, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-append">append an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is a <a>custom element</a>, <a>enqueue a custom element callback action</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, null, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-remove">remove an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is a <a>custom element</a>, <a>enqueue a custom element callback action</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, null, and <var>attribute</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

<p>Modify the <a href="https://dom.spec.whatwg.org/#concept-element-attributes-replace">replace an attribute</a> algorithm as follows. Add an additional step after step 1:</p>

<ol start="2">
    <li>If <var>element</var> is a <a>custom element</a>, <a>enqueue a custom element callback action</a> with <var>element</var>, callback name "<code>attributeChangedCallback</code>", and an argument list containing <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-local-name">local name</a>, <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, <var>newAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-value">value</a>, and <var>oldAttr</var>'s <a href="https://dom.spec.whatwg.org/#concept-attribute-namespace">namespace</a>.</li>
</ol>

</section>
</section>

</section>
<section id="registering-custom-elements">
<h2>Registering Custom Elements</h2>

<p><dfn id="dfn-element-registration">Element registration</dfn> is a process of adding an <a>custom element definition</a> to a <a>custom element registry</a>.</p>

<p>Because <a>element registration</a> can occur at any time, a <a>custom element</a> could be created before its <a data-lt="custom element definition">definition</a> is <a data-lt="element registration">registered</a>. Such <a>custom element</a> instances are called <dfn id="dfn-unresolved-element" data-lt='unresolved element'>unresolved elements</dfn>. When an <a>unresolved element</a> is created, <em>and</em> if its  <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> was not defined by <a href="https://html.spec.whatwg.org/multipage/">HTML</a> or <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#other-applicable-specifications">other applicable specifications</a>, the <a>unresolved element</a>'s <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> MUST be <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>.</p>

<div class="note">
The effect of this statement is that any HTML element with a local name that is a valid <a>custom element name</a> will have <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> as its element interface, rather than <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlunknownelement"><code>HTMLUnknownElement</code></a>.
</div>

<p>Each <a>custom element registry</a> has an associated <dfn id="dfn-upgrade-candidates-map">upgrade candidates map</dfn> of all instances of <a data-lt="unresolved element">unresolved elements</a>, mapping a <a>custom element name</a> to a <a>sorted element queue</a>. It is is initially empty.</p>

<p>Whenever an <a>unresolved element</a> is created, it MUST be added to the respective <a>sorted element queue</a> in <a>upgrade candidates map</a>.</p>

<p>Elements are upgraded from being unresolved by the <a>upgrade a newly-defined element</a> algorithm.</p>

<section id="extensions-to-document-interface-to-register">
<h3>New <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a> Method</h3>

<p>The <a href="#dom-document-defineelement"><code>defineElement</code></a> method of the <a href="https://dom.spec.whatwg.org/#document">Document</a> interface provides a way to <a data-lt="element registration">register</a> a <a>custom element</a>.</p>

<pre class='idl'>
partial interface Document {
    void defineElement(DOMString name, Function constructor, optional ElementRegistrationOptions options);
};

dictionary ElementRegistrationOptions {
     DOMString? extends = null;
};
</pre>

<p>The <dfn id="dom-document-defineelement"><code>defineElement(<var>name</var>, <var>constructor</var>, <var>options</var>)</code></dfn> method, when invoked, must run these steps:</p>

<ol>
    <li>If <a href="https://tc39.github.io/ecma262/#sec-isconstructor">IsConstructor</a>(<var>constructor</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> and abort these steps.</li>

    <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>name</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

    <li>If <var>name</var> is an invalid <a>custom element name</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>SyntaxError</code> and abort these steps.</li>

    <li>Let <var>registry</var> be the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>'s <a>custom element registry</a>. If <var>registry</var> is null, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

    <li>If <var>registry</var> contains an entry with <a href="#dfn-element-definition-name">name</a> <var>name</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

    <li>If <var>registry</var> contains an entry with <a href="#dfn-element-definition-constructor">contructor</a> <var>constructor</var>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

    <li>Let <var>localName</var> be <var>name</var>.</li>

    <li>Let <var>extends</var> be the value of the <code>extends</code> member of <var>options</var>.</li>

    <li>
        <p>If <var>extends</var> is not null:</p>

        <ol>
            <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>extends</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

            <li>If there is no <a href="https://dom.spec.whatwg.org/#concept-element-interface">element interface</a> for <var>extends</var> and the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>NotSupportedError</code> and abort these steps.</li>

            <li>Set <var>localName</var> to <var>extends</var>.</li>
        </ol>
    </li>

    <li>Let <var>prototype</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>constructor</var>, "prototype"). Rethrow any exceptions.</li>

    <li>If <a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a>(<var>prototype</var>) is not Object, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> exception.</li>

    <li>Let <var>attachedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "attachedCallback"). Rethrow any exceptions.</li>

    <li>Let <var>detachedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "detachedCallback"). Rethrow any exceptions.</li>

    <li>Let <var>attributeChangedCallback</var> be <a href="https://tc39.github.io/ecma262/#sec-get-o-p">Get</a>(<var>prototype</var>, "attributeChangedCallback"). Rethrow any exceptions.</li>

    <li>Let <var>definition</var> be a new <a>custom element definition</a> with <a href="#dfn-element-definition-name">custom element name</a> <var>name</var>, <a href="#dfn-element-definition-local-name">local name</a> <var>localName</var>, <a href="#dfn-element-definition-constructor">constructor</a> <var>constructor</var>, <a href="#dfn-element-definition-prototype">prototype</a> <var>prototype</var>, and <a href="#dfn-element-definition-lifecycle-callbacks">lifecycle callbacks</a> <var>attachedCallback</var>, <var>detachedCallback</var>, and <var>attributeChangedCallback</var>.</li>

    <li>Add <var>definition</var> to <var>registry</var>.</li>

    <li>Let <var>map</var> be <var>registry</var>'s <a>upgrade candidates map</a>.</li>

    <li><a>Upgrade a newly-defined element</a> given <var>map</var> and <var>definition</var>.</li>
</ol>

<div class="example">
    <p>A simple example of registering a custom element using [[!ECMASCRIPT]] <code>class</code> syntax:</p>

    <pre class="highlight">
    document.defineElement("x-foo", class XFoo extends HTMLElement {
        constructor() {
            super(); // this is mandatory

            this._initialData = "foo";
        }
    });</pre>

    <p>An example of registering an element that uses a type extension:</p>

    <pre class="highlight">
    document.defineElement("x-bar", class XBar extends HTMLParagraphElement {
        constructor() {
            super(); // still mandatory

            this._initialData = "bar";
        }
    }, { extends: "p" });</pre>

    <p>This latter example does not introduce a new tag (like the <a>custom tag</a> elements do), but rather extends an existing element of type <a href="https://html.spec.whatwg.org/multipage/#htmlparagraphelement"><code>HTMLParagraphElement</code></a>. Here's how one could instantiate this element:</p>

    <pre class="highlight">
    &lt;p is="x-foo"&gt;Paragraph of amazement&lt;/p&gt;</pre>

    Or imperatively, in JavaScript:

    <pre class="highlight">
    var foo = document.createElement("p", { is: "x-foo" });</pre>
</div>

</section>
<section id="unresolved-element-pseudoclass">
<h3><code>:unresolved</code> Element Pseudo-class</h3>

<p>The <code>:unresolved</code> <a href="https://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class</a> [[!CSS3-SELECTORS]] MUST match all <a data-lt="custom element">custom elements</a> whose <a>custom element constructor</a> has not yet been invoked.</p>

<div class="note">
<p>The <code>:unresolved</code> <a href="https://www.w3.org/TR/css3-selectors/#pseudo-classes">pseudo-class</a> could be used to mitigate the flash of unstyled content [[FOUC]] issues with <a data-lt="custom element">custom elements</a>.
</div>
</section>
</section>
<section id="instantiating-custom-elements">
<h2>Instantiating Custom Elements</h2>

<p>The <a>custom element name</a> is given to a <a>custom element</a> at the time of its instantiation in one of the two ways:</p>
<ol>
    <li>As the <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> of the <a>custom element</a>. These types of <a data-lt="custom element name">custom element names</a> are called <dfn id="dfn-custom-tag" data-lt='custom tag'>custom tags</dfn>.</li>
    <li>As the value of the <code>is</code> <a href="https://dom.spec.whatwg.org/#concept-named-attribute">attribute</a> of the <a>custom element</a>. <a data-lt="custom element name">Custom element names</a> given this way are called <dfn id="dfn-type-extension" data-lt='type extension'>type extensions</dfn>.</li>
</ol>

<p>After a <a>custom element</a> is instantiated, changing the value of the <code>is</code> <a href="https://dom.spec.whatwg.org/#concept-named-attribute">attribute</a> MUST NOT affect this element's <a>custom element name</a>.</p>

<p>If both types of <a data-lt="custom element name">custom element names</a> are provided at the time of element's instantiation, the <a>custom tag</a> MUST win over the <a>type extension</a>.

<section id="htmlelement-constructor">
<h3>The <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> Constructor</h3>

The <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> interface gains following annotation:

<pre>
[Constructor]
</pre>

The <dfn id="dom-htmlelement-constructor"><code>HTMLElement</code> constructor</dfn>, when invoked, must perform the following steps:

<ol>
    <li>Let <var>realm</var> be the result of <a href="https://tc39.github.io/ecma262/#sec-getfunctionrealm">GetFunctionRealm</a>(the currently executing <code>HTMLElement</code> function).</li>
    <li>Let <var>document</var> be the <a href="https://html.spec.whatwg.org/multipage/#concept-document-window">associated document</a> of <var>realm</var>'s [[\GlobalObject]].</li>

    <li>Let <var>registry</var> be <var>document</var>'s <a>custom element registry</a>. If <var>registry</var> is null, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> and abort these steps.</li>

    <li>Let <var>definition</var> be the entry in <var>registry</var> with <a href="#dfn-element-definition-constructor">constructor</a> equal to NewTarget. If there is no such definition, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>TypeError</code> and abort these steps.</li>

    <li>
        <p>If <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a> is empty, perform the following substeps:</p>

        <ol>
            <li>Let <var>localName</var> be the <var>definition</var>'s <a href="#dfn-element-definition-local-name">local name</a>.</li>

            <li>Return a new element that implements <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a>, with no attributes, <a href="https://dom.spec.whatwg.org/#concept-element-namespace">namespace</a> set to the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <a href="https://dom.spec.whatwg.org/#concept-element-local-name">local name</a> set to <var>localName</var>, and <a href="https://dom.spec.whatwg.org/#concept-node-document">node document</a> set to <var>document</var>.</li>
        </ol>

        <p class="note">This occurs when author script constructs a new custom element directly, e.g. via <code>new MyCustomElement()</code>.</p>
    </li>

    <li>Let <var>instance</var> be the last entry in <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>
        <p>If <var>instance</var> is an <a><i>already constructed</i></a> marker, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> an <code>InvalidStateError</code> and abort these steps.</p>

        <p class="note">This can occur when the author code inside the <a>custom element constructor</a> invokes <code>super()</code> multiple times.</p>
    </li>

    <li>Let <var>prototype</var> be <var>definition</var>'s <a href="#dfn-element-definition-prototype">prototype</a>.</li>

    <li>Perform <var>element</var>.[[\SetPrototypeOf]](<var>prototype</var>). Rethrow any exceptions.</li>

    <li>Replace the last entry in <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>a with an <a><i>already constructed</i></a> marker.</li>

    <li>
        <p>Return <var>instance</var>.</p>

        <p class="note">This step is normally reached when <a href="#dfn-upgrade-a-custom-element">upgrading</a> a custom element; the existing element is returned, so that the <code>super()</code> call inside the <a>custom element constructor</a> assigns that existing element to <code>this</code>.</p>
    </li>
</ol>

<p class="note">For now, the <a href="https://html.spec.whatwg.org/multipage/dom.html#htmlelement"><code>HTMLElement</code></a> constructor cannot be invoked directly. It only works when used via a <code>super()</code> call inside a <a>custom element constructor</a>.</p>

</section>

<section id="extensions-to-document-interface-to-instantiate">
<h3>Changes to <a href="https://dom.spec.whatwg.org/#document"><code>Document</code></a> Methods</h3>

<p>To allow creating both <a>custom tag</a> and <a>type extension</a>-style <a data-lt="custom element">custom elements</a>, the <a href="https://dom.spec.whatwg.org/#dom-document-createelement"><code>createElement</code></a> or <a href="https://dom.spec.whatwg.org/#dom-document-createelementns"><codE>createElementNS</code></a> methods gain optional <var>typeExtension</var> arguments. Their new definitions are:</p>

<pre class='idl'>
partial interface Document {
    Element createElement(DOMString localName, optional ElementCreationOptions options);
    Element createElementNS(DOMString? namespace, DOMString qualifiedName, optional ElementCreationOptions options);
};

dictionary ElementCreationOptions {
    DOMString? is = null;
};
</pre>

<div id="monkeypatch-create-element">

The <dfn id="dom-document-createelement"><code>createElement(localName, options)</code></dfn> method, when invoked, must run these steps:

<ol>
    <li>If <var>localName</var> does not match the <a href="https://www.w3.org/TR/xml/#NT-Name"><code>Name</code></a> production, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> an <code>InvalidCharacterError</code> exception.</li>

    <li>If the <a href="https://dom.spec.whatwg.org/#context-object">context object</a> is an <a href="https://dom.spec.whatwg.org/#html-document">HTML document</a>, let <var>localName</var> be <a href="https://dom.spec.whatwg.org/#converted-to-ascii-lowercase">converted to ASCII lowercase</a>.</li>

    <li>Let <var>typeExtension</var> be the value of the <code>is</code> member of <var>options</var>.</li>

    <li>Return the result of <a data-lt="create an element">creating an element</a> given the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>, <var>localName</var>, null, the <a href="https://dom.spec.whatwg.org/#html-namespace">HTML namespace</a>, <var>typeExtension</var>, and with the <var>synchronous custom elements flag</var> set. Rethrow any exceptions.</li>
</ol>

The <dfn id="dom-document-createelementns"><code>createElementNS(namespace, qualifiedName, options)</code></dfn> method, when invoked, must run these steps:

<ol>
    <li>Let <var>namespace</var>, <var>prefix</var>, and <var>localName</var> be the result of passing <var>namespace</var> and <var>qualifiedName</var> to <a href="https://dom.spec.whatwg.org/#validate-and-extract">validate and extract</a>. Rethrow any exceptions.</li>

    <li>Let <var>typeExtension</var> be the value of the <code>is</code> member of <var>options</var>.</li>

    <li>Return the result of <a data-lt="create an element">creating an element</a> given the <a href="https://dom.spec.whatwg.org/#context-object">context object</a>, <var>localName</var>, <var>prefix</var>, <var>namespace</var>, <var>typeExtension</var>, and with the <var>synchronous custom elements flag</var> set. Rethrow any exceptions.</li>
</ol>

</div>

</section>

<section id="parsing">
<h3>Changes to the HTML Parser</h3>

<p class="warning">This section needs a lot more detail added on how exactly it is going to patch [[HTML]], in order to execute script during parsing.</p>

<p>To enable instantiating <a data-lt="custom element">custom elements</a> during <a href="https://html.spec.whatwg.org/multipage/syntax.html#tree-construction">tree construction</a>, whenever <a href="https://html.spec.whatwg.org/multipage/syntax.html#create-an-element-for-the-token">creating</a> a <a>custom element</a>, the user agent must pause (similar to when parsing <code>&lt;script&gt;</code>) and run <a>create an element</a> with the appropriate argument, including with the <var>synchronous custom elements flag</var> set.</p>

<p>For each attribute in the given token, the parser must <a>enqueue a custom element callback action</a> given the new node, "<code>attributeChangedCallback</code>", and an argument list containing the attribute's local name, null, the attribute's value, and the attribute's namespace.</p>

<div class="note">
<p>This modification to <a href="https://html.spec.whatwg.org/multipage/syntax.html#tree-construction">tree construction</a> has the consequence of <a data-lt="custom element">custom elements</a> being created when <a href="https://html.spec.whatwg.org/multipage/syntax.html#parsing">parsing HTML documents</a> or <a href="https://html.spec.whatwg.org/multipage/syntax.html#html-fragment-parsing-algorithm">fragments</a>. Probably we need to tweak this a bit so that fragment parsing is done differently (with upgrade semantics).</p>
</div>
</section>

<section id="upgrading">
<h3>Upgrading</h3>

<p>To <dfn id="dfn-element-upgrade-algorithm">upgrade a newly-defined element</dfn>, given a <a>custom element definition</a> <var>definition</var> and an <a>upgrade candidates map</a> <var>map</var>, perform the following steps:</p>

<ol>
    <li>Let <var>name</var> be <var>definition</var>'s <a href="#dfn-element-definition-name">custom element name</a>.</li>

    <li>Let <var>candidates</var> be the <a>sorted element queue</a> which is the value of the entry in <var>map</var> with key <var>name</var>.</li>

    <li>For each element <var>candidate</var> in <var>candidates</var>, <a>enqueue a custom element upgrade</a> for <var>candidate</var>.</li>

    <li>Set the value of the entry in <var>map</var> whose key is <var>name</var> to an empty <a>sorted element queue</a>.</li>
</ol>

<p>To <dfn id="dfn-upgrade-a-custom-element">upgrade a custom element</dfn>, given as input a <a>custom element definition</a> <var>definition</var> and an <a href="https://dom.spec.whatwg.org/#concept-element">element</a> <var>element</var>, run the following steps:</p>

<ol>
    <li>Add <var>element</var> to the end of <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>Let <var>C</var> be <var>definition</var>'s <a href="#dfn-element-definition-constructor">constructor</a>.</li>

    <li>Let <var>constructResult</var> be <a href="https://tc39.github.io/ecma262/#sec-construct">Construct</a>(<var>C</var>).</li>

    <li>Remove <var>element</var> from the end of <var>definition</var>'s <a href="#dfn-element-definition-construction-stack">construction stack</a>.</li>

    <li>If <var>constructResult</var> is an abrupt completion, return <var>constructResult</var> (i.e., re-throw the exception).</li>

    <li>
        <p>If <a href="https://tc39.github.io/ecma262/#sec-samevalue">SameValue</a>(<var>constructResult</var>.[[\value]], <var>element</var>) is false, <a href="https://heycam.github.io/webidl/#dfn-throw">throw</a> a <code>InvalidStateError</code> and terminate these steps.</p>

        <p class="note">This can occur if <var>C</var> constructs another instance of the same custom element before calling <code>super()</code>, or if <var>C</var> uses JavaScript's <code>return</code>-override feature to return an arbitrary object from the constructor.</p>
    </li>
</ol>

</section>

<section>
<h3>Changes to Cloning</h3>

The following informational note should be added to the <a href="https://dom.spec.whatwg.org/#concept-node-clone">clone</a> algorithm's section on cloning elements:

<p class="note">Custom elements will be <a data-lt="upgrade a custom element">upgraded</a> when the calling operation finishes and <a data-lt="invoke custom element actions">invokes custom element actions</a>.</p>

</section>
</section>

<section id="semantics">
<h2>Custom Element Semantics</h2>
<p>The default <a href="https://www.w3.org/TR/html/dom.html#semantics-0">semantics</a> of a <a>custom element</a> is dependent upon the form in which it is instantiated:</p>
<ul>
  <li>by default a <a>custom tag</a> has no special meaning at all. It <a href="https://www.w3.org/TR/html/dom.html#represents">represents</a> its children.</li>
  <li>by default a <a>type extension</a> inherits the semantics of the element type it extends.</li>
  </ul>
<section id="custom-tag-example" class='informative'>
<h3>Custom Tag Example</h3>
<p>For example, a custom tag could be named <em>taco-button</em>, but the name alone does not express the semantics of a HTML <a href="https://www.w3.org/TR/html/forms.html#the-button-element"><code>button</code></a> element simply due to its name. As instantiated a custom tag conveys a similar amount of semantics as an HTML <a href="https://www.w3.org/TR/html/grouping-content.html#the-div-element"><code>div</code></a> or <code><a href="https://www.w3.org/TR/html/text-level-semantics.html#the-span-element">span</a></code> element:</p>
<pre class='highlight'>&lt;!-- taco-button represents a span with a fancy name -->
&lt;taco-button&gt;&lt;/taco-button&gt;
</pre>
<p> The addition of visual styling and scripted events to the <em>taco-button</em> could provide hints as to its semantics and expected interaction behaviours — for some users — but for the semantics to be formally expressed developers must convey the semantics  using ARIA <a href="https://w3c.github.io/aria/aria/aria.html#usage_intro">roles</a>, <a href="https://w3c.github.io/aria/aria/aria.html#introstates">states and properties</a>.</p>

<p>The addition of a <code><a href="https://www.w3.org/TR/html/editing.html#attr-tabindex">tabindex</a></code> attribute to the custom element  provides interaction (the element is included in the focus order) and property/state semantics (it exposes information that it is focusable and if it currently has focus).</p>
<pre class='highlight'>
&lt;!-- taco-button represents a focusable span with a fancy name -->
&lt;taco-button <mark>tabindex=&quot;0&quot;</mark>&gt;Eat Me&lt;/taco-button&gt;
</pre>
<p>The addition of a  label, using <a href="https://w3c.github.io/aria/aria/aria.html#aria-label"><code>aria-label</code></a>, to the custom element  provides an <a href="https://www.w3.org/TR/wai-aria-1.1/#dfn-accessible-name">Accessible Name</a> for the element.</p>
<pre class='highlight'>
&lt;!-- taco-button represents a focusable span with a fancy name and a text label -->
&lt;taco-button tabindex=&quot;0&quot; <mark>aria-label=&quot;Eat Me&quot;</mark>&gt;Eat Me&lt;/taco-button&gt;
</pre>
<p>The addition of  keyboard event handlers to the custom element provides the means for keyboard users to operate the control, but does not convey the presence of the functionality. </p>

<pre class="highlight">
&lt;!-- taco-button represents focusable span with a fancy name,
    a text label and button like event handling -->
&lt;taco-button tabindex=&quot;0&quot; <mark>onclick=&quot;alert('tasty eh?');&quot;</mark>
<mark>onkeypress=&quot;if(event.keyCode==32||event.keyCode==13){alert('tasty eh?');};&quot;</mark>
&gt;Eat Me&lt;/taco-button&gt;
</pre>
<p class="note">The addition of inline event handlers are for demonstration purposes only. The event handlers could be added by the lifecycle callbacks imperatively, or maybe even not used at all. This example demonstrates <em>one</em> method for developers to ensure that a custom control is operable for keyboard users and meets the <a href="https://www.w3.org/TR/WCAG20/#keyboard-operation-keyboard-operable">WCAG 2.0</a> [[WCAG20]] criteria &quot;All functionality of the content is operable through a keyboard interface&quot;.</p>
<p>The addition of  an ARIA <a href="http://rawgit.com/w3c/aria/master/aria/aria.html#button"><code>role="button"</code></a> conveys the custom element's role semantics, which enables users to successfully interact with the control using the expected <code>button</code> interaction behaviours (pressing the <kbd>space</kbd> or <code>enter</code> keys to activate).</p>
<pre class="highlight">
&lt;!-- taco-button represents a focusable button with a text label
    and button like event handling -->
&lt;taco-button <mark>role=&quot;button&quot;</mark> tabindex=&quot;0&quot; onclick=&quot;alert('tasty eh?');&quot;
onkeypress=&quot;if(event.keyCode==32||event.keyCode==13){alert('tasty eh?');};&quot;
&gt;Eat Me&lt;/taco-button&gt;</pre>
<p>The developer may provide a disabled state for the custom element. This could be implemented by removing the <code>tabindex</code> attribute so the element is no longer included in the focus order and removing the functionality so that interacting with the element does nothing. Also the visual styling may also be modified to visually indicate it the element is disabled.</p>
<pre class="highlight">
&lt;!-- grayed out non focusable taco-button with functionality removed,
     to indicate the button is in a disabled state  -->
&lt;taco-button role=&quot;button&quot; <mark><del>tabindex=&quot;0&quot;</del></mark> <mark><del>onclick=&quot;alert('tasty eh?');&quot;</del></mark>
<mark><del>onkeypress=&quot;if(event.keyCode==32||event.keyCode==13){alert('tasty eh?');};&quot;</del></mark>
&gt;Eat Me&lt;/taco-button&gt;</pre>
<p>Removing the focusability and functionality of the custom element and modifying its style does not unambiguously express that it is in a disabled state. To unambiguously express the disabled state add <code><a href="https://www.w3.org/TR/wai-aria/states_and_properties#aria-disabled">aria-disabled=&quot;true&quot;</a></code>.</p>
<p class="note">A <a href="https://www.w3.org/TR/html/forms.html#attr-fe-disabled"><code>disabled</code></a> attribute would not work here as the custom tag is not based on an HTML element that supports its use.</p>
<pre class="highlight">
&lt;!-- taco-button represents a focusable button with a text label
       and button like event handling -->
&lt;taco-button role=&quot;button&quot; <mark><del>tabindex=&quot;0&quot;</del></mark> <mark><del>onclick=&quot;alert('tasty eh?');&quot;</del></mark>
  <mark><del>onkeypress=&quot;if(event.keyCode==32||event.keyCode==13){alert('tasty eh?');};&quot;</del></mark>
  <mark>aria-disabled="true"</mark>&gt;Eat Me&lt;/taco-button&gt;</pre>
</section>
<section id="type-extension-example" class='informative'>
<h3>Type Extension Example</h3>
<p> A type extension, for example could extend the HTML  <a href="https://www.w3.org/TR/html/forms.html#the-button-element"><code>button</code></a> element. As instantiated it would inherit the <code>button</code> element's name, role, states and properties, built in focus and keyboard interaction behaviours. </p>
<pre class="highlight">&lt;!-- tequila-button represents a button with an accessible name of &quot;Drink Me!&quot; -->
&lt;button <mark>is=&quot;tequila-button&quot;</mark>&gt;Drink Me!&lt;/button&gt;
</pre>
<p>To implement the desired <em>tequila-button</em> feature, all that is required is the addition of an event handler. The rest of the semantics and interaction behaviour are provided by the browser as part of its implementation of the <a href="https://www.w3.org/TR/html/forms.html#the-button-element"><code>button</code></a> element.</p>
<pre class="highlight">&lt;!-- tequila-button represents a button -->
&lt;button is=&quot;tequila-button&quot; <mark>onclick=&quot;alert('smooth!');&quot;</mark>&gt;Drink Me!&lt;/button&gt;
</pre>
<p>To implement the disabled state on the <em>tequila-button</em>, all that is required is the addition of the HTML <a href="https://www.w3.org/TR/html/forms.html#attr-fe-disabled"><code>disabled</code></a> attribute. The semantics, style and interaction behaviour are implemented by the browser.</p>
<pre class="highlight">&lt;!-- tequila-button represents a button -->
&lt;button is=&quot;tequila-button&quot; onclick=&quot;alert('smooth!');&quot; <mark>disabled</mark>&gt;Drink Me!&lt;/button&gt;
</pre>
</section>
<section id="dev-advice">
<h3>Custom Element Semantics — Conclusion</h3>
<p> The simplest and most robust method to create custom elements that are usable and accessible is to implement custom elements as <a data-lt="type extension">type extensions</a>. This method provides a custom element with built in semantics and interaction behaviours that developers can use as a foundation.</p>
<p>Use <a href="https://w3c.github.io/aria/aria/aria.html">ARIA</a> [[WAI-ARIA-1.1]], where needed, to provide semantics for custom elements and follow the <a href="https://www.w3.org/TR/wai-aria-practices/#aria_ex">ARIA  Design Patterns</a> [[WAI-ARIA-PRACTICES]] when implementing ARIA attributes and UI interaction behaviours. Ensure that custom tag or type extension custom elements meet the criteria listed in the <a href="https://w3c.github.io/aria-in-html/#checklist">Custom Control Accessible Development Checklist</a> [[ARIA-IN-HTML]]. Use ARIA in accordance with the <a href="https://specs.webplatform.org/html-aria/webspecs/master/#docconformance">Document conformance requirements for use of ARIA attributes in HTML</a>.</p>
<h4 id="dev-reading">Further Reading for Developers</h4>
<ul>
  <li><a href="https://www.w3.org/WAI/PF/aria-practices/">WAI-ARIA 1.0 Authoring Practices</a></li>
  <li><a href="https://w3c.github.io/aria-in-html/">Notes on Using ARIA in HTML</a></li>
</ul>
</section>
</section>
<section id="appendix-a" class='appendix informative'>

<h2>Acknowledgments</h2>

<p><span class="vcard">David Hyatt</span> developed <a href="http://dev.w3.org/2006/xbl2/">XBL 1.0</a>, and <span class="vcard">Ian Hickson</span> co-wrote <a href="http://dev.w3.org/2006/xbl2/">XBL 2.0</a>. These documents provided tremendous insight into the problem of behavior attachment and greatly influenced this specification.</p>

<p><span class="vcard">Alex Russell</span> and his considerable forethought triggered a new wave of enthusiasm around the subject of behavior attachment and how it can be applied practically on the Web.</p>

<p><span class="vcard">Dominic Cooney</span>, <span class="vcard">Hajime Morrita</span>, and <span class="vcard">Roland Steiner</span> worked tirelessly to scope the problem within the confines of the Web platform and provided a solid foundation for this document.</p>
<p><a href="mailto:sfaulkner@paciellogroup.com">Steve Faulkner</a>, The Paciello Group, for writing the content of the section <a href="#semantics"></a>.</p>

<p>The editor would also like to thank <span class="vcard">Alex Komoroske</span>, <span class="vcard">Anne van Kesteren</span>, <span class="vcard">Boris Zbarsky</span>, <span class="vcard">Daniel Buchner</span>, <span class="vcard">Edward O'Connor</span>, <span class="vcard">Erik Arvidsson</span>, <span class="vcard">Elliott Sprehn</span>, <span class="vcard">Hayato Ito</span>, <span class="vcard">Jonas Sicking</span>, <span class="vcard">Olli Pettay</span>, <span class="vcard">Rafael Weinstein</span>, <span class="vcard">Scott Miles</span>, <span class="vcard">Simon Pieters</span>, <span class="vcard">Steve Orvell</span>, <span class="vcard">Tab Atkins</span>, and <span class="vcard">William Chen</span> for their comments and contributions to this specification.</p>

<p>This list is too short. There's a lot of work left to do. Please contribute by reviewing and filing bugs&mdash;and don't forget to ask the editor to add your name into this section.</p>

</body>
</html>
